<?php $stopwatch=microtime(); define('IGNORE_VERSION_MISMATCH',false); define('E2_VERSION',2970); define('E2_RELEASE','2.5'); define('E2_EDITION',0); define('E2_UA_STRING','E2 (v'. E2_VERSION .'; Aegea)'); header('X-Powered-By: E2 Aegea v'. E2_VERSION); define('OUTPUT_CHARSET','UTF-8'); setlocale(LC_CTYPE,'ru_RU.UTF'); mb_internal_encoding('UTF-8'); define('HSC_ENC','UTF-8'); if(function_exists('date_default_timezone_set'))date_default_timezone_set('GMT'); error_reporting(E_ALL); define('RUN_ID',chr(rand(65,90))); define('DEV_TRACK_TIME',false); define('DEV_HOST','e2'); define('E2_WEBSITE_HOST','blogengine.ru'); define('E2_WEBSITE','http://'. E2_WEBSITE_HOST .'/'); define('SECONDS_IN_A_MINUTE',60); define('SECONDS_IN_AN_HOUR',3600); define('SECONDS_IN_A_DAY',86400); define('SECONDS_IN_A_MONTH',2592000); define('SECONDS_IN_A_YEAR',31536000); define('YEAR_DISPLAY_THRESH',7884000); define('KILO_THRESH',768); define('BYTES_DECIMALS',1); define('FILE_READ_BUFFER',64*1024); define('KEYWORDS_MANY_THRESH',50); define('SCALE_FACTOR_THRESH',0.75); define('NEW_FILES_RIGHTS',0777); if (!empty ($_SERVER['HTTPS']) && $_SERVER['HTTPS']!=='off' || $_SERVER['SERVER_PORT']==443){ $_protocol='https'; $d08054=443; } else { $_protocol='http'; $d08054=80; } $ca57c1=substr($_SERVER['PHP_SELF'],0,strpos($_SERVER['PHP_SELF'],'/index.php')); list ($d57de2, ) = explode(':',$_SERVER['HTTP_HOST']); if($_SERVER['SERVER_PORT']!=$d08054)$d57de2.=':'. $_SERVER['SERVER_PORT']; $full_blog_url=$_protocol. '://'. $d57de2.$ca57c1; $v097cc=$_protocol. '://'. $d57de2.$_SERVER['REQUEST_URI']; $_user_folder_name=str_replace('/','--',$d57de2.$ca57c1); if(substr($_user_folder_name,0,4)=='www.'){ $_user_folder_name=substr($_user_folder_name,4); } if(is_file('superconfig.php')) { include 'superconfig.php'; } if(is_file('multiuser')) { define('USER_MODE','multi'); if(array_key_exists($_user_folder_name,$_superconfig['rewrites'])) { $_user_folder_name=$_superconfig['rewrites'][$_user_folder_name]; } } else { define('USER_MODE','single'); } define('ROOT_FOLDER',$_SERVER['DOCUMENT_ROOT'] . (($_SERVER['DOCUMENT_ROOT']!='/')?'/':'')); if(USER_MODE=='multi'){ define('USER_FOLDER','users/'. $_user_folder_name .'/'); } else { define('USER_FOLDER', @$__E2_FOLDER_PREFIX__.'user/'); } define('EXTRAS_FOLDER',USER_FOLDER.'extras/'); define('BACKUP_FOLDER',USER_FOLDER.'backup/'); define('CACHES_FOLDER',USER_FOLDER.'caches/'); define('USER_LIBRARY_FOLDER',USER_FOLDER.'library/'); define('TEMPLATES_FOLDER','themes/'); define('PICTURES_FOLDER','pictures/'); define('AUDIO_FOLDER','audio/'); define('THUMBNAILS_FOLDER','pictures/thumbs/'); define('SYSTEM_FOLDER','system/'); define('SCRIPTS_FOLDER','system/js/'); define('SYSTEM_LIBRARY_FOLDER','system/library/'); define('SYSTEM_TEMPLATE_FOLDER','system/theme/'); define('DEFAULT_USERPIC_FILENAME','system/theme/images/userpic.svg'); define('DEFAULT_USERPIC_PLACEHOLDER_FILENAME','system/theme/images/userpic-placeholder.svg'); define('AUDIO_ICON_IMAGE','system/theme/images/audio.svg'); define('AUDIO_ICON_WIDTH',64); define('AUDIO_ICON_HEIGHT',64); define('LANGUAGES_FOLDER','system/languages/'); define('DEFAULTS_FOLDER','system/default/'); define('MTMPL_FOLDER','system/default/mail/'); define('DEFAULT_TEMPLATE','plain'); if(substr(@$_SERVER['HTTP_ACCEPT_LANGUAGE'],0,2)=='ru'){ define('DEFAULT_LANGUAGE','ru'); } else { define('DEFAULT_LANGUAGE','en'); } define('NO_REASON',''); define('CACHE',true); define('CACHE_NOTES',CACHE and true); define('CACHE_NOTES_COMMENTS',CACHE and true); define('CACHE_POPULAR',CACHE and true); define('CACHE_HOT',CACHE and true); define('CACHE_FAVS',CACHE and true); define('CACHE_TAGS',CACHE and true); define('CACHE_FAVTAGS',CACHE and true); define('CACHE_NOTES_COUNTS',CACHE and true); define('CACHE_EDGE_TIMEINFO',CACHE and true); define('CACHE_FRONTPAGE',CACHE and true); define('CACHE_FRONTPAGE_RSS',CACHE and true); define('CACHE_FULLLIST',CACHE and true); define('CACHE_DRAFTS',CACHE and true); define('CACHE_DRAFTS_ALIAS_USE_COUNTS',CACHE and true); define('CACHE_FILENAMES_NOTES',CACHES_FOLDER.'note-*.ctree.psa'); define('CACHE_FILENAMES_NOTES_COMMENTS', CACHES_FOLDER.'note-*-comments.ctree.psa' ); define('CACHE_FILENAMES_NOTES_COUNTS',CACHES_FOLDER.'notes-count-*.txt'); define('CACHE_FILENAMES_EDGE_TIMEINFO',CACHES_FOLDER.'*.e2time.psa'); define('CACHE_FILENAME_POPULAR',CACHES_FOLDER.'popular.ctree.psa'); define('CACHE_FILENAME_POPULAR_EXPIRES',CACHES_FOLDER.'popular-expires.txt'); define('CACHE_FILENAME_HOT',CACHES_FOLDER.'hot.ctree.psa'); define('CACHE_FILENAME_HOT_EXPIRES',CACHES_FOLDER.'hot-expires.txt'); define('CACHE_FILENAME_FAVS',CACHES_FOLDER.'favourites.ctree.psa'); define('CACHE_FILENAME_TAGS',CACHES_FOLDER.'tags.ctree.psa'); define('CACHE_FILENAME_TAGS_AUTHOR',CACHES_FOLDER.'tags-author.ctree.psa'); define('CACHE_FILENAME_FAVTAGS',CACHES_FOLDER.'favtags.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE',CACHES_FOLDER.'frontpage.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE_AUTHOR',CACHES_FOLDER.'frontpage-author.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE_RSS',CACHES_FOLDER.'frontpage-rss.psa'); define('CACHE_FILENAME_FULLLIST',CACHES_FOLDER.'notes-list.ctree.psa'); define('CACHE_FILENAME_DRAFTS',CACHES_FOLDER.'drafts.psa'); define('CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS',CACHES_FOLDER.'drafts-auc.psa'); define('E2E_STRANGE_ERROR',10); define('E2E_USER_ERROR',20); define('E2E_PERMISSIONS_ERROR',30); define('E2E_DATABASE_ERROR',40); define('E2E_MESSAGE',100); define('E2E_DIAGNOSTICS_MESSAGE',110); define('IMPORT_DB_SETTINGS',true); define('DB_PASSWORD_RECOVER_AND_SHOW',false); define('DEFAULT_ITEMS_PER_PAGE',10); define('MAX_ITEMS_PER_PAGE',100); define('MAX_SEARCH_RESULTS',50); define('DB_OK',0); define('DB_CANNOT_FIND', -1); define('DB_CANNOT_CONNECT', -2); define('DB_DB_QUERY_ERROR', -3); define('FP_NO_ID_OR_NEW', -1); define('FP_INSERT_ERROR', -10); define('FP_UPDATE_ERROR', -11); define('FP_EMPTY_FIELD', -20); define('FP_TITLE_OR_TEXT_EMPTY', -21); define('FP_NOT_COMMENTABLE', -30); define('FP_COMMENT_DOUBLE_POST', -101); define('FP_COMMENT_TOO_LONG', -102); define('FP_COMMENT_SPAM_SUSPECT', -103); define('NOTE_COMMENTABLE_NOW', -1); define('NOTE_COMMENTABLE_NOW_CONDITIONALLY', -2); define('ENTITY_TYPE_UNSPECIFIED',''); define('ENTITY_TYPE_NOTE','n'); define('ENTITY_TYPE_TAG','t'); define('CSS_CLASS_HIGHLIGHT','e2-marked'); define('THUMB_WIDTH',200); define('THUMB_HEIGHT',160); define('THUMB_JPG_QUALITY',90); define('SCALED_IMAGE_JPG_QUALITY',80); define('USERPIC_WIDTH',80); define('USERPIC_HEIGHT',80); define('USERPIC_JPG_QUALITY',90); @include DEFAULTS_FOLDER. 'config.php'; $_default_config=$_config; @include USER_FOLDER. 'config.php'; $_config=array_merge($_default_config,$_config); if($_config['write_log'])define('__LOG',1); else define('__LOG',0); $n5269f=@$_SERVER['HTTP_USER_AGENT'] or $n5269f=''; $_ios=strstr($n5269f,'iPhone') || strstr($n5269f,'iPad'); $_macintosh=strstr($n5269f,'Macintosh'); error_reporting(E_ALL); $_db_error=false; $_fp_error=false; $m589b3=true; if(strstr(__FILE__,'all.php'))$m589b3=false; function __log($l1cb25,$ic9e9a=0){ global$stopwatch,$_log_depth; if ($l1cb25===null){ if(function_exists('file_put_contents')) { @file_put_contents(USER_FOLDER.'log.txt',''); @chmod(USER_FOLDER.'log.txt',NEW_FILES_RIGHTS); } return; } $m605ac=''; $taf240=str_pad(round(g7f78()-$stopwatch,5),10,' ',STR_PAD_RIGHT); if ($l1cb25[0]=='}'){ -- $_log_depth; if($_log_depth < 0)$_log_depth=0; } $a8e13f=( RUN_ID .' '. $m605ac .''. $taf240 .' '. str_repeat(' ',$_log_depth*2). $l1cb25."\n" ); if ($l1cb25[strlen($l1cb25)-1]=='{'){ ++ $_log_depth; } $v15d61=FILE_APPEND; if(function_exists('file_put_contents')) { @file_put_contents(USER_FOLDER.'log.txt',$a8e13f,$v15d61); @chmod(USER_FOLDER.'log.txt',NEW_FILES_RIGHTS); } } function e2_go_to($y56790=''){ global$_protocol,$errors,$d57de2,$ca57c1; @session_start(); $_SESSION['errors']=$errors; if(substr($y56790,0,strlen($_protocol)+3)!=$_protocol .'://'){ header('Location: '. $_protocol .'://'. $d57de2.$ca57c1 .'/'. $y56790); } else { header('Location: '. $y56790); } flush(); return true; } function l4930(){ $p469bb=$_SERVER['HTTP_REFERER']; return e2_go_to($p469bb); } function g4924($y56790){ if($_SERVER['HTTP_REFERER'])$y56790=$_SERVER['HTTP_REFERER']; return e2_go_to($y56790); } function c8c3b($qb2145=''){ $f9dd4e=substr_count($_SERVER['HTTP_HOST'],'.'); $v2cb9d=@str_repeat('_',$f9dd4e).$qb2145; return $v2cb9d; } function ec64a($qb2145,$q2063c='',$fb0b70=true){ $jcd91e=$fb0b70? (time()+3600*24*365) : (0); $aad5f8=$_SERVER['HTTP_HOST']; $ce9c6c=substr_count($aad5f8,'.'); if ($ce9c6c < 3)$aad5f8=str_repeat('.',3-$ce9c6c).$aad5f8; $f9dd4e=setcookie(c8c3b($qb2145),$q2063c,$jcd91e,'/'); } function m163d($s183d6,$xb45cf,$lcadc8=''){ if(trim($xb45cf)!=''){ $xb45cf=explode($s183d6,$xb45cf); foreach ($xb45cf as $c865c0 => $z8ce4b)$xb45cf[$c865c0]=trim($z8ce4b); foreach ($xb45cf as $c865c0 => $z8ce4b) if ($z8ce4b=='') unset ($xb45cf[$c865c0]); $k7b774=array_unique($xb45cf); if ('sort'==$lcadc8)sort($k7b774); return $k7b774; } else return array (); } function cbb8d($xb45cf){ global$_macintosh,$_ios; if($_ios) return ''; if ($xb45cf=='submit'){ if($_macintosh){ return '&#x2303; &#x21a9;'; } else { return 'Ctrl + Enter'; } } if ($xb45cf=='livesave'){ if($_macintosh){ return '&#x2318; S'; } else { return 'Ctrl + S'; } } if ($xb45cf=='navigation'){ if($_macintosh){ return '&#x2325;'; } else { return 'Ctrl'; } } if ($xb45cf=='navigation-later'){ if($_macintosh){ return '&#x2325; &uarr;'; } else { return 'Ctrl + &uarr;'; } } if ($xb45cf=='navigation-earlier'){ if($_macintosh){ return '&#x2325; &darr;'; } else { return 'Ctrl + &darr;'; } } } function t7b91($l1cb25){ $l1cb25=str_replace('<','&lt;',$l1cb25); $l1cb25=str_replace('>','&gt;',$l1cb25); return $l1cb25; } function ec4b6($l1cb25){ $l1cb25=str_replace('"','&quot;',$l1cb25); return $l1cb25; } function md056($q2063c,$c5d6db){ return str_replace('.',',',round($q2063c,$c5d6db)); } function e2_stripslashes_array($vf1f71){ return is_array($vf1f71)?array_map('e2_stripslashes_array',$vf1f71):stripslashes($vf1f71); } function c269a(){ if(get_magic_quotes_runtime()) { set_magic_quotes_runtime(0); } if(get_magic_quotes_gpc()) { $_GET=e2_stripslashes_array($_GET); $_POST=e2_stripslashes_array($_POST); $_COOKIE=e2_stripslashes_array($_COOKIE); $_REQUEST=e2_stripslashes_array($_REQUEST); } } function i0786($l957b5){ return sprintf('%u',ip2long($l957b5)); } function t7c85($fb1bc2){ return long2ip(sprintf('%d',$fb1bc2)); } function e2_decline_for_number($l1cb25,$fb1bc2=null){ $x2f713=$l1cb25; if ($fb1bc2===null){ $fb1bc2=substr($l1cb25,0,strpos($l1cb25,' ')); $x2f713=substr($l1cb25,strpos($l1cb25,' ')+1); } $pf07c9=strpos($x2f713,'('); $b46901=strpos($x2f713,')'); if ($b46901 > $pf07c9)$l22b9f=substr($x2f713,$pf07c9,$b46901-$pf07c9+1); $c93da6=explode(',',trim(@$l22b9f,'()')); if(count($c93da6)==2)array_unshift($c93da6,''); $nc78bd=array (2,0,1,1,1,2,2,2,2,2); if ($fb1bc2%100 > 10 and $fb1bc2%100 < 20)$tcd14c=2; else $tcd14c=$nc78bd[$fb1bc2%10]; $oef3e3=$c93da6[$tcd14c]; $l1cb25=str_replace($l22b9f,$oef3e3,$l1cb25); if(strstr($l1cb25,'(') and strstr($l1cb25,')')) { return e2_decline_for_number($l1cb25,$fb1bc2); } else { return $l1cb25; } } function dc5a6($hf2ce1){ $t87e9e=glob($hf2ce1,GLOB_NOSORT); if(is_array($t87e9e)) { foreach ($t87e9e as $k435ed){ @unlink($k435ed); } } } function g74dc($f73600){ $t87e9e=glob($f73600 .'*',GLOB_NOSORT); if(is_array($t87e9e)) { foreach ($t87e9e as $k435ed){ if(basename($k435ed)!='.' and basename($k435ed)!='..'){ if(is_dir($k435ed)) { if (g74dc($k435ed .'/')) { if (!rmdir($k435ed)) { return false; } } else { return false; } } else { @unlink($k435ed); } } } return true; } else { return false; } } function fcc38($j572d4){ global $d57de2,$ca57c1; if(g)__log('Spawn '. $j572d4 .'...'); $j572d4=str_replace('http://'. $d57de2,'',$j572d4); $a0666f=@fsockopen($_SERVER['HTTP_HOST'],$_SERVER['SERVER_PORT'],$l70106,$e809b1,1); if(__LOG)__log('Spawn fsockopen returns '. $a0666f .', (errno='. $l70106 .', errstr='. $e809b1 .')...'); if ($a0666f){ @socket_set_timeout($a0666f,1); $r8d777 = 'GET '. $j572d4 ." HTTP/1.0\r\n". 'Host: '. $d57de2 ."\r\n". 'User-Agent: '. E2_UA_STRING ."\r\n". eff2e(); $q5e369=@fwrite($a0666f,$r8d777 ."\r\n"); $q5e369=@fclose($a0666f); return true; } else { return false; } } function zaf42($nd6fe1){ $nd6fe1=trim($nd6fe1,'/'); $nd6fe1=explode('/',$nd6fe1); $f73600=''; foreach ($nd6fe1 as $r83878){ $f73600=$f73600.$r83878; if (!is_dir($f73600)) { if (@mkdir($f73600)) { @chmod($f73600,NEW_FILES_RIGHTS); } else { return false; } } $f73600=$f73600.'/'; } return true; } function h4d36($nd6fe1){ return preg_replace('/\/([^\/]+?)\/\.\./','',$nd6fe1); } function ice9b($xb45cf){ $tcee6f=get_html_translation_table(HTML_ENTITIES); $tcee6f=array_flip($tcee6f); return strtr($xb45cf,$tcee6f); } function g7f78($f32c11=NULL){ if(NULL==$f32c11)$f32c11=microtime(); list ($p6021b,$f74459)=explode(' ',$f32c11); return ((float)$p6021b + (float)$f74459); } define('HEL_SPECIAL_CHAR',"\x1"); define('HEL_SPECIAL_SEQUENCE_LENGTH',6); function r4e85($h6a992){ return str_pad($h6a992,HEL_SPECIAL_SEQUENCE_LENGTH,'0',STR_PAD_LEFT); } function hel_savetag($oe4d23){ global $p16234; $h6a992=count($p16234); $p16234[$h6a992]=$oe4d23[0]; return HEL_SPECIAL_CHAR.r4e85($h6a992).HEL_SPECIAL_CHAR; } function qdae3($l1cb25){ global $p16234; if ($p16234){ foreach ($p16234 as $h6a992 => $q2063c){ $l1cb25=str_replace(HEL_SPECIAL_CHAR. r4e85($h6a992).HEL_SPECIAL_CHAR,$q2063c,$l1cb25); } } return $l1cb25; } $stopwatch=g7f78($stopwatch); function o3aa5($f9dd4e){ global$_e2utf8__unformat_htmlentity_neasden; if($_e2utf8__unformat_htmlentity_neasden){ return $f9dd4e; } else { return '((html '. $f9dd4e .'))'; } } function cedd9($je98a6,$k98df3=false){ $b80a41=''; $pf5a8e=strlen($je98a6); for ($c865c0=0; $c865c0 < 256; ++ $c865c0){ $hf3d13[$c865c0]=0; $q0fc3c=$c865c0; while ($q0fc3c & 0x00000080){ $q0fc3c <<= 1; ++ $hf3d13[$c865c0]; } } for ($c865c0=0xd090; $c865c0 <= 0xd0bf; $c865c0++)$r84a26[$c865c0]=chr(($c865c0 & 0x000000ff)+48); for ($c865c0=0xd180; $c865c0 <= 0xd18f; $c865c0++)$r84a26[$c865c0]=chr(($c865c0 & 0x000000ff)+112); $r84a26[0xd081]="\xa8"; $r84a26[0xd191]="\xb8"; $r84a26[0xc299]="\x99"; $r84a26[0xc2a9]="\xa9"; $r84a26[0xc2ae]="\xae"; $r84a26[0xc2ab]="\xab"; $r84a26[0xc2bb]="\xbb"; $r84a26[0xc2a0]="\xa0"; $c865c0=0; while ($c865c0 < $pf5a8e){ $tac558=$je98a6{$c865c0}; $tc267c=ord($tac558); if ($hf3d13[$tc267c]==0){ $b80a41.=$tac558; ++ $c865c0; } elseif ($hf3d13[$tc267c]==2){ $f06214=$r84a26[($tc267c << 8) | ord($je98a6{$c865c0+1})]; $b80a41 .= ($f06214!=null)? $f06214 : ( $k98df3? (o3aa5( eebe5(substr($je98a6,$c865c0,2)) )) : '?' ); $c865c0+=2; } else { $mdfbc9=substr($je98a6,$c865c0,$hf3d13[$tc267c]); if ($mdfbc9=="\xe2\x84\x96")$b80a41.="\xb9"; elseif ($mdfbc9=="\xe2\x80\x93")$b80a41.="\x96"; elseif ($mdfbc9=="\xe2\x80\x94")$b80a41.="\x97"; elseif ($mdfbc9=="\xe2\x80\x98")$b80a41.="\x91"; elseif ($mdfbc9=="\xe2\x80\x99")$b80a41.="\x92"; elseif ($mdfbc9=="\xe2\x80\x9a")$b80a41.="\x82"; elseif ($mdfbc9=="\xe2\x80\x9c")$b80a41.="\x93"; elseif ($mdfbc9=="\xe2\x80\x9d")$b80a41.="\x94"; elseif ($mdfbc9=="\xe2\x80\x9e")$b80a41.="\x84"; elseif ($mdfbc9=="\xe2\x80\xa6")$b80a41.="\x85"; elseif ($mdfbc9=="\xe2\x80\xb9")$b80a41.="\x8b"; elseif ($mdfbc9=="\xe2\x80\xba")$b80a41.="\x9b"; elseif ($mdfbc9=="\xe2\x82\xac")$b80a41.="\x88"; elseif ($mdfbc9=="\xe2\x84\xa2")$b80a41.="\x99"; else $b80a41.=$k98df3? (o3aa5( eebe5($mdfbc9) )) : '?'; $c865c0+=$hf3d13[$tc267c]; } } return $b80a41; } function eebe5($h4a8a0){ $mcc411=''; $pf5a8e=strlen($h4a8a0); for ($c865c0=0; $c865c0 < $pf5a8e; ++ $c865c0){ $mcc411.=preg_replace('/^1*0/','',decbin(ord($h4a8a0{$c865c0}))); } return '&#'. bindec($mcc411) .';'; } function efd97($f341be) { $v2cb9d=$f341be; $v2cb9d=preg_replace_callback('/([\x80-\xFF])/','e2_utf_from_windows_1251_char',$v2cb9d); return $v2cb9d; } function e2_utf_from_windows_1251_char($h4a8a0){ list (, $h4a8a0)=$h4a8a0; if ($h4a8a0=="\xa8") return "\xd0\x81"; if ($h4a8a0=="\xb8") return "\xd1\x91"; if ($h4a8a0 >= "\xc0" && $h4a8a0 <= "\xef") return "\xd0".chr(ord($h4a8a0)-48); if ($h4a8a0 >= "\xf0") return "\xd1".chr(ord($h4a8a0)-112); if ($h4a8a0=="\x85") return "\xe2\x80\xa6"; if ($h4a8a0=="\x96") return "\xe2\x80\x93"; if ($h4a8a0=="\x97") return "\xe2\x80\x94"; if ($h4a8a0=="\xab") return "\xc2\xab"; if ($h4a8a0=="\xbb") return "\xc2\xbb"; if ($h4a8a0=="\x91") return "\xe2\x80\x98"; if ($h4a8a0=="\x92") return "\xe2\x80\x99"; if ($h4a8a0=="\x93") return "\xe2\x80\x9c"; if ($h4a8a0=="\x94") return "\xe2\x80\x9d"; if ($h4a8a0=="\x84") return "\xe2\x80\x9e"; if ($h4a8a0=="\x99") return "\xe2\x84\xa2"; if ($h4a8a0=="\xb9") return "\xe2\x84\x96"; if ($h4a8a0=="\xa0") return "\xc2\xa0"; return '?'; }; function e2_utf8_version_of_array_($vf1f71){ foreach ($vf1f71 as $z8ce4b => $s9e366){ if (!array_key_exists($z8ce4b.'.u?',$vf1f71)) { if(is_string($vf1f71[$z8ce4b])) { $vf1f71[$z8ce4b]=efd97($vf1f71[$z8ce4b]); } elseif(is_array($vf1f71[$z8ce4b])) { $vf1f71[$z8ce4b]=e2_utf8_version_of_array_($vf1f71[$z8ce4b]); } } } return $vf1f71; } function cff7c($f341be){ return preg_replace('/[\x{10000}-\x{fffff}]/u','?',$f341be); } $_folders_written=array ( '.', USER_FOLDER, CACHES_FOLDER, BACKUP_FOLDER, PICTURES_FOLDER, THUMBNAILS_FOLDER, AUDIO_FOLDER, ); $_files_written=array ( USER_FOLDER.'password-hash.psa', USER_FOLDER.'password-wait.psa', USER_FOLDER.'last-comment.psa', USER_FOLDER.'settings.psa', USER_FOLDER.'auth.psa', USER_FOLDER.'log.txt', ); define('CROP_NONE',0); define('CROP_SQUARE',1); function bea70(){ global$_folders_written,$_files_written; clearstatcache(); $p10ae9=array(); foreach($_folders_written as $s8fa14){ if(is_dir($s8fa14) and !is_writable($s8fa14)) { $p10ae9[] = $s8fa14; } } foreach($_files_written as $s8fa14){ if(is_file($s8fa14) and !is_writable($s8fa14)) { $p10ae9[] = $s8fa14; } } return $p10ae9; } function scdf0($e8c7dd){ if(function_exists('file_get_contents')) { return @file_get_contents($e8c7dd); } else { $s8fa14=fopen($e8c7dd,"rb"); clearstatcache(); $te358e=fread($s8fa14,filesize($e8c7dd)); fclose($s8fa14); return $te358e; } } function t6e52($e8c7dd,$xb45cf){ if(function_exists('file_put_contents')) { if (!file_put_contents($e8c7dd,$xb45cf,LOCK_EX)) { return false; } } else { if ($a0666f=@fopen($e8c7dd,'a+b')) { flock($a0666f,LOCK_EX); ftruncate($a0666f,0); fseek($a0666f,0); fwrite($a0666f,$xb45cf); fclose($a0666f); } else { return false; } } @chmod($e8c7dd,NEW_FILES_RIGHTS); return true; } function scd2d($e8c7dd,$xb45cf){ if(function_exists('file_put_contents')) { $v2cb9d=@file_put_contents($e8c7dd,$xb45cf); @chmod($e8c7dd,NEW_FILES_RIGHTS); return $v2cb9d; } else { $s8fa14=@fopen($e8c7dd,'ab'); if ($s8fa14){ if (@flock($s8fa14,LOCK_EX)) { $kb92d9=ignore_user_abort(1); @ftruncate($s8fa14,0); @fseek($s8fa14,0); fwrite($s8fa14,$xb45cf); fflush($s8fa14); @flock($s8fa14,LOCK_UN); fclose($s8fa14); @chmod($e8c7dd,NEW_FILES_RIGHTS); ignore_user_abort($kb92d9); return true; } else { fclose($s8fa14); return false; } } else { return false; } } } function df5a9(){ global$settings,$_template; if(__LOG)__log('Files: Prepage to scale images for template <'. $_template['name'] .' : '. $_template['max_image_width'] .'>'); if($settings['max-image-width']!=$_template['max_image_width']) { if(__LOG)__log('Files: max_image_width changed to '. $_template['max_image_width']); $settings['max-image-width']=$_template['max_image_width']; if(__LOG)__log('Files: Cleaning cached notes'); e7996(); if(__LOG)__log('Files: Saving updated settings for max-image-width'); if (!@t6e52(USER_FOLDER.'settings.psa',serialize($settings))) { k8a40('',E2E_PERMISSIONS_ERROR); } } if(__LOG)__log('Files: Done preparing to scale images'); } function a25cb($k435ed,$u3dbb8){ if ($u3dbb8){ $h80127=explode('/',$k435ed); $c954eb=array_pop($h80127); $o35b88=explode('.',$c954eb); if(count($o35b88) < 2)$o35b88[] = ''; $mabf77=array_pop($o35b88); $o35b88[] = $u3dbb8; if ($mabf77)$o35b88[] = $mabf77; $c954eb=implode('.',$o35b88); $h80127[] = $c954eb; $k435ed=implode('/',$h80127); } return $k435ed; } function v291d($raf721,$t6890f=false){ $ud1789=array ( 'w' => THUMB_WIDTH, 'h' => THUMB_HEIGHT, 'q' => THUMB_JPG_QUALITY ); return m8611( PICTURES_FOLDER.$raf721, THUMBNAILS_FOLDER.a25cb($raf721,'thumb@2x'), $ud1789, CROP_NONE, $t6890f ); } function i30f2($raf721){ $g8743c=pathinfo($raf721); $mabf77=$g8743c['extension']; return (in_array(strtolower($mabf77), array ('jpg','jpeg','gif','png'))); } function m8611($raf721,$i6efa1,$e93a57,$rcff96,$t6890f){ global$_config; if(__LOG)__log('Scale image: <'. $raf721 .'>'); if ($t6890f){ if(__LOG)__log('Scale image: recreate requested'); } $j7ae08=pathinfo($i6efa1); if (i30f2($raf721)) { if(__LOG)__log('Scale image: source_name <'. $raf721 .'>'); if(__LOG)__log('Scale image: dest_name <'. $i6efa1 .'>'); if ($e93a57['h'] == -1)$e93a57['h']=999999; if (!is_file($i6efa1) or $t6890f){ if (@zaf42($j7ae08['dirname'])) { b6b7f( $raf721, $e93a57['w'],$e93a57['h'],$e93a57['q'], $i6efa1, $rcff96 ); if(is_file($i6efa1)) { if(__LOG)__log('Scale image: done'); chmod($i6efa1,$_config['uploaded_files_mode']); } else { if(__LOG)__log('Scale image: error (no php_gd?)'); return false; } } } else { if(__LOG)__log('Scale image: already exists'); } return $i6efa1; } return false; } function x9c0a($ub0689,$y12e09,$a77dce){ if(preg_match('//u',$ub0689))$ub0689=cedd9($ub0689,false); if ($y12e09=='image'){ $l85114=PICTURES_FOLDER; } elseif ($y12e09=='audio'){ $l85114=AUDIO_FOLDER; } else { return false; } $s96704=''; for ($c865c0=0; $c865c0 < strlen($ub0689); $c865c0++) { if ($ub0689[$c865c0]=='?'){ $s96704.=''; } elseif ($ub0689[$c865c0]==' '){ $s96704.='-'; } elseif(ord($ub0689[$c865c0]) <= 127){ $s96704.=$ub0689[$c865c0]; } } if ($s96704=='')$s96704=$y12e09; if ($s96704[0]=='.')$s96704=$y12e09.$s96704; if (!$a77dce){ if(is_file($l85114.$s96704)) { $t5c917=substr($s96704,0,strrpos($s96704,'.')); $mabf77=substr($s96704,strrpos($s96704,'.')); $c865c0=0; while (is_file($l85114.$t5c917.'_'.(++$c865c0).$mabf77)); $s96704=$t5c917 .'_'. $c865c0.$mabf77; } } return $s96704; } function e2j_file_upload(){ global$_config,$full_blog_url; @zaf42(PICTURES_FOLDER); @chmod(PICTURES_FOLDER,$_config['uploaded_files_mode']); @zaf42(AUDIO_FOLDER); @chmod(AUDIO_FOLDER,$_config['uploaded_files_mode']); if(count($_FILES) > 0){ foreach($_FILES as $e8c7dd){ if (!$e8c7dd['error']) { if(__LOG)__log('Ajax file upload: <'. $e8c7dd['name'].'>'); $y12e09='image'; $l85114=PICTURES_FOLDER; if(substr($e8c7dd['name'],strrpos($e8c7dd['name'],'.')) == '.mp3'){ $y12e09='audio'; $l85114=AUDIO_FOLDER; } $a77dce=( array_key_exists('overwrite',$_GET) and is_file($l85114.$e8c7dd['name']) ); $r20027=($a77dce?'same-file':'new-file'); if(__LOG)__log('Ajax file upload: Overwrite is resolved to <'. (int)$a77dce.'>'); $s96704=x9c0a($e8c7dd['name'],$y12e09,$a77dce); if(__LOG)__log('Ajax file upload: Safe name is <'. $s96704.'>'); move_uploaded_file($e8c7dd['tmp_name'],$l85114.$s96704); @chmod($e9f57c,$_config['uploaded_files_mode']); if ($y12e09=='image'){ if ($bf1210=v291d($s96704,$a77dce)) { if(__LOG)__log('Ajax file upload: thumbnail, done'); $size=getimagesize($bf1210); list ($eeaae2,$kb435e)=$size; die ('image|'. $s96704 .'|'. $full_blog_url .'/'. $bf1210 .'|'. $r20027 .'|'. floor($eeaae2/2) .'|'. floor($kb435e/2)); } else { @unlink($l85114.$s96704); die ('error|could-not-create-thumbnail'); } } if ($y12e09=='audio'){ if(__LOG)__log('Ajax file upload: audio, done'); $bf1210=AUDIO_ICON_IMAGE; $eeaae2=AUDIO_ICON_WIDTH; $kb435e=AUDIO_ICON_HEIGHT; die ('audio|'. $s96704 .'|'. $full_blog_url .'/'. $bf1210 .'|'. $r20027 .'|'. $eeaae2 .'|'. $kb435e); } } elseif(4!=$e8c7dd['error']) { if ($e8c7dd['error']==1){ die ('error|too-big'); } elseif ($e8c7dd['error']==2){ die ('error|too-big'); } elseif ($e8c7dd['error']==3){ die ('error|partial'); } else { die ('error|'. $e8c7dd['error']); } } } } else { if(__LOG)__log('Ajax file upload error: no files'); die ('error|no-files'); } } function e2j_userpic_upload(){ global$_config; if(count($_FILES)==1){ $e8c7dd=array_pop($_FILES); if (!$e8c7dd['error']) { if(__LOG)__log('Ajax userpic upload: <'. $e8c7dd['name'].'>'); $ta93b8=pathinfo($e8c7dd['name']); $mabf77=strtolower($ta93b8['extension']); if ($mabf77!='png')$mabf77='jpg'; $k435ed='userpic.original.'. $mabf77; move_uploaded_file($e8c7dd['tmp_name'],USER_FOLDER.$k435ed); @chmod(USER_FOLDER.$k435ed,$_config['uploaded_files_mode']); $ud1789=array ( 'w' => USERPIC_WIDTH, 'h' => USERPIC_HEIGHT, 'q' => USERPIC_JPG_QUALITY ); @unlink(USER_FOLDER.'userpic@2x.png'); @unlink(USER_FOLDER.'userpic@2x.jpg'); $bf1210=m8611( USER_FOLDER.$k435ed, USER_FOLDER .'userpic@2x.jpg', $ud1789, CROP_SQUARE, true ); @unlink(USER_FOLDER.$k435ed); if ($bf1210){ if(__LOG)__log('Ajax userpic upload: userpic, done'); die ('image|'. $bf1210); } else { die ('image|'.DEFAULT_USERPIC_FILENAME); } } elseif(4!=$e8c7dd['error']) { if ($e8c7dd['error']==1){ die ('error|too-big'); } elseif ($e8c7dd['error']==2){ die ('error|too-big'); } elseif ($e8c7dd['error']==3){ die ('error|partial'); } else { die ('error|'. $e8c7dd['error']); } } } else { if(__LOG)__log('Ajax userpic upload error: no or too many files'); die ('error|no-or-too-many-files'); } die ('error|uncatched-error'); } function e2j_file_remove(){ $e8c7dd=$bf1210=''; if(array_key_exists('file',$_POST))$e8c7dd=$_POST['file']; if(array_key_exists('thumb',$_POST))$bf1210=$_POST['thumb']; if(substr($e8c7dd,strrpos($e8c7dd,'.')) == '.mp3'){ @unlink(AUDIO_FOLDER.$e8c7dd); die ('nothing'); } else { $bf1210=a25cb($e8c7dd,'thumb@2x'); $wd911a=a25cb($e8c7dd,'scaled'); if ($e8c7dd){ $zf6347=@unlink(PICTURES_FOLDER.$e8c7dd); $m8f458=@unlink(THUMBNAILS_FOLDER.$bf1210); die ('nothing'); } } die ('error|no-filename-passed'); } function b6b7f($bfce75,$tc69cd,$wd35fb,$wd6663,$a1c925,$rcff96){ if (!extension_loaded('gd')) { if (!dl('gd.so')) { header('Content-type: image/gif'); return false; } } $zcaf9b=@getimagesize($bfce75); if (!$zcaf9b or $zcaf9b[2] > 3) return; $k599dc=$zcaf9b[2]; if ($k599dc==1 and function_exists('imagecreatefromgif')) { list ($n73beb,$k599dc) = array (imagecreatefromgif($bfce75),'gif'); } if ($k599dc==2 and function_exists('imagecreatefromjpeg')) { list ($n73beb,$k599dc) = array (imagecreatefromjpeg($bfce75),'jpeg'); } if ($k599dc==3 and function_exists('imagecreatefrompng')) { list ($n73beb,$k599dc) = array (imagecreatefrompng($bfce75),'png'); } if (!$n73beb) return false; $eeaae2=imagesx($n73beb); $kb435e=imagesy($n73beb); $r0cb47=min($tc69cd/$eeaae2,$wd35fb/$kb435e); if ($r0cb47 < 1){ $tc69cd=round($eeaae2*$r0cb47); $wd35fb=round($kb435e*$r0cb47); } else { $tc69cd=$eeaae2; $wd35fb=$kb435e; } $e08c38=$h480e9=$xb710b=$mee920=0; if ($rcff96==CROP_SQUARE){ if ($tc69cd > $wd35fb){ $xb710b=$eeaae2-$kb435e; $e08c38=floor($xb710b/2); $wd35fb=$tc69cd; } else { $mee920=$kb435e-$eeaae2; $h480e9=floor($xb710b/2); $tc69cd=$wd35fb; } if(__LOG)__log('Files: '.'$crop_l='. $l6c5abд .' '.'$crop_t='. $h480e9 .' '.'$crop_hor='. $xb710b .' '.'$crop_ver='. $mee920 .' '); } $o28e3d=imagecreatetruecolor($tc69cd,$wd35fb); imageinterlace($o28e3d,1); if (empty ($a1c925)) { $w19229=stat($bfce75); $w19229=date('r',$w19229['mtime']); header('Last-Modified: '.$w19229); } imagecopyresampled( $o28e3d, $n73beb, 0,0, 0+$e08c38,0+$h480e9, $tc69cd,$wd35fb, $eeaae2-$xb710b,$kb435e-$mee920 ); imagejpeg($o28e3d,$a1c925,$wd6663); return true; } function r74e0(){ global$settings; if (!isset ($settings))$settings=array(); if(is_file(USER_FOLDER.'settings.psa')) { $ffa816=unserialize(scdf0(USER_FOLDER.'settings.psa')); if (!is_array($ffa816))$ffa816=array(); $settings=array_merge($settings,$ffa816); } if ( !is_numeric(@$settings['appearance']['notes_per_page']) or @$settings['appearance']['notes_per_page'] < 1 ){ $settings['appearance']['notes_per_page']=DEFAULT_ITEMS_PER_PAGE; } if ( @$settings['appearance']['notes_per_page'] > MAX_ITEMS_PER_PAGE ){ $settings['appearance']['notes_per_page']=MAX_ITEMS_PER_PAGE; } if ( !array_key_exists('comments',$settings) or !array_key_exists('on', @$settings['comments']) ) { $settings['comments']['on']=true; } return true; } function e2m_settings(){ global$settings,$_template,$_strings; $nf3e33=array(); $x5e107=@$settings['language']? $settings['language']:DEFAULT_LANGUAGE; foreach(glob(LANGUAGES_FOLDER. '*.php') as $k435ed){ $r5b54c=substr(basename($k435ed),0,2); $f98bf7=file_get_contents($k435ed); if(preg_match( '/^ *\/\/ *display_name *\= *(.*?) *$/ismu',$f98bf7,$r9c28d )) { $jc2657=$r9c28d[1]; } else { $jc2657=$r5b54c; } $nf3e33[$r5b54c] = array ( 'selected?' => (bool) ($x5e107==$r5b54c), 'display-name' => $jc2657, ); } $v2cb9d['title']=$_strings['pt--settings']; $v2cb9d['heading']=$_strings['pt--settings']; $v2cb9d['form']='form-preferences'; $v2cb9d['form-preferences'] = array ( 'blog-title-default' => htmlspecialchars($_strings['e2--default-blog-title'],ENT_COMPAT,HSC_ENC), 'blog-title' => htmlspecialchars(w6f51(),ENT_COMPAT,HSC_ENC), 'blog-description' => htmlspecialchars(@$settings['description'],ENT_COMPAT,HSC_ENC), 'blog-author-default' => htmlspecialchars($_strings['e2--default-blog-author'],ENT_COMPAT,HSC_ENC), 'blog-author' => htmlspecialchars(@$settings['author'],ENT_COMPAT,HSC_ENC), 'languages' => $nf3e33, 'language' => $x5e107, 'form-action' => t83c8('e2s_settings_save'), 'notes-per-page' => $settings['appearance']['notes_per_page'], 'email-notify?' => (bool) @$settings['notifications']['new_comments'], 'email' => htmlspecialchars(@$settings['user']['email'],ENT_NOQUOTES,HSC_ENC), 'comments-on?' => (bool) @$settings['comments']['on'], 'comments-fresh-only?' => (bool) @$settings['comments']['fresh_only'], 'show-sharing-buttons?' => (bool)$settings['appearance']['show_sharing_buttons'], 'template-name' => $_template['name'], 'templates' => z94dd(), 'submit-text' => $_strings['fb--save-changes'], ); if(E2_EDITION){ $v2cb9d['form-preferences']['yandex-metrika'] = ( htmlspecialchars( @$settings['embed']['yandex-metrika'],ENT_COMPAT,HSC_ENC ) ); } return $v2cb9d; } function e2s_settings_save(){ global$settings,$_strings; $k05df2=$s67daf=''; $k05df2=$s67daf=''; if(array_key_exists('blog-title',$_POST)) { $k05df2=trim($_POST['blog-title']); } if(array_key_exists('blog-description',$_POST)) { $s67daf=trim($_POST['blog-description']); } if(array_key_exists('blog-author',$_POST)) { $n02bd9=trim($_POST['blog-author']); } if(array_key_exists('language',$_POST)) $u8512a=$_POST['language']; if(array_key_exists('email',$_POST)) $m0c83f=trim($_POST['email']); if(array_key_exists('template',$_POST)) $k66f61=trim($_POST['template']); $u0c2bd=(int)$_POST['notes-per-page']; $settings['site_title']=$k05df2; $settings['site_title']=w6f51(); $settings['description']=$s67daf; $settings['author']=$n02bd9; $settings['user']['email']=$m0c83f; $settings['notifications']['new_comments'] = isset ($_POST['email-notify']); $settings['template']=$k66f61; if ( $settings['language']!=$u8512a or $settings['appearance']['notes_per_page']!=$u0c2bd or $settings['appearance']['show_sharing_buttons'] != isset ($_POST['show-sharing-buttons']) or $settings['comments']['on'] != isset ($_POST['comments-on']) or $settings['comments']['fresh_only'] != isset ($_POST['comments-fresh-only']) ) { @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); $settings['language']=$u8512a; $settings['appearance']['notes_per_page']=$u0c2bd; $settings['appearance']['show_sharing_buttons'] = isset ($_POST['show-sharing-buttons']); $settings['comments']['on'] = isset ($_POST['comments-on']); $settings['comments']['fresh_only'] = isset ($_POST['comments-fresh-only']); } if(E2_EDITION){ if(array_key_exists('yandex-metrika',$_POST)) { $settings['embed']['yandex-metrika']=trim($_POST['yandex-metrika']); } } dc5a6(CACHE_FILENAMES_NOTES_COMMENTS); if (!@t6e52(USER_FOLDER.'settings.psa',serialize($settings))) { k8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(t83c8('e2m_settings')); die; } e2_go_to(t83c8('e2m_frontpage')); die; } function e2m_database(){ global$settings,$_strings,$_superconfig; if (@$_superconfig['disallow_db_config']) { die ('DB Configuration not allowed'); } $v2cb9d['title']=$_strings['pt--database']; $v2cb9d['heading']=$_strings['pt--database']; $v2cb9d['form']='form-database'; $v2cb9d['form-database'] = array ( 'form-action' => t83c8('e2s_database_save'), 'db-server' => htmlspecialchars(@$settings['db']['server']? $settings['db']['server']:'localhost'), 'db-user' => htmlspecialchars(@$settings['db']['user_name']? $settings['db']['user_name']:'root'), 'db-password' => htmlspecialchars(kee85(@$settings['db']['passw'])), 'db-database' => htmlspecialchars(@$settings['db']['name']), 'submit-text' => $_strings['fb--connect-to-this-db'], ); return $v2cb9d; } function e2s_database_save(){ global$settings,$_superconfig,$_strings; if (@$_superconfig['disallow_db_config']) { die ('DB Configuration not allowed'); } if(array_key_exists('db-server',$_POST)) { $settings['db']['server'] = @$_POST['db-server']; $settings['db']['user_name'] = @$_POST['db-user']; $settings['db']['passw']=x1305(@$_POST['db-password']); $settings['db']['name'] = @$_POST['db-database']; if (!@t6e52(USER_FOLDER.'settings.psa',serialize($settings))) { k8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(t83c8('e2m_database')); die; } e2_drop_all_kinds_of_cache(); } e2_go_to(t83c8('e2m_settings')); die; } r74e0(); function k8a40($s67daf,$k599dc=E2E_STRANGE_ERROR){ global$errors,$settings, $_config, $_strings, $_diagnose; $y1897a=(!oe852()+1 <= (int)$_config['show_call_stack']); if ($s67daf){ if ($s67daf[0]!='<')$s67daf='<p>'.$s67daf .'</p>'; $lcd1dd=array ( 'description' => $s67daf, 'type' => $k599dc, ); if ( $k599dc==E2E_STRANGE_ERROR and $y1897a and function_exists('debug_backtrace') ) { $lcd1dd['backtrace']=debug_backtrace(); } $errors[] = $lcd1dd; } if ($k599dc==E2E_PERMISSIONS_ERROR){ $_diagnose['need?']=true; ec64a('diagnose','1'); } if ($k599dc==E2E_DATABASE_ERROR){ } return true; } function e8739(){ global$errors,$n1c0b7,$_strings,$_diagnose; $v7287a=bea70(); if(count($v7287a)==0){ ec64a('diagnose',''); unset($_COOKIE['diagnose']); $_diagnose['need?']=false; $_diagnose['ok?']=true; return true; } else { $h6e2ba=''; $h6e2ba.='<p>'. $_strings['gs--enable-write-permissions-for-the-following'] .'</p>'; $h6e2ba.='<ul>'; foreach ($v7287a as $s8fa14){ if ($s8fa14=='.')$s8fa14=''; if ($n1c0b7){ $h6e2ba.='<li><tt>'. ROOT_FOLDER.$s8fa14 .'</tt></li>'; } else { $h6e2ba.='<li><tt>/'. $s8fa14 .'</tt></li>'; } if(__LOG)__log('Diagnostics: cannot write <'. $s8fa14 .'>'); } $h6e2ba.='</ul>'; $lcd1dd=array ( 'title' => $_strings['et--fix-permissions-on-server'], 'description' => $h6e2ba, 'type' => E2E_DIAGNOSTICS_MESSAGE, 'class' => 'serious', ); $errors[] = $lcd1dd; $_diagnose['ok?']=false; return false; } } function ae1c4($uc1336,$s67daf){ global$errors; if(0==error_reporting() or ($uc1336 & 8)) return; k8a40('PHP ('.$uc1336.'): '.$s67daf); $errors[count($errors)-1]['phpcode']=$uc1336; } function dec07(){ global$errors,$settings,$_config; @session_start(); if(is_array(@$_SESSION['errors'])) { $le1671=array_merge(@$_SESSION['errors'],$errors); } else { $le1671=$errors; } $y1897a=(!oe852()+1 <= (int)$_config['show_call_stack']); if (@$_config['store_backtrace'] and $y1897a and $le1671!=NULL){ @t6e52('backtrace.psa',serialize($le1671)); } else { @unlink('backtrace.psa'); } if (isset ($_SESSION['errors'])) unset($_SESSION['errors']); $v2cb9d=array(); $wb8735=false; if(count($le1671) > 0){ foreach ($le1671 as $c865c0 => $i08a44){ if ($i08a44['type']==E2E_STRANGE_ERROR){ $i08a44['class']='serious'; $wb8735=true; if ($y1897a){ $i08a44['backtrace']=i2616($i08a44['backtrace']); } } if ($i08a44['type']==E2E_MESSAGE){ $i08a44['class']='info'; } $le1671[$c865c0]=$i08a44; } $v2cb9d['each']=$le1671; if ( $wb8735 and @$_config['store_backtrace'] and $y1897a and is_file('debug.php') ) { $v2cb9d['debug-link']='debug.php'; } } return $v2cb9d; } function i2616($j69206){ global $ca57c1; $j69206=array_reverse($j69206); $j69206=array_splice($j69206,0,count($j69206)-1); $le1671='<p style="background: #fea; padding: .25em .5em; line-height: 1em; overflow: hidden">'; foreach ($j69206 as $c865c0 => $te358e){ $j195df=@$te358e['args'] or $j195df=array(); $ta956a=array(); foreach ($j195df as $y5919c){ $ta956a[] = var_export($y5919c,true); } $e8c7dd=@$te358e['file']; $e8c7dd=str_replace($_SERVER['DOCUMENT_ROOT'],'',$e8c7dd); $g6438c=(@$te358e['line']? (' #'. $te358e['line']) : '?'); $le1671.='<div style="margin: .25em 0 .5em '. $c865c0*3 .'em">'; $le1671.='<span style="float: right; color: #666"> '. $e8c7dd.$g6438c .'</span>'; $le1671.='<tt><b>'. @$te358e['function'] .' (</b>'; if(count($ta956a)) { $zeb84a=str_replace("array (\n)",'array ()',$ta956a); $zeb84a=implode(', ',$zeb84a); if(0){ $zeb84a=highlight_string('<?'. $zeb84a .'?'.'>',true); $zeb84a=substr($zeb84a,77, -28); } $zeb84a=str_replace('&nbsp;',' ',$zeb84a); $zeb84a=nl2br($zeb84a); $le1671.='<div style="margin: 0 0 0 1.12em">'. $zeb84a .'</div>'; } $le1671.='<b>)</b> &rarr;</tt></div>'; } $le1671.='</p>'; return $le1671; } set_error_handler('ae1c4'); function e2_error404_mode(){ global$_strings; header('HTTP/1.1 404 Not found'); $me70c4['heading']=$_strings['pt--page-not-found']; $me70c4['title']=$_strings['pt--page-not-found']; return $me70c4; } include_once 'neasden/neasden.php'; function g6f10($l1cb25){ $Nn=new Neasden; $Nn->profile_name='kavychki'; return$Nn->format($l1cb25); } function i8447($sf2ffc,$l1cb25,$u5c18e){ if ($sf2ffc=='calliope'){ preg_match_all('/\(\(([^ ]*)( |\)\))/',$l1cb25,$r9c28d); return $r9c28d[1]; } elseif ($sf2ffc=='neasden'){ $Nn=new Neasden; $Nn->profile_name=$u5c18e; $Nn->format($l1cb25); return$Nn->resources_detected; } else { return array (); } } function i154e($sf2ffc,$l1cb25,$u5c18e){ if(__LOG)__log('Format: format with formatter "'. $sf2ffc .'" in context "'. $u5c18e.'"'); if ($sf2ffc=='calliope'){ $l1cb25=cedd9($l1cb25); $l1cb25=r5599($l1cb25,$u5c18e); $meta=array(); $l1cb25=efd97($l1cb25); $l1cb25='<div class="e2-text-calliope-formatted">'. g6f10($l1cb25) .'</div>'; } elseif ($sf2ffc=='neasden'){ $Nn=new Neasden; $Nn->profile_name=$u5c18e; $l1cb25=$Nn->format($l1cb25); $meta=array ( 'links-required' => $Nn->links_required, 'resources-detected' => $Nn->resources_detected ); } return array ( 'text-final' => $l1cb25, 'meta' => $meta, ); } function ob7f1($l1cb25,$u5c18e){ global$_config; return i154e($_config['default_formatter'],$l1cb25,$u5c18e); } function r5599($l1cb25,$u5c18e){ global$_config,$settings,$full_blog_url; @ (list ($u5c18e,$ae8fab)=explode('|',$u5c18e)); require_once 'calliope/WikiFormatter.php'; if ('full'==$u5c18e)$cad910=WF_FULL_MODE; elseif ('simple'==$u5c18e)$cad910=WF_SIMPLE_MODE; else return $l1cb25; $n0a1d3=new WikiFormatter(); $n0a1d3 -> replace=array ( '/' => 'i', '+' => 'small', '-' => 's', '*' => 'b', '^' => 'sup', 'v' => 'sub', '#' => 'tt', '!' => 'blockquote', ); $n0a1d3 -> settings=array ( 'hrefSize' => 100, 'localImgDir' => $full_blog_url .'/'. PICTURES_FOLDER, 'maxImgWidth' => $settings['max-image-width'], 'mode' => $cad910, 'enableShrinkLongHref' => 1, 'enableHr' => 0, 'enableBr' => 1, 'enableHeaders' => 1, 'headersStartWith' => 1, 'enableTables' => 1, 'simpleTableCSSClass' => 'e2-text-table', 'enableAutoAcronymEngine' => 0, 'enableAcronym' => 0, 'acronymBase' => '', 'enableList' => 1, 'mailSafe' => "<a href=\"\" onmouseover=\"this.href='mailto:'+{email}\">{icon}<script language=\"JavaScript\">document.write({name});</script></a>", 'ljUserTag' => '<a href="http://livejournal.com/users/{name}/">{name}</a>', 'fullVersionURL' => $ae8fab, 'enableTagIcons' => 0, 'outerUrlInNewWindow' => 0, 'lineBreak' => "\n", 'extLinkHrefPrefix' => '', ); $l1cb25=$n0a1d3 -> Wiki2HTML($l1cb25); return $l1cb25; } function e2m_timezone(){ global$_strings,$settings; $ode2fd=array ( 'form-action' => t83c8('e2s_select_timezone'), 'submit-text' => $_strings['fb--select'], 'timezone-selector' => d9fe5($settings['timezone']['offset'],1), 'dst?' => $settings['timezone']['is_dst'], ); return array ( 'title' => $_strings['pt--default-timezone'], 'heading' => $_strings['pt--default-timezone'], 'form' => 'form-timezone', 'form-timezone' => $ode2fd, ); } function o4c37(){ global$_strings; $x5cacd=array ( -720 => '', -660 => '', -600 => '', -540 => '', -480 => $_strings['tt--zone-pt'], -420 => $_strings['tt--zone-mt'], -360 => $_strings['tt--zone-ct'], -300 => $_strings['tt--zone-et'], -240 => '', -210 => '', -180 => '', -120 => '', -60 => '', 0 => $_strings['tt--zone-gmt'], 60 => $_strings['tt--zone-cet'], 120 => $_strings['tt--zone-eet'], 180 => '', 210 => '', 240 => $_strings['tt--zone-msk'], 270 => '', 300 => '', 330 => '', 345 => '', 360 => $_strings['tt--zone-ekt'], 390 => '', 420 => '', 480 => '', 540 => '', 570 => '', 600 => '', 660 => '', 720 => '', 780 => '', 840 => '', ); return $x5cacd; } function f82a3($a7a86c){ $x5cacd=o4c37(); return @$x5cacd[(int)$a7a86c/SECONDS_IN_A_MINUTE]; } function i9515($a7a86c){ $y04b29='+'; if ($a7a86c < 0)$y04b29='&ndash;'; $r73cdd=str_pad((int) (abs($a7a86c)/3600),2,'0',STR_PAD_LEFT); $z640fd=str_pad(abs($a7a86c)/60 % 60,2,'0',STR_PAD_LEFT); return 'GMT'. $y04b29.$r73cdd .':'. $z640fd; } function d9fe5($j0743a,$e5784d=''){ global$_strings; $x5cacd=o4c37(); $v2cb9d=''; if (!$e5784d)$e5784d=count($x5cacd); $v2cb9d.='<select name="offset" size="'. $e5784d .'">'; foreach ($x5cacd as $a7a86c => $u83bce){ $rc03a8=''; if ($a7a86c*SECONDS_IN_A_MINUTE==$j0743a)$rc03a8=' selected="selected"'; $v2cb9d.='<option'. $rc03a8 .' value="'.$a7a86c.'">'; $y04b29=''; if ($a7a86c < 0)$y04b29='−'; if ($a7a86c > 0)$y04b29='+'; $r73cdd=(int) (abs($a7a86c*SECONDS_IN_A_MINUTE)/3600); $z640fd=(int) (abs($a7a86c*SECONDS_IN_A_MINUTE)/60 % 60); if ($r73cdd){ $v2cb9d .= ( $y04b29 .' '. $r73cdd .' '. $_strings['gs--timezone-offset-hours'] .' '. ($z640fd? ($z640fd .' '. $_strings['gs--timezone-offset-minutes']) : '') ); if ($u83bce){ $v2cb9d .= ' ('. $u83bce. ')'; } } else { $v2cb9d .= $u83bce; } $v2cb9d.='</option>'; } $v2cb9d.='</select>'; return $v2cb9d; } function e2s_select_timezone(){ global$settings,$_strings; if (@$_POST['offset'] >= -720 and @$_POST['offset'] <= 780){ $settings['timezone']['offset'] = @$_POST['offset']*SECONDS_IN_A_MINUTE; $settings['timezone']['is_dst'] = isset ($_POST['is_dst']); } if (!@t6e52(USER_FOLDER.'settings.psa',serialize($settings))) { k8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(t83c8('e2m_timezone')); die; } e2_go_to(t83c8('e2m_settings')) and die (); } function i0923($saad65){ return array ( 'offset' => (int)$saad65['Offset'], 'is_dst' => (bool)$saad65['IsDST'], ); } function m3211(){ return array ( 'offset' => 0, 'is_dst' => false, ); } function i5c05(){ global$settings; return$settings['timezone']; } function z7770($pb2c6c,$jdf491){ if (@$pb2c6c['is_dst']) { $t30481=(int)date('I',$jdf491); $a6b7ea=date('Z',$jdf491)-$t30481*SECONDS_IN_AN_HOUR; $f3e61a=$pb2c6c['offset']; $b178ae=$f3e61a-$a6b7ea; $k75b02=date('I',$jdf491+$b178ae); return $k75b02; } else { return 0; } } function pb2bf($pb2c6c,$jdf491){ global$settings; if ($pb2c6c and is_array($pb2c6c)) { return ( $pb2c6c['offset'] + z7770($pb2c6c,$jdf491)*SECONDS_IN_AN_HOUR ); } } function j8afe($jdf491){ return pb2bf(i5c05(),$jdf491); } function r5a2f($p1ddcb,$v4a202,$pb2c6c){ return gmdate($p1ddcb,$v4a202+pb2bf($pb2c6c,$v4a202)); } function ia846($p1ddcb,$v4a202){ return r5a2f($p1ddcb,$v4a202,i5c05()); } function c66cd($i41529,$v6f8f5=false,$v8277e=false){ if(is_numeric($v8277e)) { $uea2b2=gmmktime(0,0,0,$v6f8f5,$v8277e,$i41529); $y7f021=gmmktime(0,0,0,$v6f8f5,$v8277e+1,$i41529)-1; } elseif(is_numeric($v6f8f5)) { $uea2b2=gmmktime(0,0,0,$v6f8f5,1,$i41529); $y7f021=gmmktime(0,0,0,$v6f8f5+1,1,$i41529)-1; } else { $uea2b2=gmmktime(0,0,0,1,1,$i41529); $y7f021=gmmktime(0,0,0,1,1,$i41529+1)-1; } return array ($uea2b2,$y7f021); } function v2143($pb2c6c,$i41529,$v6f8f5=false,$v8277e=false){ list ($uea2b2,$y7f021)=c66cd($i41529,$v6f8f5,$v8277e); $uea2b2 -= pb2bf($pb2c6c,$uea2b2); $y7f021 -= pb2bf($pb2c6c,$y7f021); return array ($uea2b2,$y7f021); } function iac5b($i41529,$v6f8f5=false,$v8277e=false){ return v2143(i5c05(),$i41529,$v6f8f5,$v8277e); } function x5273($i41529,$v6f8f5=false,$v8277e=false){ $n32038=13; $nda4f0=-12; $n32038+=1; $nda4f0 -= 1; list ($uea2b2,$y7f021)=c66cd($i41529,$v6f8f5,$v8277e); $uea2b2 -= $n32038*3600; $y7f021 -= $nda4f0*3600; return array ($uea2b2,$y7f021); } function dd17a($a7a86c){ if ((int) @$a7a86c > 0) return (string)'+'.abs(@$a7a86c); elseif ((int) @$a7a86c < 0) return (string)'-'.abs(@$a7a86c); else return ''; } function vd536($jdf491){ $t2ab64=j8afe($jdf491); $y04b29=($t2ab64 >= 0)?'+':'-'; $t2ab64=abs($t2ab64); $n03c7c=$t2ab64 % 60; $t2ab64 -= $n03c7c; $v6f8f5=$t2ab64 % 3600/60; $t2ab64 -= $v6f8f5*60; $p2510c=$t2ab64/3600; if ($p2510c < 10)$p2510c='0'.$p2510c; if ($v6f8f5 < 10)$v6f8f5='0'.$v6f8f5; return $y04b29.$p2510c.$v6f8f5; } function ua618($haa759){ global$settings; if(is_numeric($haa759)) { $result['offset']=SECONDS_IN_A_MINUTE*$haa759; $result['is_dst']=false; $cd8935=SECONDS_IN_A_MINUTE*$haa759-SECONDS_IN_AN_HOUR; $ma6cfc=array ('offset' => $cd8935,'is_dst' => true); $ma6cfc=(int)pb2bf($ma6cfc,time()); if($result['offset']==$ma6cfc){ $result['offset']=$cd8935; $result['is_dst']=true; } } else { if(array_key_exists('timezone',$settings)) { $result=$settings['timezone']; } else { $result['offset']=0; $result['is_dst']=false; } } return$result; } function f692f($h96b8c){ $p2510c=ia846('H',$h96b8c); if ($p2510c <= 4) return 4; elseif ($p2510c <= 10) return 1; elseif ($p2510c <= 16) return 2; elseif ($p2510c <= 22) return 3; else return 4; } function n7a0b($a0e524,$db65f7=null){ global$_strings; if ($db65f7===null)$db65f7=i5c05(); $gdb42a=r5a2f('d.m.Y',$k97bc5,$db65f7); $i33284=r5a2f('d.m.Y',$a0e524,$db65f7); $bed79a=SECONDS_IN_A_MINUTE; $b77cbc=SECONDS_IN_AN_HOUR; $k97bc5=time(); $a0b375=f692f($k97bc5); $q3dfda=f692f($a0e524); $f74459=$k97bc5-$a0e524; if ($f74459 < 0) return$_strings['tt--from-the-future']; if ($f74459 >= 0 and $f74459 < 54) return$_strings['tt--just-published']; if ($f74459 >= 54 and $f74459 < 108) return$_strings['tt--one-minute-ago']; $l7eccb=$f74459+12; $t7828e=floor($l7eccb/$bed79a); if ($f74459 >= 108 and $f74459 < 54*$bed79a) return e2l_get_string( 'tt--minutes-ago', array ('minutes' => $t7828e) ); if ($f74459 >= 54*$bed79a and $f74459 < 108*$bed79a) return$_strings['tt--one-hour-ago']; $l7eccb=$f74459+12*$bed79a; $r6b497=floor($l7eccb/$b77cbc); if ($f74459 >= 108*$bed79a and $f74459 < 4*$b77cbc) return e2l_get_string( 'tt--hours-ago', array ('hours' => $r6b497) ); $r07cc6=r5a2f('G:i',$a0e524,$db65f7); if ($f74459 >= 4*$b77cbc and $a0b375 > $q3dfda and $gdb42a==$i33284){ return$_strings['tt--today']; } if ((($k97bc5-$a0e524) <= YEAR_DISPLAY_THRESH)) { return e2l_get_string( 'tt--date', array ( 'day' => r5a2f('j',$a0e524,$db65f7), 'month' => r5a2f('m',$a0e524,$db65f7), ) ); } return r5a2f('Y',$a0e524,$db65f7); } $_model_contractions=array ( 'key' => "INT UNSIGNED AUTO_INCREMENT PRIMARY KEY", 'pkey' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'int' => "INT DEFAULT '0' NOT NULL", 'uint' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'time' => "INT UNSIGNED DEFAULT '0' NOT NULL", '0' => "TINYINT(1) DEFAULT '0' NOT NULL", '1' => "TINYINT(1) DEFAULT '1' NOT NULL", 'v1' => "VARCHAR(1) DEFAULT '' NOT NULL", 'v8' => "VARCHAR(8) DEFAULT '' NOT NULL", 'v15' => "VARCHAR(15) DEFAULT '' NOT NULL", 'v32' => "VARCHAR(32) DEFAULT '' NOT NULL", 'v64' => "VARCHAR(64) DEFAULT '' NOT NULL", 'fid' => "VARCHAR(32) DEFAULT '". $_config['default_formatter'] ."' NOT NULL", 'v255' => "VARCHAR(255) DEFAULT '' NOT NULL", 'text' => "TEXT", ); $_model=array ( 'Actions' => array ( array ('ID', 'key'), array ('EntityID', 'pkey'), array ('Stamp', 'time'), array ('HitCount', 'int'), ), 'Aliases' => array ( array ('ID', 'key'), array ('EntityType', 'v1'), array ('EntityID', 'pkey'), array ('Alias', 'v64'), array ('Stamp', 'time'), ), 'Notes' => array ( array ('ID', 'key'), array ('Title', 'v255'), array ('Text', 'text'), array ('FormatterID', 'fid'), array ('OriginalAlias', 'v64'), array ('IsPublished', '0'), array ('IsIssue', '0'), array ('IsCommentable', '0'), array ('IsVisible', '1'), array ('IsFavourite', '0'), array ('Stamp', 'time'), array ('LastModified', 'time'), array ('Offset', 'int'), array ('IsDST', '0'), ), 'Comments' => array ( array ('ID', 'key'), array ('NoteID', 'pkey'), array ('AuthorName', 'v255'), array ('AuthorEmail', 'v255'), array ('Text', 'text'), array ('Reply', 'text'), array ('IsVisible', '1'), array ('IsFavourite', '0'), array ('IsReplyVisible', '0'), array ('IsReplyFavourite', '0'), array ('IsAnswerAware', '1'), array ('IsSubscriber', '0'), array ('IsSpamSuspect', '0'), array ('IsNew', '0'), array ('Stamp', 'time'), array ('LastModified', 'time'), array ('ReplyStamp', 'time'), array ('ReplyLastModified','time'), array ('IP', 'v15'), ), 'Keywords' => array ( array ('ID', 'key'), array ('ParentKeywordID', 'pkey'), array ('Keyword', 'v255'), array ('OriginalAlias', 'v64'), array ('Description', 'text'), array ('IsFavourite', '0'), ), 'NotesKeywords' => array ( array ('ID', 'key'), array ('NoteID', 'pkey'), array ('KeywordID', 'pkey'), ), ); function ef1ac($vaab9e){ global$_model,$_model_contractions,$_config; if(array_key_exists($vaab9e,$_model)) { $b54ca8=array(); foreach($_model[$vaab9e] as $g1afd3){ list ($ub0689,$k599dc)=$g1afd3; $b54ca8[] = "`". $ub0689 ."` ". $_model_contractions[$k599dc]; } $q1b1cc=( "CREATE TABLE `". $_config['db_table_prefix'].$vaab9e ."` ". "(". implode(" ,",$b54ca8) .") ". "ENGINE=MyISAM DEFAULT CHARSET=utf8" ); if (r0738($q1b1cc)) return true; } } function j9943($vaab9e,$kde17f,$bb512d='INSERT',$l07ccf=''){ global$_config,$_db; $fd05b6="`". implode("`, `",array_keys($kde17f)). "`"; $af09cc="'". implode("', '",array_values($kde17f)). "'"; $q1b1cc=( $bb512d ." INTO `". $_config['db_table_prefix'].$vaab9e ."` ". "(".$fd05b6 .") VALUES (". $af09cc .")". ($l07ccf? (' '. $l07ccf):'') ); if (r0738($q1b1cc)) { $kde17f['ID']=mysqli_insert_id($_db['link']); return $kde17f; } } function naa79($vaab9e,$kde17f,$y7692d=false,$s0f543=false){ global$_config; if(__LOG)__log('Model: update record, table <'. $vaab9e .'>'); $t6a7f2=array(); foreach(e2model__soft_fields_for_table_($vaab9e) as $m06e3d){ if(array_key_exists($m06e3d,$kde17f)) { $h10249=i7928($kde17f[$m06e3d]); if ($h10249[0]=='`'){ $abcf11=$h10249; } else { $abcf11="'". $h10249 ."'"; } $t6a7f2[] = '`'. $m06e3d .'`'."=". $abcf11 .""; } } $ob5b39=array(); if(is_array($y7692d)) { foreach(e2model__soft_fields_for_table_($vaab9e) as $m06e3d){ if(array_key_exists($m06e3d,$y7692d)) { $ob5b39[] = '`'. $m06e3d .'`'."='". i7928($y7692d[$m06e3d]) ."'"; } } } if(count($ob5b39)) { $y56790=implode(" AND ",$ob5b39); } else { if (!array_key_exists('ID',$kde17f) or !is_numeric($kde17f['ID'])) { die ('API MISUSE: e2_update_record must be called with an ID field in $record when updating single row'); } $y56790="`ID`=". $kde17f['ID']; } if(count($t6a7f2) > 0){ $u91179=$s0f543? 'LOW_PRIORITY ':''; $q1b1cc=( "UPDATE ". $u91179 ."`". $_config['db_table_prefix'].$vaab9e ."` ". "SET ". implode(', ',$t6a7f2) ." WHERE ". $y56790 ); if (r0738($q1b1cc)) return true; } } function e2model__soft_fields_for_table_($vaab9e){ global$_model; $v2cb9d=array(); if(array_key_exists($vaab9e,$_model)) { foreach($_model[$vaab9e] as $m06e3d){ if (!in_array($m06e3d[1], array ('key'))) { $v2cb9d[] = $m06e3d[0]; } } } return $v2cb9d; } function e2m_install(){ global$_strings,$_superconfig,$_files_written,$_folders_written,$_diagnose; $v2cb9d=array(); if(e2_is_installed()) { e2_go_to(''); } else { if($_superconfig['disallow_installer']) { die ('Installer disabled by superconfig'); } if(__LOG)__log('Installer: not installed, present user with form'); $v2cb9d['title']=$_strings['pt--install']; $v2cb9d['heading']=$_strings['pt--install']; $ic50d0=$_strings['fb--begin']; $pd77d5['server'] = @$_COOKIE[c8c3b('install_db_server')]; $pd77d5['user_name'] = @$_COOKIE[c8c3b('install_db_user_name')]; $pd77d5['passw']=kee85(@$_COOKIE[c8c3b('install_db_passw')]); $pd77d5['name'] = @$_COOKIE[c8c3b('install_db_name')]; $v2cb9d['form-install'] = array ( 'form-action' => t83c8('e2s_install'), 'form-check-db-config-action' => t83c8('e2j_check_db_config'), 'form-list-databases-action' => t83c8('e2j_list_databases'), 'submit-text' => $ic50d0, 'retry-text' => $_strings['fb--retry'], 'db-server' => htmlspecialchars(@$pd77d5['server']? $pd77d5['server']:'localhost'), 'db-user' => htmlspecialchars(@$pd77d5['user_name']? $pd77d5['user_name']:'root'), 'db-password' => htmlspecialchars(DB_PASSWORD_RECOVER_AND_SHOW? (@$pd77d5['passw']) : ''), 'db-database' => htmlspecialchars(@$pd77d5['name']), ); $v2cb9d['form-install']['installation-possible?']=true; if(__LOG)__log('Installer: force directories'); foreach($_folders_written as $y45684){ @zaf42($y45684); } if (!@isset ($_diagnose['ok?']))e8739(); if($_diagnose['ok?']) { if(__LOG)__log('Installer: everything is fine'); } else { if(__LOG)__log('Installer: problems, tell user'); $v2cb9d['form-install']['installation-possible?']=false; } } if(__LOG)__log('Installer: return'); return $v2cb9d; } function e2_instantiate($o2af72){ global$_instance; $_instance['version']=$o2af72; if (t6e52(USER_FOLDER. '/instance.psa',serialize($_instance))) { return true; } else { die ('Cannot instantiate v'. $o2af72 .': probably permission denied'); } } function e2s_instantiate($parameters){ global$_strings; if(e2_is_installed()) { die ('Remove the file "'. USER_FOLDER .'instance.psa" first'); } else { if(is_numeric($parameters['version'])) { if(e2_instantiate($parameters['version'])) { k8a40($_strings['gs--instantiated-version'] .' v'. $parameters['version'],E2E_MESSAGE); e2_go_to(t83c8('e2m_frontpage')); die; } } } die ('Could not create instance of engine'); } function e2s_install(){ global$settings,$_strings,$_instance,$_config,$zfd6b1; if(e2_is_installed()) { e2_go_to(t83c8('e2m_install')); die; } else { e2_drop_all_kinds_of_cache(); $pd77d5['server'] = @$_POST['db-server']; $pd77d5['user_name'] = @$_POST['db-user']; $pd77d5['passw'] = x1305(@$_POST['db-password']); $pd77d5['name'] = @$_POST['db-database']; if ( ($g2a304=mysqli_connect( $pd77d5['server'],$pd77d5['user_name'],$_POST['db-password'] )) === false ){ k8a40($_strings['er--cannot-connect-to-db'],E2E_DATABASE_ERROR); e2_go_to(t83c8('e2m_install')); die; } $paae42=e2installer__data_check($g2a304,$pd77d5['name']); $b0e88b=false; if ($paae42['occupied'] and $paae42['complete']) { if(__LOG)__log('Installer: DB data exists and complete'); $b0e88b=true; } elseif ($paae42['occupied']) { if(__LOG)__log('Installer: DB data exists, but incomplete'); k8a40($_strings['er--db-data-incomplete'],E2E_DATABASE_ERROR); e2_go_to(t83c8('e2m_install')); die; } $pb2c6c=ua618(@$_POST['gmt-offset']); foreach ($pd77d5 as $z8ce4b => $s9e366){ ec64a('install_db_' .$z8ce4b,$s9e366); } @session_start(); if (!array_key_exists('password',$_POST) or trim($_POST['password']) == ''){ k8a40($_strings['er--no-password-entered'],E2E_USER_ERROR); e2_go_to(t83c8('e2m_install')); die; } $h88162=trim($_POST['password']); $f2d6d8['sessions'] = array (array ( 'stamp' => time(), 'remote_ip' => $_SERVER['REMOTE_ADDR'], 'key_hash' => me8ed(true), 'ua' => $_SERVER['HTTP_USER_AGENT'], )); $m444bc=true; if (!o1d21($f2d6d8)) { k8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); $m444bc=false; } if (!@t6e52(USER_FOLDER.'password-hash.psa',serialize(m4c49($h88162)))) { k8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); $m444bc=false; } if (!$b0e88b){ $settings=array(); } $settings['db']=$pd77d5; $settings['timezone']=$pb2c6c; $settings['template']=DEFAULT_TEMPLATE; $settings['language']=DEFAULT_LANGUAGE; if (!@t6e52(USER_FOLDER.'settings.psa',serialize($settings))) { k8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); $m444bc=false; } if ($m444bc){ if ($b0e88b){ if(__LOG)__log('Installer: No need to create DB'); $bba46b=u0f7c(); if (!$bba46b){ if(__LOG)__log('Installer: DB not OK'); k8a40($_strings['er--double-check-db-params']); } } else { if(__LOG)__log('Installer: Creating DB...'); $bba46b=( ef1ac('Notes') and ef1ac('Comments') and ef1ac('Keywords') and ef1ac('NotesKeywords') and ef1ac('Aliases') and ef1ac('Actions') ); if (!$bba46b){ if(__LOG)__log('Installer: DB not OK'); k8a40($_strings['er--double-check-db-params']); } } if ($bba46b){ if(__LOG)__log('Installer: DB OK, instantiating...'); e2_instantiate(E2_VERSION); if(__LOG)__log('Installer: Done'); if (!$pd77d5['exists']) { if(__LOG)__log('Installer: Adding indexes...'); r0738( "ALTER TABLE `". $_config['db_table_prefix']."Notes` ". "ADD FULLTEXT (`Title`, `Text`)" ); r0738( "ALTER TABLE `". $_config['db_table_prefix']."Notes` ". "ADD INDEX (`Stamp`);" ); r0738( "ALTER TABLE `". $_config['db_table_prefix']."Comments` ". "ADD INDEX (`NoteID`);" ); r0738( "ALTER TABLE `". $_config['db_table_prefix']."NotesKeywords` ". "ADD INDEX (`NoteID`)" ); r0738( "ALTER TABLE `". $_config['db_table_prefix']."Aliases` ". "ADD INDEX (`Alias`);" ); r0738( "ALTER TABLE `". $_config['db_table_prefix']."Aliases` ". "ADD INDEX (`EntityID`);" ); if(__LOG)__log('Installer: Done'); } if(__LOG)__log('Installer: Complete'); } e2_go_to(); die; } else { e2_go_to(t83c8('e2m_install')); die; } } } function e2_is_installed(){ global$_instance; return (bool)$_instance; } function e2_make_sure_that_installed(){ global $d57de2,$ca57c1,$_instance,$_superconfig; if(e2_is_installed()) { if(E2_VERSION < $_instance ['version']) { if(IGNORE_VERSION_MISMATCH) return; if(__LOG)__log('Installer: cannot downdate'); header('HTTP/1.1 503 Service Unavailable'); die ('E2 does not support automatic downgrade.'); } elseif(E2_VERSION > $_instance ['version']) { if(__LOG)__log('Installer: need to update'); header('Location: http://'. $d57de2.$ca57c1 .'/perform_update/'); header('Location: '. t83c8('e2s_update_perform')); die; } else { if(__LOG)__log('Installer: no job for me'); return; } } if(__LOG)__log('Installer: not installed {'); if ((strpos($_SERVER['SERVER_SOFTWARE'],'Apache')===0)) { if(__LOG)__log('Installer: running on Apache'); $xefe79=DEFAULTS_FOLDER.'default.htaccess'; $ed5c54=false; if (!is_file($xefe79)) { echo 'File not found: '.$xefe79. '. Please use the full E2 installation package.'; die; } if(is_file('.htaccess')) { if(__LOG)__log('Installer: there is a .htaccess file in the installation directory'); $we6f97=file_get_contents($xefe79); $yc6680=file_get_contents('.htaccess'); if ($yc6680!=$we6f97){ $ed5c54=true; $k6a9d4=$md1813='.htaccess.old'; $j3c549=1; while (is_file($md1813)) { $md1813=$k6a9d4 .'.'. $j3c549 ++; } if(__LOG)__log('Installer: existing .htaccess wrong, backing up as <'. $md1813 .'>'); if (!@rename('.htaccess',$md1813)) { if(__LOG)__log('Installer: fuck'); echo 'Looks like you are using Apache and have put an incorrect ".htaccess" file in the installation directory. Additionally, the installer was not able to back up your existing ".htaccess" file in order to replace it with the correct one. Please use the full E2 installation package and grant write access on the installation target directory, all the files and subdirectories.'; die; } } } else { $ed5c54=true; } if ($ed5c54){ if(__LOG)__log('Installer: writing a correct .htaccess file'); if (!@copy($xefe79,'.htaccess')) { if(__LOG)__log('Installer: fuck'); echo 'The installer was not able to create a correct ".htaccess" file. Please grant write access on the installation target directory.'; die; } } } if($_superconfig['disallow_installer']) { die ('Not installed'); } else { $m601f0=t83c8('e2m_install'); if(__LOG)__log('Installer: will need to install, going to '. $m601f0); if(__LOG)__log('}'); e2_go_to($m601f0); die; } } function e2_htaccess_on_apache(){ } function e2installer__usable_databases($ycf1e8,$oee11c,$m5f4dc){ $x32e95=array(); if (($g2a304=mysqli_connect($ycf1e8,$oee11c,$m5f4dc)) !== false){ $result=mysqli_query($g2a304,"SHOW DATABASES"); while ($gf1965=mysqli_fetch_row($result)) { if ( mysqli_select_db($g2a304,$gf1965[0]) and !in_array($gf1965[0], array ('information_schema','mysql')) ) { $x32e95[] = $gf1965[0]; } } } return $x32e95; } function e2installer__data_check($g2a304,$f11e0e){ global$_model,$_config; $j08cfc=false; $o35f9b=array(); $gac5c7='SHOW TABLES FROM `'. mysqli_real_escape_string($g2a304,$f11e0e). '`'; $result=mysqli_query($g2a304,$gac5c7); if($result){ while ($gf1965=mysqli_fetch_row($result)) { foreach(array_keys($_model) as $yd2ffa){ if(strcasecmp($gf1965[0],$_config['db_table_prefix'].$yd2ffa)===0){ $j08cfc=true; $o35f9b[] = $yd2ffa; } } } } $id9a22=true; foreach(array_keys($_model) as $yd2ffa){ if (!in_array($yd2ffa,$o35f9b)) { $id9a22=false; } } return array ( 'occupied' => $j08cfc, 'complete' => $id9a22, ); } function e2j_check_db_config(){ global$_model,$_config; $ycf1e8=$oee11c=$m5f4dc=$f11e0e=''; if(array_key_exists('db-server',$_POST)) $ycf1e8= $_POST['db-server']; if(array_key_exists('db-user',$_POST)) $oee11c= $_POST['db-user']; if(array_key_exists('db-password',$_POST))$m5f4dc=$_POST['db-password']; if(array_key_exists('db-database',$_POST))$f11e0e=$_POST['db-database']; if (($g2a304=mysqli_connect($ycf1e8,$oee11c,$m5f4dc)) === false){ if(mysqli_connect_errno()==1045){ die ('server-responding'); } else { die ('no-connect'); } } else { if (!$f11e0e){ $x32e95=e2installer__usable_databases($ycf1e8,$oee11c,$m5f4dc); $f11e0e=$x32e95[0]; } if(mysqli_select_db($g2a304,$f11e0e)===false){ die ('server-lets-in'); } else { $paae42=e2installer__data_check($g2a304,$f11e0e); if ($paae42['occupied'] and $paae42['complete']) { die ('bingo-data-exists'); } elseif ($paae42['occupied']) { die ('data-incomplete'); } else { die ('bingo'); } } } } function e2j_list_databases(){ $ycf1e8=$oee11c=$m5f4dc=''; if(array_key_exists('db-server',$_POST)) $ycf1e8= $_POST['db-server']; if(array_key_exists('db-user',$_POST)) $oee11c= $_POST['db-user']; if(array_key_exists('db-password',$_POST))$m5f4dc=$_POST['db-password']; $x32e95=e2installer__usable_databases($ycf1e8,$oee11c,$m5f4dc); if ($x32e95) die (implode('|',$x32e95)); die; } function sbef8($o7d0db,$ncb5e1){ $h076ae['update-failed-at']=$o7d0db; @t6e52(USER_FOLDER.'update-state.psa',serialize($h076ae)); header('HTTP/1.1 503 Service Unavailable'); die ('Update stuck at v'. $o7d0db .' with message:<br /><br />' .$ncb5e1); } function e2s_update_perform(){ global$_instance,$_model,$settings,$_config; $dd98a0=max((int) ($_instance['version']), 2285); if($_instance['version']==E2_VERSION){ l4930(); die; } $h076ae=@unserialize(scdf0(USER_FOLDER. '/update-state.psa')); if (isset ($h076ae['update-failed-at'])) { $dd98a0=$h076ae['update-failed-at']-1; @unlink(USER_FOLDER. '/update-state.psa'); } if ($dd98a0 < 2344){ @unlink(USER_FOLDER. 'last-update.psa'); e2_instantiate(2344); } if ($dd98a0 < 2411){ r0738( "ALTER TABLE `". $settings['db']['table_prefix']."Notes` ". "ADD `FormatterID` VARCHAR( 32 ) DEFAULT 'calliope' NOT NULL AFTER `Text`" ); e2_drop_all_kinds_of_cache(); e2_instantiate(2411); } if ($dd98a0 < 2425){ r0738( "ALTER TABLE `". $settings['db']['table_prefix']."Notes` ". "CHANGE `URLName` `URLName` VARCHAR( 32 ) DEFAULT '' NOT NULL" ); e2_drop_all_kinds_of_cache(); e2_instantiate(2425); } if ($dd98a0 < 2560){ e2_drop_all_kinds_of_cache(); } if ($dd98a0 < 2587){ dc5a6('caches/*'); rmdir('caches'); @zaf42(CACHES_FOLDER); } if ($dd98a0 < 2609){ ef1ac('Aliases'); e2_instantiate(2609); } if ($dd98a0 < 2610){ r0738( "ALTER TABLE `". $settings['db']['table_prefix']."Notes` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `FormatterID`" ); e2_instantiate(2610); } if ($dd98a0 < 2661){ @zaf42(BACKUP_FOLDER); e2_drop_all_kinds_of_cache(); } if ($dd98a0 < 2688){ foreach(array_keys($_model) as $yd2ffa){ r0738( "SHOW TABLE STATUS LIKE '". $settings['db']['table_prefix'].$yd2ffa ."' " ); $n4b43b=a0d6b(); if(count($n4b43b) > 0){ $nd89e2=$n4b43b[0]['Collation']; if ($nd89e2!='utf8_general_ci'){ r0738( "ALTER TABLE `". $settings['db']['table_prefix'].$yd2ffa ."` ". "CONVERT TO CHARACTER SET utf8 COLLATE utf8_general_ci" ); } } } e2_instantiate(2688); e2_drop_all_kinds_of_cache(); } if ($dd98a0 < 2691){ $settings=e2_utf8_version_of_array_($settings); if (!@t6e52(USER_FOLDER.'settings.psa',serialize($settings))) { k8a40($_strings['er--cannot-save-data'],E2E_PERMISSIONS_ERROR); } e2_drop_all_kinds_of_cache(); } if ($dd98a0 < 2750){ ef1ac('Actions'); r0738( "ALTER TABLE `". $settings['db']['table_prefix']."Actions` ". "ADD UNIQUE INDEX (`EntityID`, `Stamp`);" ); e2_instantiate(2750); } if ($dd98a0 < 2753){ r0738( "ALTER TABLE `". $settings['db']['table_prefix']."Notes` ". "ADD INDEX (`Stamp`);" ); r0738( "ALTER TABLE `". $settings['db']['table_prefix']."Aliases` ". "ADD INDEX (`Alias`);" ); r0738( "ALTER TABLE `". $settings['db']['table_prefix']."Aliases` ". "ADD INDEX (`EntityID`);" ); r0738( "ALTER TABLE `". $settings['db']['table_prefix']."Comments` ". "ADD INDEX (`NoteID`);" ); } if ($dd98a0 < 2821){ if (@$settings['template']==''){ $settings['template']='classical'; } } if ($dd98a0 < 2850){ @unlink(CACHES_FOLDER.'index.xml'); } if ($dd98a0 < 2862){ r0738( "ALTER TABLE `". $settings['db']['table_prefix']."Aliases` ". "ADD `EntityType` VARCHAR( 1 ) DEFAULT '' NOT NULL AFTER `ID`" ); r0738( "UPDATE `". $settings['db']['table_prefix']."Aliases` ". "SET `EntityType` = 'n'" ); r0738( "ALTER TABLE `". $settings['db']['table_prefix']."Keywords` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `Keyword`" ); r0738( "ALTER TABLE `". $settings['db']['table_prefix']."Notes` ". "DROP `IP` " ); e2_instantiate(2862); } if ($dd98a0 < 2870){ if (@isset ($settings['appearance']['hot_frontpage'])) { unset($settings['appearance']['hot_frontpage']); } e2_instantiate(2870); } if ($dd98a0 < 2896){ if (@isset ($settings['db']['table_prefix'])) { if($settings['db']['table_prefix'] != @$_config['db_table_prefix']) { die ('You’ve been using a database with a table prefix “'. $settings['db']['table_prefix'] .'”. Now this should be set in the configuration. Please add the following line to the file user/config.php:<br /><br />$_config[\'db_table_prefix\'] = \''. $settings['db']['table_prefix'] .'\';<br /><br />Then refresh this page.'); } else { unset($settings['db']['table_prefix']); } } e2_instantiate(2896); } if ($dd98a0 < 2921){ $settings['template']='plain'; } $s260ca=true; if ($dd98a0 < 2963){ $s260ca=$s260ca && r0738( "ALTER TABLE `". $_config['db_table_prefix']."Notes` ". "CHANGE `Text` `Text` TEXT DEFAULT ''" ); $s260ca=$s260ca && r0738( "ALTER TABLE `". $_config['db_table_prefix']."Comments` ". "CHANGE `Text` `Text` TEXT DEFAULT ''" ); $s260ca=$s260ca && r0738( "ALTER TABLE `". $_config['db_table_prefix']."Comments` ". "CHANGE `Reply` `Reply` TEXT DEFAULT ''" ); $s260ca=$s260ca && r0738( "ALTER TABLE `". $_config['db_table_prefix']."Keywords` ". "CHANGE `Description` `Description` TEXT DEFAULT ''" ); if ($s260ca)e2_instantiate(2963); } $s260ca=true; if ($dd98a0 < 2969){ $s260ca=$s260ca && r0738( "ALTER TABLE `". $_config['db_table_prefix']."Notes` ". "CHANGE `Text` `Text` TEXT" ); $s260ca=$s260ca && r0738( "ALTER TABLE `". $_config['db_table_prefix']."Comments` ". "CHANGE `Text` `Text` TEXT" ); $s260ca=$s260ca && r0738( "ALTER TABLE `". $_config['db_table_prefix']."Comments` ". "CHANGE `Reply` `Reply` TEXT" ); $s260ca=$s260ca && r0738( "ALTER TABLE `". $_config['db_table_prefix']."Keywords` ". "CHANGE `Description` `Description` TEXT" ); if ($s260ca)e2_instantiate(2969); } @t6e52(USER_FOLDER.'settings.psa',serialize($settings)); if ($s260ca){ e2_instantiate(E2_VERSION); if (oe852()) { k8a40(e2l_get_string('gs--updated-successfully', array ( 'from' => 'v'. $dd98a0, 'to' => 'v'. $_instance['version'], )), E2E_MESSAGE); } e2_go_to(); } else { $errors=dec07(); foreach($errors['each'] as $ncb5e1){ echo '<p>'. $ncb5e1['description'] .'</p>'; } } die; } function u0f7c(){ global$settings,$_db,$_db_error; if (@$_db['connected']!==true){ $od7909=$settings['db']['passw']; if ( ( $v3d801=@mysqli_connect( $settings['db']['server'], $settings['db']['user_name'], $od7909 ) ) !== false ){ mysqli_close($v3d801); if(__LOG)__log('DB: storing password in a new way'); $od7909=x1305($od7909); $settings['db']['passw']=$od7909; @t6e52(USER_FOLDER.'settings.psa',serialize($settings)); } $od7909=kee85($od7909); if ( ( $_db['link'] = @mysqli_connect( $settings['db']['server'], $settings['db']['user_name'], $od7909 ) ) !== false ){ if(mysqli_select_db($_db['link'],$settings['db']['name'])) { $_db_error=DB_OK; $_db['connected']=true; return true; } else { $_db_error=DB_CANNOT_FIND; return false; } } else { $_db_error=DB_CANNOT_CONNECT; return false; } } else { $_db_error=DB_OK; return true; } } function r0738($y7694f){ global $b11755,$_db,$_db_error,$_strings; if(__LOG)__log('DB: query <'. $y7694f .'>'); $w9b54f=g7f78(); @$b11755 ++; if (u0f7c()) { $v8e815='utf8'; if ( version_compare(mysqli_get_server_info($_db['link']), '4.1','>=') and @$_db['latest_setnames']!=$v8e815 ){ mysqli_query($_db['link'],"SET NAMES ". $v8e815); $_db['latest_setnames']=$v8e815; } if($_db['result']=mysqli_query($_db['link'],$y7694f)) { if(__LOG)__log('DB: done in '. round(g7f78()-$w9b54f,3)); $_db_error=DB_OK; return true; } else { k8a40($_strings['er--error-in-query']. ': <br /><code>'.nl2br($y7694f).'</code><br />'. mysqli_error($_db['link']), E2E_DATABASE_ERROR); $_db_error=DB_QUERY_ERROR; return false; } } else { if($_db_error==DB_CANNOT_FIND){ if(__LOG)__log('DB: cannot find db'); k8a40($_strings['er--cannot-find-db'],E2E_DATABASE_ERROR); } elseif($_db_error==DB_CANNOT_CONNECT){ if(__LOG)__log('DB: cannot connect to db'); k8a40($_strings['er--cannot-connect-to-db'],E2E_DATABASE_ERROR); } else { if(__LOG)__log('DB: db error '. $_db_error); k8a40($_strings['er--error-occurred'].' ('. $_db_error .')',E2E_DATABASE_ERROR); } return false; } } function a0d6b($k599dc=MYSQLI_ASSOC){ global$_db; $v2cb9d=array(); while ($g0cc17=@mysqli_fetch_array($_db['result'],$k599dc)) { foreach ($g0cc17 as $c865c0 => $s4921c){ if(is_string($s4921c)) { $g0cc17[$c865c0]=$s4921c; } } $v2cb9d[] = $g0cc17; } return $v2cb9d; } function i7928($xb45cf){ global$_db; u0f7c(); return mysqli_real_escape_string($_db['link'],$xb45cf); } function jb488(){ echo '<pre>'; echo 'Sifting backups...<br>'; $p10ae9=array(); foreach(glob(BACKUP_FOLDER. '*.sql') as $e8c7dd){ if(preg_match('/^backup\-(\d+)\-(\d+)\-(\d+)\-at\-(\d+)\-(\d+)\-(\d+)\.sql$/is',basename($e8c7dd),$r9c28d)) { list (, $i41529,$v6f8f5,$v8277e,$p2510c,$c865c0,$n03c7c)=$r9c28d; $h96b8c=gmmktime($p2510c,$c865c0,$n03c7c,$v6f8f5,$v8277e,$i41529); $p10ae9[$h96b8c]=$e8c7dd; } } if(count($p10ae9) > 3){ echo 'More than 3 backups, time to sift...<br>'; $q536a1=-1; $ff46c9=array (SECONDS_IN_A_MINUTE,SECONDS_IN_AN_HOUR,SECONDS_IN_A_DAY, -1); $c865c0=0; foreach(array_reverse($p10ae9,true) as $h96b8c => $e8c7dd){ echo '-> '. $e8c7dd .' ('. gmdate('r',$h96b8c) .')<br>'; if ($q536a1 == -1){ echo '   latest, leave<br>'; $q536a1=$h96b8c; } elseif ($ff46c9[$c865c0] == -1){ echo '   too old, remove<br>'; unlink($e8c7dd); } else { if ($q536a1-$h96b8c < $ff46c9[$c865c0]) { echo '   no need (not long ago), remove<br>'; unlink($e8c7dd); } else { $c865c0 ++; echo '   ok, leave, set interval to '. $ff46c9[$c865c0] .'<br>'; $q536a1=$h96b8c; } } } } else { echo 'No need to sift<br>'; } echo '</pre>'; return; } function e2s_dump(){ global$_model,$_db,$_config; if (u0f7c()) { if($_db['link']) { $d68720=time() - (SECONDS_IN_A_DAY); r0738( "DELETE FROM `". $_config['db_table_prefix']."Actions` ". "WHERE (`Stamp` < ". (time() - (SECONDS_IN_A_DAY*7)) ." AND `HitCount` <= 1) ". "OR (`Stamp` < ". (time() - (SECONDS_IN_A_MONTH)) ." AND `HitCount` <= 5)". "OR (`Stamp` < ". (time() - (SECONDS_IN_A_YEAR)) ." AND `HitCount` <= 10)" ); $c9ab2e=array(); foreach(array_keys($_model) as $vaab9e){ $c9ab2e[] = $_config['db_table_prefix'].$vaab9e; } e2_backup( $_db['link'], $c9ab2e, BACKUP_FOLDER .'backup-'.gmdate('Y-m-d-\a\t-H-i-s').'.sql' ); jb488(); die ('Done'); } } die ('Could not backup'); } function e2ali__alias_from_title_($s36cd3){ global$_config; $e3e891=$s36cd3; if(array_key_exists('autoreplace_for_aliases',$_config)) { $e3e891=strtr( $e3e891, $_config['autoreplace_for_aliases'] ); } $e3e891=e2l_transliterate($e3e891); $e3e891=str_replace('\'','',$e3e891); $e3e891=str_replace('’','',$e3e891); $e3e891=str_replace(chr(146),'',$e3e891); $r17901=''; for ($c865c0=0; $c865c0 < strlen($e3e891); ++ $c865c0){ if ( (ord($e3e891[$c865c0]) >= 48 and ord($e3e891[$c865c0]) <= 57) or (ord($e3e891[$c865c0]) >= 65 and ord($e3e891[$c865c0]) <= 90) or (ord($e3e891[$c865c0]) >= 97 and ord($e3e891[$c865c0]) <= 122) or 0 ){ $r17901.=$e3e891[$c865c0]; } else { $r17901.='-'; } } $r17901=preg_replace('/\-+/','-',$r17901); $r17901=trim($r17901,'-'); $r17901=strtolower($r17901); if ($r17901=='-')$r17901=''; return $r17901; } function e2_aliasrec_of_alias_($p72487){ global$_config; if (!$p72487) return false; if (r0738( "SELECT * FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `Alias` = '" .$p72487. "' ". "ORDER BY Stamp LIMIT 1" )) { $result=a0d6b(); if(count($result)==1){ return$result[0]; } } } function e2_active_alias_for_page_($b89111,$ydffc4){ global$_config,$_e2_active_aliases; if ($ydffc4){ if ( is_array($_e2_active_aliases) and array_key_exists($b89111.$ydffc4,$_e2_active_aliases) ) { return @$_e2_active_aliases[$b89111.$ydffc4]; } else { if (r0738( "SELECT `Alias` ". "FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `EntityType` = '". $b89111 ."' ". "AND `EntityID` = ". $ydffc4 ." ". "ORDER BY `Stamp` DESC LIMIT 1" )) { $result=a0d6b(); $p72487=$result[0]['Alias']; } if (!$p72487 and $b89111==ENTITY_TYPE_TAG){ if (r0738( "SELECT OriginalAlias FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE ID = '". ((int)$ydffc4)."'") ) { $result=a0d6b(); $p72487=$result[0]['OriginalAlias']; } } $_e2_active_aliases[$b89111.$ydffc4]=$p72487; } return @$_e2_active_aliases[$b89111.$ydffc4]; } } function rd712($v15d61,$b89111,$ydffc4,$s36cd3,$vfb873=1){ if ($v15d61=='set' and (!$b89111 or !$ydffc4)) return false; $r17901=e2ali__alias_from_title_($s36cd3); if ($vfb873 > 1){ $r17901.='-'. $vfb873; } if ( $r17901!='' and $lc45dd=e2_aliasrec_of_alias_($r17901) ) { $n6bae4=$lc45dd['EntityType']; $b1123c=$lc45dd['EntityID']; if ( (($ydffc4 and $b1123c==$ydffc4) and ($b89111 and $n6bae4==$b89111)) or $r17901!=e2_active_alias_for_page_($n6bae4,$b1123c) ) { if ($v15d61=='find'){ return $r17901; } if ($v15d61=='set'){ if (naa79('Aliases', array ( 'ID' => $lc45dd['ID'], 'EntityType' => $b89111, 'EntityID' => $ydffc4, 'Alias' => $r17901, 'Stamp' => time(), ))) { return $r17901; } } } else { return rd712($v15d61,$b89111,$ydffc4,$s36cd3,$vfb873+1); } } else { if ($b89111 and $ydffc4 and $r17901==''){ if(e2_active_alias_for_page_($b89111,$ydffc4)==''){ return ''; } } if ( $b89111==ENTITY_TYPE_TAG and $kd62e3=j8770($r17901) ) { if ($kd62e3['ID']!=$ydffc4){ return rd712($v15d61,$b89111,$ydffc4,$s36cd3,$vfb873+1); } } if ($v15d61=='find'){ return $r17901; } if ($v15d61=='set'){ if (j9943('Aliases', array ( 'EntityType' => $b89111, 'EntityID' => $ydffc4, 'Alias' => $r17901, 'Stamp' => time(), ))) { return $r17901; } } } return ''; } function e2m_note($parameters=array ()) { global$settings,$d57de2,$_config,$_strings; if(__LOG)__log('Note {'); $saad65=$parameters['*note']; $w229c3=$parameters['day-number']; $q80791=-1; if($_config['note_url_slidedown']) { if(__LOG)__log('Slidedown {'); while (1){ if ( $saad65==false or !($saad65['IsVisible'] or oe852()) ) { if ($q80791 == -1){ $q80791=kf9fb( $parameters['year'],$parameters['month'],$parameters['day'] ); } if ($w229c3 > 1){ -- $w229c3; $saad65=@$q80791[$w229c3-1]; continue; } return e2_error404_mode(); } else { break; } } if ($saad65['Stamp'] > time() and !oe852()) { return e2_error404_mode(); } if(__LOG)__log('redirect if necessary'); if ($w229c3!=$parameters['day-number']) { $parameters['day-number']=$w229c3; e2_go_to(t83c8('e2m_note',$parameters)); } if(__LOG)__log('} // Slidedown'); } if ($saad65==false){ return e2_error404_mode(); } $yd58c0=t83c8('e2m_note',$parameters); if($settings['comments']['on']) { d3010( $_strings['nf--comments-on-this-post'], t83c8('e2m_note_comments_rss',$parameters) ); } if(__LOG)__log('Navigation {'); $dfcb08=tcca7($saad65,'prev'); $td0cab=tcca7($saad65,'next'); if ($dfcb08){ $lb3b32['prev-href']=t83c8('e2m_note', array ('*note' => $dfcb08)); $lb3b32['prev-title']=g6f10(htmlspecialchars(jea9c($dfcb08),ENT_NOQUOTES,HSC_ENC)); } if ($td0cab){ $lb3b32['next-href']=t83c8('e2m_note', array ('*note' => $td0cab)); $lb3b32['next-title']=g6f10(htmlspecialchars(jea9c($td0cab),ENT_NOQUOTES,HSC_ENC)); } $lb3b32['title']=$_strings['nm--posts']; $lb3b32['timeline?']=false; $lb3b32['this-title']=g6f10(htmlspecialchars(jea9c($saad65),ENT_NOQUOTES,HSC_ENC)); if(__LOG)__log('}'); if(__LOG)__log('packaging...'); $saad65['_']['_id']=$saad65['ID']; $saad65['_']['_ord']=0; $saad65['_']['_ord_max']=0; $q8e4cd=z6791($saad65); if(__LOG)__log('update read count...'); $mff089=time(); $mff089=$mff089 - ($mff089 % SECONDS_IN_AN_HOUR); j9943( 'Actions', array ( 'EntityID' => $saad65['ID'], 'Stamp' => $mff089, 'HitCount' => 1, ), 'INSERT LOW_PRIORITY', 'ON DUPLICATE KEY UPDATE `HitCount` = `HitCount` + 1' ); $ae35b1=''; $l01a5b=''; $k33ff2=false; $c905f7=false; $i7bae4=''; $gd09b4=''; if(1 or @$settings['comments']['on']) { $i83625=e2_note_cache_filename_with_id_($saad65['_']['_id'] .'-comments'); $b1e8cc=null; if(CACHE_NOTES_COMMENTS and !oe852() and is_file($i83625)) { $b1e8cc=@unserialize(scdf0($i83625)); } if(__LOG)__log('Comments {'); if(is_array($b1e8cc)) { if(__LOG)__log('retrieve cached ctree'); $ae35b1=$b1e8cc; } else { if(__LOG)__log('assemble ctree...'); $ac1fdc=p1baf($saad65['ID'],"ORDER BY `Stamp`"); $za5d49=array(); $g04c25=true; foreach ($ac1fdc as $z8ce4b => $d4032b){ if ($d4032b['IsVisible']) { $d4032b['_']['_id']=$d4032b['ID']; $d4032b['_']['_ord']=$z8ce4b; $d4032b['_']['_ord_max']=count($ac1fdc)-1; $c06d4c=u86f8( $saad65, $d4032b, $z8ce4b+1 ); if ($c06d4c['new?'] and $g04c25){ $c06d4c['first-new?']=true; $g04c25=false; } $za5d49[] = $c06d4c; } } $ae35b1=$za5d49; if(CACHE_NOTES_COMMENTS and !oe852())t6e52($i83625,serialize($ae35b1)); } if(__LOG)__log('} // Comments'); $l01a5b=t83c8('e2m_note_comments_rss', array ('*note' => $saad65)); if ($q8e4cd['commentable-now?']) { $l80f02=g66aa($saad65); } if (oe852() and cb387($saad65,NOTE_COMMENTABLE_NOW_CONDITIONALLY)) { if ($saad65['IsCommentable']) { $i7bae4['href']=t83c8('e2m_note_flag', array ( '*note' => $saad65, 'flag' => 'IsCommentable', 'value' => 0, )); $i7bae4['text']=$_strings['bt--close-comments-to-post']; } else { $i7bae4['href']=t83c8('e2m_note_flag', array ( '*note' => $saad65, 'flag' => 'IsCommentable', 'value' => 1, )); $i7bae4['text']=$_strings['bt--open-comments-to-post']; } } } if ( oe852() and array_key_exists('new-comments-count',$q8e4cd) and $q8e4cd['new-comments-count'] ) { if(__LOG)__log('mark comments as not new'); e2_drop_caches_for_note_($v21158); naa79('Comments', array ('IsNew' => 0), array ('NoteID' => $saad65['_']['_id'])); } if(__LOG)__log('more work...'); $ra80da=b5421($q8e4cd['text']); $me70c4['class']='note'; $me70c4['title']=jea9c($saad65); $me70c4['pages']=$lb3b32; $me70c4['summary']=$ra80da; $me70c4['notes'] = array ('only' => $q8e4cd); if ($ae35b1) $me70c4['comments']=$ae35b1; if ($l01a5b) $me70c4['comments-rss-href']=$l01a5b; if ($i7bae4) $me70c4['comments-toggle']=$i7bae4; if ($l80f02) $me70c4['form-comment']=$l80f02; if(__LOG)__log('} // Note'); return $me70c4; } function e2m_note_hitinfo($parameters=array ()) { global$_config; $saad65=$parameters['*note']; echo '<table>'; echo '<tr valign="top">'; foreach ( array ('day','week','month','year','ever') as $ma0acf ){ echo '<td>'; echo '<h2>'. $ma0acf.' hits</h2>'; echo '<p>'; $t632a2=time()-f35c3($ma0acf); if (r0738( "SELECT SUM(`HitCount`) HitCount FROM `". $_config['db_table_prefix']."Actions` ". "WHERE `EntityID` = ". $saad65['ID'] ." ". "AND `Stamp` > ". $t632a2 ." ". "GROUP BY `EntityID`" )) { $m9b207=a0d6b(); echo $m9b207[0]['HitCount']; } echo '</p>'; if (r0738( "SELECT n.`ID`, n.`Title`, n.`IsFavourite`, a.`EntityID`, SUM(a.`HitCount`) HitCount ". "FROM `". $_config['db_table_prefix']."Actions` a, ". "`". $_config['db_table_prefix']."Notes` n  ". "WHERE a.`Stamp` > ". $t632a2 ." ". "AND a.`EntityID` = n.`ID` ". "GROUP BY a.`EntityID` ". "ORDER BY `IsFavourite` DESC, HitCount DESC ". "LIMIT 10" )) { echo mysqli_error(); $m9b207=a0d6b(); echo '<h3>Popular</h3>'; foreach ($m9b207 as $n4b43b){ echo '<p><a href="'. $n4b43b['ID']. '">'. $n4b43b['Title'] .'</a> ('. $n4b43b['HitCount'] .')</p>'; } } } die; } function e2m_note_withdraw($parameters=array ()) { global$_strings; $yea59a=$parameters['*note']; if (!$yea59a) return e2_error404_mode(); $yea59a['IsPublished']=0; $yea59a['IsCommentable']=0; $yea59a['IsVisible']=1; $yea59a['Stamp']=time(); $yea59a['IP']=$_SERVER['REMOTE_ADDR']; if($parameters['alias']) { $yea59a['OriginalAlias']=$parameters['alias']; } else { $yea59a['OriginalAlias']=rd712( 'find',ENTITY_TYPE_NOTE,$yea59a['ID'],$yea59a['Title'] ); } e2_drop_caches_for_note_($yea59a['ID']); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); if ($yea59a['IsFavourite']) { @unlink(CACHE_FILENAME_FAVS); } if (naa79('Notes',$yea59a)) { rd712('set',ENTITY_TYPE_NOTE,$yea59a['ID'],''); e2_go_to(t83c8('e2m_draft', array ( 'draft' => $v21158, 'oalias' => $yea59a['OriginalAlias'], ))); } else { l4930(); } } function e2m_note_delete($parameters=array()) { global$_strings; $yea59a=$parameters['*note']; if (!$yea59a) return e2_error404_mode(); $hf91b2=!$yea59a['IsPublished']; if ($hf91b2){ $o72bd7=e2l_get_string('gs--draft-will-be-deleted', array ( 'draft' => htmlspecialchars($yea59a['Title'],ENT_NOQUOTES,HSC_ENC), )); } else { $o72bd7=e2l_get_string('gs--post-will-be-deleted', array ( 'post' => htmlspecialchars($yea59a['Title'],ENT_NOQUOTES,HSC_ENC), )); } $id5d3d=$hf91b2? $_strings['pt--draft-deletion']:$_strings['pt--post-deletion']; $d57529=array ( '.note-id' => $yea59a['ID'], '.is-draft' => (int)$hf91b2, 'note-title' => htmlspecialchars($yea59a['Title'],ENT_COMPAT,HSC_ENC), 'caution-text' => $o72bd7, 'form-action' => t83c8('e2s_note_delete'), 'submit-text' => $_strings['fb--delete'], 'draft?' => (int)$hf91b2, ); $v2cb9d=array ( 'title' => $id5d3d. ': '. htmlspecialchars($yea59a['Title'],ENT_NOQUOTES,HSC_ENC), 'heading' => $id5d3d, 'form' => 'form-note-delete', 'form-note-delete' => $d57529, ); return $v2cb9d; } function e2m_note_flag_favourite($parameters){ global$_config; $parameters['flag']='IsFavourite'; if (w7e6c($parameters)) { $e67142=$parameters; $e67142['value'] = !$parameters['value']; if($parameters['value']==1){ $g99859=t83c8('e2m_note_flag_favourite',$e67142); $g1fa03='on-rehref|'. $g99859; } else { $g99859=t83c8('e2m_note_flag_favourite',$e67142); $g1fa03='off-rehref|'. $g99859; } } else { $g1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($g1fa03); } else { e2_go_to(t83c8('e2m_note',$parameters)); die; } } function e2m_note_flag($parameters){ w7e6c($parameters); if(array_key_exists('draft',$parameters)) { e2_go_to(t83c8('e2m_draft',$parameters)); } else { e2_go_to(t83c8('e2m_note',$parameters)); } die; } function w7e6c($parameters){ $v21158=$parameters['*note']['ID']; if (!is_numeric($v21158)) { return e2_error404_mode(); } e2_drop_caches_for_note_($v21158); if($parameters['flag']=='IsFavourite'){ @unlink(CACHE_FILENAME_FAVS); } $result=naa79('Notes', array ( 'ID' => $v21158, $parameters['flag'] => (int) ($parameters['value']==1), )); return$result; } function e2m_note_use_formatter($parameters){ $v21158=$parameters['*note']['ID']; if (!is_numeric($v21158)) { return e2_error404_mode(); } e2_drop_caches_for_note_($v21158); if (!$parameters['*note']['IsPublished']) { @unlink(CACHE_FILENAME_DRAFTS); } if(in_array($parameters['formatter'], array ('calliope','raw','neasden'))) { $result=naa79('Notes', array ( 'ID' => $v21158, 'FormatterID' => $parameters['formatter'], )); echo 'formatter set to '. $parameters['formatter']; } else { echo 'unknown formatter'; } die; } function e2m_note_edit($parameters=array ()) { return e7dd3('edit',$parameters); } function e7dd3($y60cd8,$parameters=array ()) { global$full_blog_url,$_strings,$_config; $id5d3d=$_strings['pt--new-post']; $sf74f5=$_strings['pt--new-post']; $v21158='new'; $x9763c=$_config['default_formatter']; if ($y60cd8=='edit'){ $yea59a=$parameters['*note']; if (!$yea59a) return e2_error404_mode(); if ($yea59a){ if ($yea59a['IsPublished']) { $sf74f5=$_strings['pt--edit-post']; $k3aa13=''; $p72487=$parameters['alias']; } else { $sf74f5=$_strings['pt--edit-draft']; $k3aa13=rd712( 'find',ENTITY_TYPE_NOTE,$yea59a['ID'],$yea59a['Title'] ); if (@$yea59a['OriginalAlias']) { $p72487=$yea59a['OriginalAlias']; } else { $p72487=$k3aa13; } } } $v21158=$yea59a['ID']; $x9763c=$yea59a['FormatterID']; $id5d3d=jea9c($yea59a); } $t04868=z5d57(); $j77b75=array(); foreach ($t04868 as $ud7df5){ $j77b75[] = $ud7df5['tag']; } $wd2e3e=array(); if ($y60cd8=='edit' and count($j77b75)) { $t04868=sa463($yea59a['ID']); foreach ($t04868 as $ud7df5){ $wd2e3e[] = htmlspecialchars($ud7df5['Keyword'],ENT_NOQUOTES,HSC_ENC); } } $rc93df=array(); foreach ($j77b75 as $ud7df5){ $afd2ef['name']=$ud7df5; $afd2ef['selected?']=in_array($ud7df5,$wd2e3e); $rc93df[] = $afd2ef; } $e9dbb8=''; $wd2e3e=implode(', ',$wd2e3e); if ($wd2e3e)$e9dbb8=$wd2e3e; if ($y60cd8=='write'){ $ic50d0=$_strings['fb--save-and-preview']; } if ($y60cd8=='edit'){ if(array_key_exists('draft',$parameters)) { $ic50d0=$_strings['fb--save-and-preview']; } else { $ic50d0=$_strings['fb--save-changes']; } } $r9c28d=array(); if ($r9c28d=i8447($yea59a['FormatterID'],$yea59a['Text'],'full')) { foreach ($r9c28d as $te3cc9){ if(is_file(PICTURES_FOLDER.$te3cc9)) { if ($bf1210=v291d($te3cc9)) { $size=getimagesize($bf1210); list ($eeaae2,$kb435e)=$size; $b59b51[] = array ( 'name' => $te3cc9, 'thumb' => $full_blog_url .'/'. $bf1210, 'width' => floor($eeaae2/2), 'height' => floor($kb435e/2), ); } } if(is_file(AUDIO_FOLDER.$te3cc9)) { $b59b51[] = array ( 'name' => $te3cc9, 'thumb' => $full_blog_url .'/'. AUDIO_ICON_IMAGE, 'width' => AUDIO_ICON_WIDTH, 'height' => AUDIO_ICON_HEIGHT, ); } } } $v2cb9d['title']=$id5d3d; $v2cb9d['heading']=$sf74f5; $v2cb9d['form']='form-note'; $v2cb9d['form-note'] = array ( '.note-id' => $v21158, '.formatter-id' => $x9763c, '.from' => substr($_SERVER['HTTP_REFERER'],strlen($full_blog_url)+1), '.old-tags-hash' => md5($e9dbb8), '.instant-publish' => 'no', '.action' => $y60cd8, 'form-action' => t83c8('e2s_note_process'), 'form-note-livesave-action' => t83c8('e2j_note_livesave'), 'form-file-upload-action' => t83c8('e2j_file_upload'), 'form-file-remove-action' => t83c8('e2j_file_remove'), 'create:edit?' => (bool) ($y60cd8=='write'), 'title' => htmlspecialchars($yea59a['Title'],ENT_COMPAT,HSC_ENC), 'tags' => $e9dbb8, 'tags-info' => $rc93df, 'text' => htmlspecialchars($yea59a['Text'],ENT_NOQUOTES,HSC_ENC), 'images' => $b59b51, 'all-tags' => $j77b75, 'stamp-formatted' => r5a2f('d.m.Y H:i:s',$yea59a['Stamp'],i0923($yea59a)), 'time' => $yea59a['IsPublished']? array ((int)$yea59a['Stamp'],i0923($yea59a)) : false, 'alias-autogenerated' => $k3aa13, 'alias' => $p72487, 'submit-text' => $ic50d0, ); if ($y60cd8=='edit'){ $v2cb9d['form-note']['delete-href']=t83c8( 'e2m_note_delete', array ('*note' => $yea59a) ); if (!array_key_exists('draft',$parameters)) { $yea59a['_']['_id']=$yea59a['ID']; $yea59a['_']['_ord']=0; $yea59a['_']['_ord_max']=0; $v2cb9d['form-note']['note']=z6791($yea59a); } } return $v2cb9d; } function e2m_write(){ return e7dd3('write'); } function e2s_note_process(){ global$_fp_error,$_strings; $v21158=ra21e(); if (!$v21158){ if($_fp_error==FP_TITLE_OR_TEXT_EMPTY){ k8a40($_strings['er--post-must-have-title-and-text'],E2E_USER_ERROR); } elseif($_fp_error==FP_NO_ID_OR_NEW){ } else { k8a40($_strings['er--error-occurred'].' ('. $_fp_error .')'); } e2_go_to(t83c8('e2m_write')); die; } $saad65=v4627($v21158); if ($saad65['IsPublished']) { e2_go_to(t83c8('e2m_note', array ('*note' => $saad65))); } else { e2_go_to(t83c8('e2m_draft', array ('*note' => $saad65))); } die; } function e2s_note_publish(){ global$_strings,$_config; $v21158=false; if(array_key_exists('note-id',$_POST)) { $v21158=$_POST['note-id']; $yea59a=v4627($v21158); $e82b30=$yea59a['OriginalAlias']; $yea59a=array ( 'ID' => $v21158, 'IsPublished' => 1, 'IsCommentable' => (int)$_config['publish_with_comments_on'], 'IsFavourite' => 0, 'Stamp' => time(), 'IP' => $_SERVER['REMOTE_ADDR'], ); $pb2c6c=ua618(@$_POST['gmt-offset']); if ($pb2c6c){ $yea59a['Offset'] = (int)$pb2c6c['offset']; $yea59a['IsDST'] = (int)$pb2c6c['is_dst']; } e2_drop_caches_for_note_($v21158); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); if (naa79('Notes',$yea59a)) { $p72487=''; if ($e82b30){ $p72487=rd712('set',ENTITY_TYPE_NOTE,$v21158,$e82b30); $yea59a['OriginalAlias']=$p72487; } if ($p72487!=$e82b30){ naa79('Notes',$yea59a); } e2_go_to(t83c8('e2m_note', array ('*note' => $yea59a))); die; } else { l4930(); die; } } e2_go_to(); die; } function e2s_note_delete(){ global$_strings,$_config; $v21158=$_POST['note-id']; $hf91b2=(bool)$_POST['is-draft']; e2_drop_caches_for_note_($v21158); if ($hf91b2){ @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } else { @unlink(CACHE_FILENAME_FAVS); } if (r0738( "DELETE FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `ID` = '".((int)$v21158)."'" )) { r0738( "DELETE FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `EntityID`=". ((int)$v21158) ); r0738( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `NoteID`=". ((int)$v21158) ); if ($hf91b2){ e2_go_to(t83c8('e2m_drafts')); } else { e2_go_to(); } die; } else { e2_go_to(); die; } } function e2j_note_livesave(){ die (ra21e('ajaxresult')); } function z6791($saad65,$z4dd42=array (), $e8698e=false){ global $settings, $_config, $_candy, $_current_tag, $d57de2, $ge5564, $le9bf8, $full_blog_url, $v097cc; $ada497=e2_note_cache_filename_with_id_($saad65['_']['_id']); $xe244c=null; if(CACHE_NOTES and is_file($ada497)) { $xe244c=@unserialize(scdf0($ada497)); } if(__LOG)__log('Notes: package note <'. $saad65['_']['_id'] .'>...'); $ye919a=g7f78(); if(CACHE_NOTES and is_array($xe244c)) { if(__LOG)__log('Notes: retrieve cached ctree'); $uc6827=$xe244c; } else { if(__LOG)__log('Notes: assemle cacheable ctree...'); if(__LOG)__log('Notes: formatter ID = '. $saad65['FormatterID']); $k2bfe4=i154e($saad65['FormatterID'], @$saad65['Text'],'full'); $uc6827['title'] = g6f10(htmlspecialchars(jea9c($saad65),ENT_NOQUOTES,HSC_ENC)); $uc6827['text'] = $k2bfe4['text-final']; $uc6827['format-info'] = $k2bfe4['meta']; $uc6827['time'] = array ((int)$saad65['Stamp'],i0923($saad65)); $uc6827['last-modified'] = array ((int)$saad65['LastModified'],i0923($saad65)); $uc6827['last-ip'] = $saad65['IP']; $uc6827['published?'] = (bool)$saad65['IsPublished']; $uc6827['commentable?'] = (bool) ($saad65['IsCommentable'] && $saad65['IsPublished']); $uc6827['favourite?'] = (bool) ($saad65['IsFavourite'] && $saad65['IsPublished']); $uc6827['visible?'] = (bool) ($saad65['IsVisible'] || !$saad65['IsPublished']); if (!$uc6827['published?'])$uc6827['time']=$uc6827['last-modified']; $w0dff3=ice23($saad65['ID']); $bd57ac=array(); foreach ($w0dff3 as $c865c0 => $yb19ad){ $oe4d23['name']=htmlspecialchars($yb19ad['Keyword'],ENT_NOQUOTES,HSC_ENC); $oe4d23['href']=t83c8('e2m_tag', array ('*tag' => $yb19ad)); $bd57ac[] = $oe4d23; } $uc6827['tags']=$bd57ac; if (@in_array(SYSTEM_LIBRARY_FOLDER. 'jouele/jouele.js',$k2bfe4['meta']['links-required'])) { $uc6827['playlist?']=true; } $c905f7=r254f($saad65['ID']); if ($uc6827['published?']) { $uc6827['comments-count']=$c905f7; $uc6827['your-comment-href'] = ( t83c8('e2m_note_comment', array ('*note' => $saad65)) ); } $xe244c=$uc6827; if(CACHE_NOTES) @t6e52($ada497,serialize($xe244c)); } if ($e8698e){ if(__LOG)__log('Notes: short-track package for caching only'); if(__LOG)__log('Notes: package note done in '. round(g7f78()-$ye919a,3)); return $uc6827; } if(__LOG)__log('Notes: continue with the uncacheable, '. round(g7f78()-$ye919a,3) .' so far...'); $uc6827['commentable-now?']=cb387($saad65); $uc6827['can-be-commentable?']=$settings['comments']['on'] && $uc6827['published?']; if(array_key_exists('comments-count',$uc6827)) { $uc6827['comments-count-text']=e2l_get_string('gs--n-comments', array ( 'number' => $uc6827['comments-count'] )); } foreach ($uc6827['tags'] as $z8ce4b => $s9e366){ $uc6827['tags'][$z8ce4b]['current?'] = (bool) ($uc6827['tags'][$z8ce4b]['name']==$_current_tag); } $f2e88c=$saad65['IsPublished']?'e2m_note':'e2m_draft'; $uc6827['href']=t83c8($f2e88c, array ('*note' => $saad65)); if ($saad65['IsPublished']) { if ($saad65['OriginalAlias']) { $uc6827['href-original']=t83c8('e2m_note', array ('alias' => $saad65['OriginalAlias'])); } else { $e010d9=$saad65; $e010d9['__noalias!']=true; $uc6827['href-original']=t83c8('e2m_note', array ('*note' => $e010d9)); } } $uc6827['comments-link?'] = (bool) ( $saad65['IsPublished'] && ($settings['comments']['on'] && cb387($saad65) or ($uc6827['comments-count'] > 0)) && ('e2m_note'!=$_candy) ); if (oe852()) { $dfe9e2=r254f($saad65['ID'],'new'); $uc6827['new-comments-count']=$dfe9e2; $uc6827['new-comments-count-text']=e2l_get_string('gs--comments-n-new', array ( 'number' => $dfe9e2 )); if ($saad65['IsPublished']) { if ($saad65['IsFavourite']) { $uc6827['favourite-toggle-href']=t83c8( 'e2m_note_flag_favourite', array ('*note' => $saad65,'value' => 0) ); } else { $uc6827['favourite-toggle-href']=t83c8( 'e2m_note_flag_favourite', array ('*note' => $saad65,'value' => 1) ); } } $uc6827['edit-href']=t83c8( 'e2m_note_edit', array ('*note' => $saad65) ); $m9920c=$uc6827['edit-href']; } $uc6827['future?']=$saad65['Stamp'] > time(); if($settings['appearance']['show_sharing_buttons']) { $keb769=$_config['share_to']; $b21bdd='|twitter|facebook|gplus|vkontakte|telegram|'; if (@$_config['share_to_twitter_via']) { $r8d777['twitter']['via']=$_config['share_to_twitter_via']; } if ($uc6827['format-info']['resources-detected'][0]) { $f62933=PICTURES_FOLDER.$uc6827['format-info']['resources-detected'][0]; if(is_file($f62933)) { $b21bdd.='pinterest|'; $r8d777['pinterest']['media']=$full_blog_url .'/'. $f62933; } } $uc6827['shareable?']=false; foreach(explode(',',$keb769) as $i5a9d3){ $i5a9d3=trim($i5a9d3); if(strstr($b21bdd,'|'. $i5a9d3. '|')) { $uc6827['shareable?']=true; $uc6827['share-to'][$i5a9d3]['share?']=true; if ($r8d777[$i5a9d3]) { $uc6827['share-to'][$i5a9d3]['data']=$r8d777[$i5a9d3]; } } } } if (@is_array($z4dd42) and count($z4dd42) > 0){ foreach (array ('title','text') as $m65d3b){ $uc6827[$m65d3b]=preg_replace_callback('/<[^>]+>/isu','hel_savetag',$uc6827[$m65d3b]); foreach ($z4dd42 as $p2510c){ if ($p2510c=='-') continue; $uc6827[$m65d3b]=preg_replace('/(?<=^|\W)('.preg_quote($p2510c,'/').')(?=^$|\W)/iu','<span class="'.CSS_CLASS_HIGHLIGHT.'">$1</span>',$uc6827[$m65d3b]); } $uc6827[$m65d3b]=str_replace('</span> <span class="'.CSS_CLASS_HIGHLIGHT.'">',' ',$uc6827[$m65d3b]); $uc6827[$m65d3b]=qdae3($uc6827[$m65d3b]); } } if(array_key_exists('_',$saad65))$uc6827['_']=$saad65['_']; if(__LOG)__log('Notes: package note done in '. round(g7f78()-$ye919a,3)); return $uc6827; } function v4627($yb80bb){ global$_strings,$_config; if (r0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `ID` = '".$yb80bb."'" )) { $ffa816=a0d6b(); if(count($ffa816) > 0){ return $ffa816[0]; } else { return false; } } else { k8a40($_strings['er--cannot-get-post-from-db'],E2E_DATABASE_ERROR); l4930(); die; } } function tcca7($saad65,$rb4ca4,$h8f888=1){ global$_strings,$_config; $u7ffc4=($rb4ca4=='next')?'>':'<'; $j1dee8=($rb4ca4=='next')?'':'DESC '; if (!oe852()) { $i91d12=' AND `IsVisible`=1'; } if (r0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=". $h8f888 ." AND `Stamp` ".$u7ffc4." '".$saad65['Stamp']."'".@$i91d12." ". "ORDER BY STAMP ".$j1dee8. "LIMIT 1" )) { $ffa816=a0d6b(); if(count($ffa816) > 0) return $ffa816[0]; else return FALSE; } else { k8a40($_strings['er--cannot-get-post-from-db'],E2E_DATABASE_ERROR); l4930(); die; } } function jea9c($saad65){ if ($saad65['Title']) { return $saad65['Title']; } else { return '#'. $saad65['ID']; } } function n50d7($zd5566,$c71860=1){ global$settings,$_config; $jb01a5=$zd5566; $d8b7af='all'; if ('rss'==$zd5566 or !oe852()) { $c25715="AND `IsVisible`=1 "; $d8b7af='visible'; } if ('web'==$zd5566)$jb01a5.='_'.$d8b7af; if ('web'==$zd5566){ $o19ee4=($c71860-1)*$settings['appearance']['notes_per_page']; $jaa9f7=$o19ee4 .', '. $settings['appearance']['notes_per_page']; } if ('rss'==$zd5566){ $jaa9f7=$_config['rss_items']; } if (r0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 " .@$c25715. "ORDER BY `Stamp` DESC ". "LIMIT ". $jaa9f7 )) { $result=a0d6b(); return$result; } else { return false; } } function c82dc($i41529,$v6f8f5){ global$_config; list ($nfc6b2,$o10df4)=x5273($i41529,$v6f8f5); if (!oe852())$hf79b1="`IsVisible`=1 AND "; if (r0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND " .@$hf79b1. "`Stamp` BETWEEN '". $nfc6b2 ."' AND '". $o10df4 ."'" )) { $result=a0d6b(); $l44fde=array(); foreach($result as $i65afd){ if ( ((int)$i41529) .'/'. ((int)$v6f8f5) == r5a2f('Y/n',$i65afd['Stamp'],i0923($i65afd)) ) { $l44fde[] = (int)r5a2f('j',$i65afd['Stamp'],i0923($i65afd)); } } $l44fde=@array_unique($l44fde); sort($l44fde); return $l44fde; } else { return false; } } function lb92c($i41529){ global$_config; list ($s5a603,$ic2b31)=x5273($i41529); if (!oe852())$hf79b1="`IsVisible`=1 AND "; if (r0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND ". @$hf79b1. "`Stamp` BETWEEN '". $s5a603. "' AND '". $ic2b31 ."'" )) { $result=a0d6b(); $jda36c=array(); foreach($result as $i65afd){ if ( ((int)$i41529) == r5a2f('Y',$i65afd['Stamp'],i0923($i65afd)) ) { $jda36c[] = (int)r5a2f('n',$i65afd['Stamp'],i0923($i65afd)); } } $jda36c=@array_unique($jda36c); sort($jda36c); return $jda36c; } else { return false; } } function id864($r8d777){ global$settings,$c71860,$_strings; $y7694f=$r8d777['query']; if (isset ($r8d777['page']) and $r8d777['page'] < 1) return e2_error404_mode(); $rd7e5d=$settings['appearance']['notes_per_page']; $lb3b32=array(); $ofbb44=false; if (isset ($r8d777['page'])) { $c71860=$r8d777['page']; $y7694f.=' LIMIT '.($r8d777['page']-1)*$rd7e5d.', '.$rd7e5d; $n61e23=str_replace('SELECT *','SELECT count(*)',$r8d777['query']); if (r0738($n61e23)) { $result=a0d6b(); $ofbb44=$result[0]['count(*)']; $uae0fe=ceil($ofbb44/$rd7e5d); if ($c71860 > $uae0fe and $c71860!=1){ return e2_error404_mode(); } $lb3b32['count']=$uae0fe; $lb3b32['this']=$c71860; $lb3b32['timeline?']=true; $lb3b32['earlier-title']=$_strings['gs--earlier']; $lb3b32['later-title']=$_strings['gs--later']; $a920fa=$r8d777['parameters']; if ($c71860 < $uae0fe){ $a920fa['page']=$c71860+1; $lb3b32['earlier-href']=t83c8($r8d777['candy'],$a920fa); } if ($c71860 > 1){ $a920fa['page']=$c71860-1; $lb3b32['later-href']=t83c8($r8d777['candy'],$a920fa); } } else { return array (); } } $y4358b=array(); if (r0738($y7694f)) { $result=$we5b87=a0d6b(); if (@$r8d777['query-returns-only-ids']) { $result=array(); foreach ($we5b87 as $saad65){ $saad65=v4627($saad65['ID']); if ($saad65['IsPublished'] and ($saad65['IsVisible'] or oe852())) { $result[] = $saad65; } } } foreach($result as $z8ce4b => $saad65){ $saad65['_']['_id']=$saad65['ID']; $saad65['_']['_ord']=$z8ce4b; $saad65['_']['_ord_max']=count($result)-1; $y4358b[] = z6791($saad65,$r8d777['highlight']); } } else { return array (); } $f05a16=$y4358b; if (!isset ($r8d777['show-all-notes']) or @$r8d777['show-all-notes']!=true){ $f05a16=array_slice($y4358b,0,$rd7e5d); } if ($ofbb44===false)$ofbb44=count($f05a16); if (!count($y4358b) and array_key_exists('nothing',$r8d777)) { $v2cb9d['nothing']=$r8d777['nothing']; } $gcd0fd=array ( 'class', 'superheading', 'heading', 'title', 'search-related-tag', 'related-rss-href', ); foreach ($gcd0fd as $if97bf){ if(array_key_exists($if97bf,$r8d777)) { $v2cb9d[$if97bf]=$r8d777[$if97bf]; } } if ($ofbb44){ $e5cde2=e2l_get_string( 'pt--n-posts', array ('number' => $ofbb44) ); } else { $e5cde2=$_strings['pt--no-posts']; } if(array_key_exists('maximum-notes',$r8d777) and $ofbb44 >= $r8d777['maximum-notes']) { $e5cde2=$_strings['gs--many-posts']; } foreach (array ('title','heading','superheading') as $y4b24c){ if(strstr($r8d777[$y4b24c],'%total%')) { $v2cb9d[$y4b24c]=str_replace('%total%', $e5cde2,$r8d777[$y4b24c]); } } $v2cb9d['notes']=$f05a16; $v2cb9d['pages']=$lb3b32; return $v2cb9d; } function kf9fb($i41529,$v6f8f5,$v8277e=false){ global$_config; list ($z7b314,$ia1f20)=x5273($i41529,$v6f8f5,$v8277e); if (r0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` AND (`Stamp` BETWEEN " .$z7b314. " AND " .$ia1f20. ")". "ORDER BY Stamp" )) { $result=a0d6b(); $fb1bc2=1; $v2cb9d=array(); foreach($result as $i65afd){ if(is_numeric($v8277e)) { $y3f917=((int)$i41529) .'/'. ((int)$v6f8f5) .'/'. ((int)$v8277e) == r5a2f('Y/n/j',$i65afd['Stamp'],i0923($i65afd)); } elseif(is_numeric($v6f8f5)) { $y3f917=((int)$i41529) .'/'. ((int)$v6f8f5) == r5a2f('Y/n',$i65afd['Stamp'],i0923($i65afd)); } else { $y3f917=((int)$i41529) == r5a2f('Y',$i65afd['Stamp'],i0923($i65afd)); } if ($y3f917){ if(is_numeric($v8277e)) { $i65afd['day_number']=$fb1bc2; } $v2cb9d[] = $i65afd; $fb1bc2 ++; } } return $v2cb9d; } else { return false; } } function e2_published_noterec_with_alias_($p72487){ if ($lc45dd=e2_aliasrec_of_alias_($p72487)) { $saad65=v4627($lc45dd['EntityID']); if ($saad65['IsPublished']) return $saad65; } } function e2_published_noterec_with_parameters_($parameters=array ()) { $y39a37=e2_noterec_with_parameters_($parameters); if ($y39a37['IsPublished']) return $y39a37; } function e2_noterec_with_parameters_($parameters=array ()) { global$_config; $saad65=false; $kb5445=false; if (@$parameters['oalias']) $kb5445=$parameters['oalias']; if ($kb5445){ if (r0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `OriginalAlias` = '". $kb5445 ."' ". "AND `IsPublished` = 0" )) { $saad65=a0d6b(); if(count($saad65)==1) { $saad65=@$saad65[0]; if ($saad65) return $saad65; } } } $h67e85=false; if (@$parameters['draft']) $h67e85=$parameters['draft']; if (@$parameters['draft2'])$h67e85=$parameters['draft2']; if ($h67e85){ $saad65=v4627($h67e85); return $saad65; } if (@$parameters['alias']) { if ($lc45dd=e2_aliasrec_of_alias_(@$parameters['alias'])) { if ($lc45dd['EntityType']==ENTITY_TYPE_NOTE){ $saad65=v4627($lc45dd['EntityID']); if ($saad65['IsPublished']) return $saad65; } } } $cc2d18=kf9fb($parameters['year'],$parameters['month'],$parameters['day']); if (@$cc2d18[$parameters['day-number']-1]) { return $cc2d18[$parameters['day-number']-1]; } } function de56b($id5d3d,$l1cb25,$pb2c6c=false){ global$_config; pe2f1(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); $y39a37=array ( 'Title' => i7928($id5d3d), 'Text' => i7928($l1cb25), 'FormatterID' => $_config['default_formatter'], 'OriginalAlias' => rd712('find',ENTITY_TYPE_UNSPECIFIED,'',$id5d3d), 'Stamp' => (int)time(), 'LastModified' => (int)time(), ); if ($pb2c6c and is_array($pb2c6c)) { $y39a37['Offset'] = (int)$pb2c6c['offset']; $y39a37['IsDST'] = (int)$pb2c6c['is_dst']; } if (($y39a37=j9943('Notes',$y39a37)) !== false){ return $y39a37['ID']; } } function ra21e($n98ea6=''){ global$_fp_error,$_config,$_e2utf8__unformat_htmlentity_neasden; $_fp_error=false; $v21158=$id5d3d=$bd57ac=$l1cb25=$vb4960=''; if(array_key_exists('note-id',$_POST)) $v21158=$_POST['note-id']; if(array_key_exists('title',$_POST)) $id5d3d=trim($_POST['title']); if(array_key_exists('tags',$_POST)) $bd57ac=$_POST['tags']; if(array_key_exists('text',$_POST)) $l1cb25=trim($_POST['text'],"\r\n"); if(array_key_exists('old-tags-hash',$_POST)) $vb4960=$_POST['old-tags-hash']; if(is_array($bd57ac))$bd57ac=implode(', ',$bd57ac); $bd57ac=trim($bd57ac); if ($v21158=='new'){ $_e2utf8__unformat_htmlentity_neasden=($_config['default_formatter']=='neasden'); } else { $_e2utf8__unformat_htmlentity_neasden=($_POST['formatter-id']=='neasden'); } $id5d3d=cff7c($id5d3d); $bd57ac=cff7c($bd57ac); $l1cb25=cff7c($l1cb25); $lffa71=$l1cb25; $lffa71=str_replace("\n",'\n'."\n",$lffa71); $lffa71=str_replace("\r",'\r'."\r",$lffa71); if(__LOG)__log('e2fp_note: Text is ['. $lffa71 .'] ('. strlen($l1cb25) .'b)'); $aa6168=m163d(',',$bd57ac,'sort'); $bd57ac=implode(', ',$aa6168); $k65f31=md5($bd57ac); if(array_key_exists('browser-offset',$_POST)) { $pb2c6c=ua618(@$_POST['browser-offset']); } else { $pb2c6c=false; } $td17d3='/^ *(\d{1,2})\.(\d{1,2})\.(\d{2}|\d{4}) +(\d{1,2})\:(\d{1,2})\:(\d{1,2}) *$/'; $m02b37=@$_POST['old-stamp']; $saddfe=@$_POST['stamp']; $p72487=@$_POST['alias']; if ($v21158!='new'){ $y39a37=v4627($v21158); } else { $y39a37=array(); } if ($v21158){ if ($id5d3d!='' and $l1cb25!=''){ if ($v21158=='new'){ if ($v21158=de56b($id5d3d,$l1cb25,$pb2c6c)) { $lc852f=t83c8('e2m_note_edit', array ( '*note' => v4627($v21158), )); $g1fa03='{'. '"status": "created", '. '"id": "'. $v21158 .'", '. '"new-full-url": "'. $lc852f . '"}'; $result=(int)$v21158; } else { $g1fa03='{"status": "error", "message": "Cannot create record ('. mysqli_error(). ')"}'; $result=false; } } else { e2_drop_caches_for_note_($v21158); if (!$y39a37['IsPublished']) { @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } $yea59a=array ( 'ID' => $v21158, 'Title' => $id5d3d, 'Text' => $l1cb25, 'LastModified' => time(), ); if(0){ if ($pb2c6c and is_array($pb2c6c)) { $yea59a['Offset'] = (int)$pb2c6c['offset']; $yea59a['IsDST'] = (int)$pb2c6c['is_dst']; } } if ($m02b37!=$saddfe){ if(preg_match($td17d3,$saddfe,$v6f8f5)) { $h96b8c=gmmktime($v6f8f5[4],$v6f8f5[5],$v6f8f5[6],$v6f8f5[2],$v6f8f5[1],$v6f8f5[3]); $h96b8c -= pb2bf($pb2c6c,$h96b8c); $yea59a['Stamp']=$h96b8c; } else { unset ($h96b8c); } } $r17901=$p72487; if ($p72487){ $va7ff0=$p72487; } elseif (!$y39a37['IsPublished']) { $va7ff0=$id5d3d; } else { $va7ff0=''; } if ($y39a37['IsPublished']) { $r17901=rd712( 'set',ENTITY_TYPE_NOTE,$v21158,$va7ff0 ); $lc852f=t83c8('e2m_note_edit', array ( '*note' => $yea59a, 'alias' => $r17901, )); } else { $c926c6=true; $r17901=rd712('find',ENTITY_TYPE_NOTE,$v21158,$va7ff0); $yea59a['OriginalAlias']=$r17901; $lc852f=t83c8('e2m_note_edit', array ( 'draft' => $v21158, 'is-published' => 0, 'oalias' => $r17901, )); } if (naa79('Notes',$yea59a)) { $g1fa03='{'. '"status": "saved", '. '"new-alias": "'. $r17901 .'", '. '"new-full-url": "'. $lc852f .'"'. '}'; $result=(int)$v21158; } else { $g1fa03='{"status": "error", "message": "Cannot update record ('. mysqli_error(). ')"}'; $result=false; } } if ($k65f31!=$vb4960){ z53f1(array ('NoteID' => $v21158)); foreach ($aa6168 as $oe4d23){ $c70b77=g0188($oe4d23); if (!$c70b77){ $c70b77['ID']=m03de($oe4d23); } r0738( "INSERT INTO `". $_config['db_table_prefix']."NotesKeywords` ". "(`NoteID`, `KeywordID`) ". "VALUES (". ((int)$v21158) .", ". ((int)$c70b77['ID']). ")" ); } } if ( $n98ea6!='ajaxresult' and $result and $_POST['instant-publish']=='yes' ){ $_POST['note-id']=$v21158; e2s_note_publish(); } } else { $g1fa03='{"status":"error", "message": "Title or text is empty"}'; $_fp_error=FP_TITLE_OR_TEXT_EMPTY; $result=false; } } else { $g1fa03='{"status":"error", "message": "No note id/new specified"}'; $_fp_error=FP_NO_ID_OR_NEW; $result=false; } fcc38(t83c8('e2s_dump', array ())); if ($n98ea6=='ajaxresult') return $g1fa03; else return$result; } function tcc02($j92c58){ global$_config; $d8b7af='p1'; if (!oe852()) { $d8b7af='p1v1'; $hf79b1="AND `IsVisible`=1"; } $qd29bb=CACHES_FOLDER.$j92c58 .'-stamp-'. $d8b7af .'.e2time.psa'; if(CACHE_EDGE_TIMEINFO and is_file($qd29bb)) { $result=@unserialize(scdf0($qd29bb)); } if(is_array($result)) { return$result; } else { if ($j92c58=='start'){ r0738( "SELECT Stamp, Offset, IsDST FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 ". $hf79b1 ." ORDER BY Stamp LIMIT 1" ); } elseif ($j92c58=='end'){ r0738( "SELECT Stamp, Offset, IsDST FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 ". $hf79b1 ." ORDER BY Stamp DESC LIMIT 1" ); } $result=a0d6b(); if(count($result)) { $result=array ( 'stamp' => $result[0]['Stamp'], 'timezone' => i0923($result[0]), ); if(CACHE_EDGE_TIMEINFO)t6e52($qd29bb,serialize($result)); return$result; } else { return array (); } } } function i8ca0($x1653c,$k0604c){ global$_config; if (!($x1653c and $k0604c) and !oe852()) { die ('API MISUSE: e2_notes_count_general cannot be called for invisible notes or drafts unsecurely :-('); } if (!is_bool($x1653c) or !is_bool($k0604c)) { die ('API MISUSE: e2_notes_count_general must be called with bool params :-('); } if (!$x1653c and !$k0604c){ die ('API MISUSE: e2_notes_count_general called with nonsensical parameters'); } $qd29bb=CACHES_FOLDER . 'notes-count-p'. (int)$x1653c . ($x1653c ? ('v'. (int)$k0604c):'') . '.txt'; $result=false; if(CACHE_NOTES_COUNTS and is_file($qd29bb)) { $result=@scdf0($qd29bb); } if(is_numeric($result) and $result > 0){ return$result; } else { r0738( "SELECT COUNT(*) As NotesCount FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=". (int)$x1653c. " ". ($x1653c ? ( "AND `IsVisible`=". (int)$k0604c ):"") ); $result=a0d6b(); $result=$result[0]['NotesCount']; if($result){ if(CACHE_NOTES_COUNTS)t6e52($qd29bb,$result); return$result; } else { return null; } } } function b5421($l1cb25){ $ra80da=$l1cb25; $ra80da=str_replace(array ( '<p>','<blockquote>','<ul>','<ol>','<br />', ), "\n",$ra80da); $ra80da=trim(strip_tags($ra80da)); if(strpos($ra80da,"\n")!==false){ $ra80da=substr($ra80da,0,strpos($ra80da,"\n")); $ra80da=trim($ra80da,' :.()'."\n"); } if(preg_match('/^(.{100,}?)[:.!?()]|'."\n".'/s',$ra80da,$r9c28d)) { $ra80da=trim($r9c28d[0],' :.()'."\n"); } if(preg_match('/^(.{150,}?)[:.!?(),]/s',$ra80da,$r9c28d)) { $ra80da=trim($r9c28d[0],' :.()'."\n"); } if(preg_match('/^(.{200,}?)[:.!?(), ]/s',$ra80da,$r9c28d)) { $ra80da=trim($r9c28d[0],' :.()'."\n"); } if(in_array($ra80da[strlen($ra80da)-1], array (',',' '))) { $ra80da=trim($ra80da,', '). '...'; } if(mb_strlen($ra80da) > 250){ $ra80da=mb_substr($ra80da,0,250). '...'; } return $ra80da; } define('DRAFT_PREVIEW_LENGTH',100); function e2m_drafts(){ global$_strings,$_config; if(__LOG)__log('Drafts list: working...'); $oda3ad='LastModified'; $uda48a=null; if(CACHE_DRAFTS and is_file(CACHE_FILENAME_DRAFTS)) { $uda48a=@unserialize(scdf0(CACHE_FILENAME_DRAFTS)); } if(CACHE_DRAFTS and is_array($uda48a)) { if(__LOG)__log('Drafts list: retrieve cached ctree'); } else { if(__LOG)__log('Drafts list: assemle cacheable ctree...'); $uda48a=array(); if(__LOG)__log('Drafts list: select by '. $oda3ad .'...'); if (r0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=0 ". "ORDER BY `". $oda3ad ."` DESC" )) { $result=a0d6b(); $y4358b=array(); foreach($result as $z8ce4b => $y39a37){ $saad65['_']['_id']=$y39a37['ID']; $saad65['_']['_ord']=k; $saad65['_']['_ord_max']=count($result)-1; $saad65['href']=t83c8('e2m_draft', array ('*note' => $y39a37)); $saad65['title']=g6f10(htmlspecialchars(jea9c($y39a37),ENT_NOQUOTES,HSC_ENC)); if (isset ($saad65['image-href'])) unset ($saad65['image-href']); $y39a37['_']['_id']=$y39a37['ID']; $y39a37['_']['_ord']=0; $y39a37['_']['_ord_max']=0; $q8e4cd=z6791($y39a37, array (), true); $r9c28d=null; if ($y39a37['FormatterID']=='neasden'){ $r9c28d=$q8e4cd['format-info']['resources-detected']; } elseif ($y39a37['FormatterID']=='calliope'){ $r9c28d=i8447( $y39a37['FormatterID'],$y39a37['Text'],'full' ); } if ($r9c28d){ $te3cc9=array_shift($r9c28d); if(is_file(PICTURES_FOLDER.$te3cc9)) { if ($bf1210=v291d($te3cc9)) { $size=getimagesize($bf1210); list ($eeaae2,$kb435e)=$size; $saad65['image-href']=$bf1210; $saad65['image-width']=floor($eeaae2/2); $saad65['image-height']=floor($kb435e/2); } } } $saad65['text-fragment']=strip_tags($q8e4cd['text']); $v2ab2d=false; if(mb_strlen($saad65['text-fragment']) > DRAFT_PREVIEW_LENGTH) { $v2ab2d=mb_strpos($saad65['text-fragment'],'.',DRAFT_PREVIEW_LENGTH); } if ($v2ab2d!==false){ $saad65['text-fragment']=mb_substr($saad65['text-fragment'],0,$v2ab2d+1); } $uda48a[] = $saad65; } if(CACHE_DRAFTS)t6e52(CACHE_FILENAME_DRAFTS,serialize($uda48a)); } } if(__LOG)__log('Drafts list: done'); $v2cb9d=array ( 'title' => $_strings['pt--drafts'], 'heading' => $_strings['pt--drafts'], ); if(count($uda48a)) { $v2cb9d['drafts']=$uda48a; } else { $v2cb9d['nothing']=$_strings['gs--no-drafts']; } return $v2cb9d; } function e2m_draft($parameters=array ()) { global$_strings,$d57de2; $saad65=e2_noterec_with_parameters_($parameters); if (!$saad65){ $parameters['alias']=$parameters['oalias']; unset($parameters['oalias']); $saad65=e2_noterec_with_parameters_($parameters); if ($saad65){ $yd58c0=t83c8('e2m_note', array ('*note' => $saad65)); return e2_go_to($yd58c0); } } if (!$saad65) return e2_error404_mode(); $saad65['_']['_id']=$saad65['ID']; $saad65['_']['_ord']=0; $saad65['_']['_ord_max']=0; $q8e4cd=z6791($saad65); $d45513=array ( '.note-id' => $saad65['ID'], 'form-action' => t83c8('e2s_note_publish'), 'submit-text' => $_strings['fb--publish-draft'], ); return array ( 'title' => jea9c($saad65).' ('. $_strings['wd--draft'] .')', 'notes' => array ('only' => $q8e4cd), 'form' => 'form-note-publish', 'form-note-publish' => $d45513, ); } function e2_draft_alias_use_count($u176fe=''){ global$_config; if(__LOG)__log('Drafts: find duplicate OriginalAliases...'); if(CACHE_DRAFTS_ALIAS_USE_COUNTS and is_file(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)) { $pda552=@unserialize(scdf0(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)); } if(CACHE_DRAFTS_ALIAS_USE_COUNTS and is_array($pda552)) { if(__LOG)__log('Drafts: retrieve cached'); } else { if(__LOG)__log('Drafts: assemle cacheable...'); $pda552=array(); if (r0738( "SELECT `OriginalAlias` FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=0 ". "ORDER BY `ID`" )) { $result=a0d6b(); $y4358b=array(); foreach($result as $z8ce4b => $y39a37){ @$pda552[$y39a37['OriginalAlias']] ++; } } if(CACHE_DRAFTS_ALIAS_USE_COUNTS){ t6e52(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS,serialize($pda552)); } } if ($u176fe){ return $pda552[$u176fe]; } else { return $pda552; } } $_url_map=array ( '@build' => 'e2://e2s_build', '@sync' => 'e2://e2s_sync', '@dump' => 'e2://e2s_dump', '@instantiate:version' => 'e2://e2s_instantiate', '@info' => 'e2://e2m_info', '@ajax/::' => 'e2://e2j_::', '@actions/::' => 'e2://e2s_::', '' => 'e2://e2m_frontpage?page=1', ':page' => 'e2://e2m_frontpage', 'rss' => 'e2://e2m_frontpage_rss', ':year' => 'e2://e2m_year', ':year/:month' => 'e2://e2m_month', ':year/:month/:day' => 'e2://e2m_day', 'all' => 'e2://e2m_everything', ':note' => 'e2://e2m_note', ':note/comment' => 'e2://e2m_note_comment', ':note/edit' => 'e2://e2m_note_edit?is_published=1', ':note/favourite' => 'e2://e2m_note_flag_favourite?is_published=1&value=1', ':note/unfavourite' => 'e2://e2m_note_flag_favourite?is_published=1&value=0', ':note/show' => 'e2://e2m_note_flag?is_published=1&flag=IsVisible&value=1', ':note/hide' => 'e2://e2m_note_flag?is_published=1&flag=IsVisible&value=0', ':note/discuss' => 'e2://e2m_note_flag?is_published=1&flag=IsCommentable&value=1', ':note/quiet' => 'e2://e2m_note_flag?is_published=1&flag=IsCommentable&value=0', ':note/withdraw' => 'e2://e2m_note_withdraw?is_published=1', ':note/delete' => 'e2://e2m_note_delete?is_published=1', ':note/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=1', ':note/:unsubscr' => 'e2://e2m_unsubscribe?is_published=1', ':note/hitinfo' => 'e2://e2m_note_hitinfo?is_published=1', ':note/comments-rss' => 'e2://e2m_note_comments_rss', ':note/:comnum' => 'e2://e2m_comment', ':note/:comnum/edit' => 'e2://e2m_comment_edit', ':note/:comnum/important' => 'e2://e2m_comment_flag_ajax?flag=IsFavourite&value=1', ':note/:comnum/usual' => 'e2://e2m_comment_flag_ajax?flag=IsFavourite&value=0', ':note/:comnum/replace' => 'e2://e2m_comment_flag_ajax?flag=IsVisible&value=1', ':note/:comnum/remove' => 'e2://e2m_comment_flag_ajax?flag=IsVisible&value=0', ':note/:comnum/spam' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=1', ':note/:comnum/good' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=0', ':note/:comnum/wipe' => 'e2://e2m_comment_delete', ':note/:comnum/reply/edit' => 'e2://e2m_comment_reply', ':note/:comnum/reply/important' => 'e2://e2m_comment_flag_ajax?flag=IsReplyFavourite&value=1', ':note/:comnum/reply/usual' => 'e2://e2m_comment_flag_ajax?flag=IsReplyFavourite&value=0', ':note/:comnum/reply/replace' => 'e2://e2m_comment_flag_ajax?flag=IsReplyVisible&value=1', ':note/:comnum/reply/remove' => 'e2://e2m_comment_flag_ajax?flag=IsReplyVisible&value=0', ':note/:comnum/reply/delete' => 'e2://e2m_comment_reply_delete', 'drafts' => 'e2://e2m_drafts', 'drafts/:draft' => 'e2://e2m_draft', 'drafts/:draft/edit' => 'e2://e2m_note_edit?is_published=0', 'drafts/:draft/show' => 'e2://e2m_note_flag?is_published=0&flag=IsVisible&value=1', 'drafts/:draft/hide' => 'e2://e2m_note_flag?is_published=0&flag=IsVisible&value=0', 'drafts/:draft/delete' => 'e2://e2m_note_delete?is_published=0', 'drafts/:draft/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=0', 'tags' => 'e2://e2m_tags', 'tags/:tag' => 'e2://e2m_tag?page=1', 'tags/:tag/:page' => 'e2://e2m_tag', 'tags/:tag/rss' => 'e2://e2m_tag_rss', 'tags/:tag/edit' => 'e2://e2m_tag_edit', 'tags/:tag/delete' => 'e2://e2m_tag_delete', 'tags/:tag/pin' => 'e2://e2m_tag_flag_ajax?flag=IsFavourite&value=1', 'tags/:tag/unpin' => 'e2://e2m_tag_flag_ajax?flag=IsFavourite&value=0', 'untagged' => 'e2://e2m_untagged', 'hot' => 'e2://e2m_most_commented', 'selected' => 'e2://e2m_favourites?page=1', 'selected/:page' => 'e2://e2m_favourites', 'found' => 'e2://e2m_found&query=', 'found/:query' => 'e2://e2m_found', 'found/:query/rss' => 'e2://e2m_found_rss', 'new' => 'e2://e2m_write', 'install' => 'e2://e2m_install', 'settings' => 'e2://e2m_settings', 'settings/name' => 'e2://e2m_name_and_author', 'settings/database' => 'e2://e2m_database', 'settings/password' => 'e2://e2m_password', 'settings/timezone' => 'e2://e2m_timezone', 'settings/sessions' => 'e2://e2m_sessions', 'sign-in' => 'e2://e2m_sign_in', 'sign-out' => 'e2://e2m_sign_out', ); $_url_chunks=array ( '\:page' => 'page\-(?P<page>\d+)', '\:year' => '(?P<year>\d{4})', '\:month' => '(?P<month>\d{1,2})', '\:day' => '(?P<day>\d{1,2})', '\:note' => array ( 'all\/(?P<alias>[-a-zA-Z0-9]+)', '(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)', ), '\:draft' => array ( '(?P<oalias2>[-a-zA-Z0-9]+)\/(?P<draft2>\d+)', '(?P<oalias>[-a-zA-Z0-9]+)', '-\/(?P<draft>\d+)', ), '\:comnum' => 'comment\-(?P<comment_number>[0-9]+)', '\:file' => '(?P<file>.*?)', '\:tag' => '(?P<tag_alias>.*?)', '\:query' => '(?P<query>.*?)', '\:version' => '\:(?P<version>\d+)', '\:picture' => '\:(?P<picture>.*?)', '\:unsubscr' => 'unsubscribe\:(?P<unsubscribe_email>.+?)\:(?P<unsubscribe_key>[0-9a-f]{32})', '\:formatter' => '(?P<formatter>.*?)', '\:alias' => '(?P<newalias>.*?)', ); $_url_autoredirects=array ( '/^favo(?:u?)rites(\~.+)?$/i' => 'selected\\1', '/^favo(?:u?)rites\/(.+)/i' => 'selected/\\1', '/^keywords$/i' => 'tags', '/^keywords\/(.*)/i' => 'tags/\\1', '/^everything$/i' => 'all', '/^no\-tags(\~.+)?$/i' => '@untagged\\1', '/^no\-tags\/(.+)/i' => '@untagged/\\1', '/^untagged(\~.+)?$/i' => '@untagged\\1', '/^search\/(.+)/i' => 'found/\\1', '/^(\d{4}\/\d{1,2}\/\d{1,2}\/\d+)\/comments(\/?)$/i' => '\\1', '/^\~(\d+)/i' => 'page-\\1', '/\/?\~(\d+)/i' => '/page-\\1', ); function hb6b0($j572d4){ global$_url_autoredirects,$ca57c1; $j572d4=preg_replace(array_keys($_url_autoredirects),array_values($_url_autoredirects),$j572d4); if(preg_match('/^([0-9]+)[.-]([0-9]+)[.-]([0-9]+)(.*)/',$j572d4,$r9c28d)) { if(2==strlen($r9c28d[3]))$r9c28d[3]='20'.$r9c28d[3]; return ($r9c28d[3].'/'.$r9c28d[2].'/'.$r9c28d[1].$r9c28d[4]); } if(preg_match('/^tags\-rss\/(.*?)\/?$/',$j572d4,$r9c28d)) { $oe4d23=substr($r9c28d[1],strrpos($r9c28d[1],'/')+1); return ('tags/'. $oe4d23.'/rss/'); } return $j572d4; } function q7059(){ global$__synthetic_urls,$_config; $__synthetic_urls=false; if($_config['url_composition']=='auto'){ if(function_exists('apache_get_modules')) { if(in_array('mod_rewrite',apache_get_modules())) { $__synthetic_urls=true; } } } if($_config['url_composition']=='synthetic'){ $__synthetic_urls=true; } } function t83c8($uc48ba,$parameters=array ()) { global$_url_map,$_url_chunks,$_config,$__synthetic_urls,$_protocol,$d57de2,$ca57c1; $tc2bd7=array_flip($_url_map); if ( @$_config['preferred_domain_name'] and $_SERVER['HTTP_HOST']!=$_config['preferred_domain_name'] ) { $d57de2=$_config['preferred_domain_name']; } $j572d4=$_protocol .'://'. $d57de2.$ca57c1 .'/'; $t9c464='e2://'. $uc48ba; if(array_key_exists('page',$parameters)) { $c71860=$parameters['page']; } else { $c71860=1; } if($parameters){ $t9c464.='?'; $c1c61f=array(); $r21711=array(); foreach($parameters as $s3c6e0 => $q2063c){ if ($s3c6e0=='*note'){ $r21711[] = $s3c6e0; $c1c61f[] = e2urls__expand_tricky_parameters_for_note_($q2063c); } if ($s3c6e0=='*tags'){ $r21711[] = $s3c6e0; $c1c61f[] = e2urls__expand_tricky_parameters_for_tags_($q2063c); } if ($s3c6e0=='*tag'){ $r21711[] = $s3c6e0; $c1c61f[] = e2urls__expand_tricky_parameters_for_tags_(array ($q2063c)); } } foreach ($r21711 as $s3c6e0) unset($parameters[$s3c6e0]); foreach ($c1c61f as $m58e2a){ $parameters=array_merge($parameters,$m58e2a); } foreach($parameters as $s3c6e0 => $q2063c) if (!@$s3c6e0[0]=='_'){ if(array_key_exists('\:'. $s3c6e0,$_url_chunks)) { $y93316=$_url_chunks['\:'. $s3c6e0]; if(preg_match_all('/\<(.*?)\>/',$y93316,$r9c28d)) { foreach ($r9c28d[1] as $te3cc9){ if(array_key_exists($te3cc9,$parameters)) { $t9c464.=$te3cc9 .'='. urlencode($parameters[$te3cc9]) .'&'; } } } } else { $t9c464.=$s3c6e0 .'='. urlencode($q2063c) .'&'; } } $t9c464=substr($t9c464,0, -1); } if(0 and array_key_exists($t9c464,$tc2bd7)) { if ($tc2bd7[$t9c464]!='')$j572d4.=$tc2bd7[$t9c464] .'/'; return $j572d4; } else { $u44907=false; foreach ($tc2bd7 as $z45ea8 => $u9ea44){ $gb7365=$z45ea8; $gb7365=preg_quote($gb7365,'/'); if(strstr($z45ea8,'::')) { $gb7365=str_replace('\:\:','(.*)',$gb7365); $gb7365='/^'. $gb7365 .'$/s'; if(preg_match($gb7365,$t9c464,$r9c28d)) { $a0dc02=str_replace('_','-',$r9c28d[1]); $e95a17=str_replace('::',$a0dc02,$u9ea44); if($__synthetic_urls){ $j572d4.=$e95a17 .'/'; } else { $j572d4.='?go='. $e95a17 .'/'; } return $j572d4; } } $zebe09=parse_url($z45ea8); $n2f532=$zebe09['host']; $x54435=false; if ($uc48ba==$n2f532){ $u44907=true; if ($zebe09['query']) { $l22c38=explode('&',$zebe09['query']); foreach ($l22c38 as $i8822b){ list ($s3c6e0,$q2063c)=explode('=',$i8822b); $q2063c=urldecode($q2063c); $s3c6e0=str_replace('_','-',$s3c6e0); if ( array_key_exists($s3c6e0,$parameters) and $parameters[$s3c6e0]!=$q2063c ){ $x54435=true; break; } } } if (!$x54435){ if(preg_match_all('/\:[\-a-z]+/i',$u9ea44,$r9c28d)) { foreach ($r9c28d[0] as $afc413){ $ob0f75=$_url_chunks['\\'. $afc413]; if (!is_array($ob0f75)) { $ob0f75=array ($ob0f75); } $s05f62=$ob0f75[0]; foreach ($ob0f75 as $s05f62){ $qeab03='/\(\?P\<(.*?)\>.*?\)/'; $l4274e=true; if (@preg_match($qeab03,$s05f62,$r9c28d)) { $l4274e=true; for ($c865c0=1; $c865c0 < count($r9c28d); ++ $c865c0){ if (!$parameters[str_replace("_","-",$r9c28d[$c865c0])]) { $l4274e=false; break; } } } if (!$l4274e) continue; $cf9e1e=@preg_replace_callback( $qeab03, function ($r9c28d) use ($parameters){ return$parameters[str_replace("_","-",$r9c28d[1])]; }, $s05f62 ); $cf9e1e=stripslashes($cf9e1e); $fc5d91=str_replace($afc413,$cf9e1e,$u9ea44); break; } $u9ea44=$fc5d91; } } $f15214=array(); if ($u9ea44){ if($__synthetic_urls){ $j572d4.=$u9ea44 .'/'; } else { $f15214[] = 'go='. $u9ea44 .'/'; } } foreach($_GET as $z8ce4b => $s9e366) if(in_array($z8ce4b, array ('result','themeless'))) { $f15214[] = $z8ce4b . ($s9e366? ('='. urlencode($s9e366)) : ''); } if(count($f15214)) { $j572d4.='?'. implode('&',$f15214); } return $j572d4; } } } if ($u44907){ return $j572d4; } else { die ('Cannot compose url for candy '. $uc48ba); } } } function cb7e9($j572d4){ global$_url_map,$_url_chunks,$_config,$__synthetic_urls,$_protocol,$d57de2,$ca57c1; $s196c2=$j572d4; $j572d4=trim($j572d4,'/'); $j572d4=hb6b0($j572d4); $parameters=array(); foreach($_url_map as $b12a24 => $z45ea8){ $id532d=$b12a24; $id532d=preg_quote($id532d,'/'); if(strstr($b12a24,'::')) { $id532d=str_replace('\:\:','(.*)',$id532d); $id532d='/^'. $id532d .'$/s'; if(preg_match($id532d,$j572d4,$r9c28d)) { $m53b9e=str_replace('-','_',$r9c28d[1]); $t9c464=str_replace('::',$m53b9e,$z45ea8); } } elseif(strstr($b12a24,':')) { $v1e380=array(); foreach($_url_chunks as $z8ce4b => $s9e366){ if(is_array($s9e366)) { $v1e380[$z8ce4b]='(?:(?:'. implode(')|(?:',$s9e366) .'))'; } else { $v1e380[$z8ce4b]=$s9e366; } } $id532d=str_replace( array_keys($v1e380), array_values($v1e380), $id532d ); $id532d='/^'. $id532d .'$/s'; if(preg_match($id532d,$j572d4,$r9c28d)) { $t9c464=$z45ea8; foreach ($r9c28d as $s3c6e0 => $q2063c) if (!is_numeric($s3c6e0)) { $s3c6e0=str_replace('_','-',$s3c6e0); $parameters[$s3c6e0]=$q2063c; } } } else { if ($b12a24==$j572d4){ $t9c464=$z45ea8; break; } } } $bfafdd=(bool)$t9c464; if (!$t9c464)$t9c464='e2://e2m_404'; $zebe09=parse_url($t9c464); $uc48ba=$zebe09['host']; if ($zebe09['query']) { $l22c38=explode('&',$zebe09['query']); foreach ($l22c38 as $i8822b){ list ($s3c6e0,$q2063c)=explode('=',$i8822b); $q2063c=urldecode($q2063c); $s3c6e0=str_replace('_','-',$s3c6e0); $parameters[$s3c6e0]=$q2063c; } } $v2cb9d=false; $parameters=e2urls__consolidate_tricky_parameters_($parameters); if ($bfafdd){ if($_config['force_canonical_urls']) { $f95d32=t83c8($uc48ba,$parameters); list ($xa4c3a,$tab96c)=explode('?',$_SERVER['REQUEST_URI'],2); $xa37bf=$_protocol .'://'.$_SERVER['HTTP_HOST'].$xa4c3a; $k5d6ba=$_protocol .'://'.$_SERVER['HTTP_HOST'].urldecode($xa4c3a); $tab96c=explode('&',$tab96c); foreach ($tab96c as $r6c0d0){ list ($s5c5e7, ) = explode('=',$r6c0d0); if ($s5c5e7=='go'){ $xa37bf.='?'. $r6c0d0; $k5d6ba.='?'. urldecode($r6c0d0); } } if ($xa37bf!=$f95d32 and $k5d6ba!=$f95d32){ e2_go_to($f95d32); } } if(is_callable($uc48ba)) { $v2cb9d=array ($uc48ba,$parameters); } else { $v2cb9d=array (null, array ()); } } else { $v2cb9d=array (null, array ()); } return $v2cb9d; } function e2urls__expand_tricky_parameters_for_note_($y39a37){ global $ca57c1,$_config; if (!isset ($y39a37['IsPublished'])) { return array (); } if (!$y39a37['IsPublished']) { if ($y39a37['OriginalAlias']==''){ $parameters['draft']=$y39a37['ID']; } elseif(e2_draft_alias_use_count($y39a37['OriginalAlias']) == 1){ $parameters['oalias']=$y39a37['OriginalAlias']; } else { $parameters['draft2']=$y39a37['ID']; $parameters['oalias2']=$y39a37['OriginalAlias']; } $parameters['is-published']=0; return$parameters; } $parameters['is-published']=1; $yb80bb=$y39a37['ID']; $h96b8c=$y39a37['Stamp']; $pb2c6c=i0923($y39a37); if (!isset ($y39a37['__noalias!'])) { if (isset ($y39a37['alias'])) { $parameters['alias']=$y39a37['alias']; } else { $parameters['alias']=e2_active_alias_for_page_(ENTITY_TYPE_NOTE,$y39a37['ID']); } } if($parameters['alias']) return$parameters; list ($i41529,$v6f8f5,$v8277e)=explode('/', r5a2f('Y/m/d',$h96b8c,$pb2c6c) ); $parameters['year']=$i41529; $parameters['month']=$v6f8f5; $parameters['day']=$v8277e; if (isset ($y39a37['day_number'])) { $parameters['day-number']=$y39a37['day_number']; } else { list ($kd9d0f, ) = x5273($i41529,$v6f8f5,$v8277e); if (r0738( "SELECT `ID`, `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND (`Stamp` BETWEEN " .$kd9d0f. " AND " .$h96b8c. ") ". "ORDER BY `Stamp`" )) { $result=a0d6b(); $fb1bc2=1; foreach($result as $i65afd){ if ( $i41529.'/'.$v6f8f5.'/'.$v8277e == r5a2f('Y/m/d',$i65afd['Stamp'],i0923($i65afd)) ) { if ($i65afd['ID']==$yb80bb){ $m444bc=1; break; } $fb1bc2 ++; } } if (@$m444bc!=1){ header('HTTP/1.1 503 Service Unavailable'); die ('<big style="background: #a00; color: #ccc; padding: .1em .33em">CANDIDATES_ENUMERATION_FAILED</big>'); } } $parameters['day-number']=$fb1bc2; } return$parameters; } function e2urls__expand_tricky_parameters_for_tags_($w0dff3){ $m9299d=array(); $parameters=array(); foreach ($w0dff3 as $yb19ad){ $p72487=''; if (!isset ($yb19ad['__noalias!'])) { if (isset ($yb19ad['tag-alias'])) { $p72487=$yb19ad['tag-alias']; } else { $p72487=e2_active_alias_for_page_(ENTITY_TYPE_TAG,$yb19ad['ID']); } } $m9299d[] = $p72487? $p72487:$yb19ad['OriginalAlias']; } if(count($w0dff3)) { $parameters['tag-alias']=implode(',',$m9299d); } return$parameters; } function e2urls__consolidate_tricky_parameters_($parameters){ if ( @$parameters['alias'] or ( @$parameters['year'] and @$parameters['month'] and @$parameters['day'] and @$parameters['day-number'] ) ) { $parameters['*note']=e2_published_noterec_with_parameters_($parameters); } if ( @$parameters['oalias'] or @$parameters['draft'] or @$parameters['oalias2'] or @$parameters['draft2'] ) { $parameters['*note']=e2_noterec_with_parameters_($parameters); } if ( @$parameters['tag-alias'] ) { $parameters['*tags']=e2_tagrecs_with_parameters_($parameters); if(count($parameters['*tags']) == 1){ $parameters['*tag']=$parameters['*tags'][0]; } } return$parameters; } function e2m_tags(){ global$_strings; $v2cb9d['title']=$_strings['pt--tags']; $v2cb9d['heading']=$_strings['pt--tags']; $bd57ac=z5d57(); if(count($bd57ac)==0){ $v2cb9d['nothing']=$_strings['gs--no-tags']; } return $v2cb9d; } function e2m_tag($parameters=array ()) { global $settings, $_config, $_current_tag, $_strings, $c71860,$full_blog_url; if(__LOG)__log('Tag {'); if(array_key_exists('*tags',$parameters)) { $y59aeb=$parameters['*tags']; } if (!$y59aeb[0]) return e2_error404_mode(); $ud7df5=$y59aeb[0]; $l7186e=$parameters['tag-alias']; if(count($y59aeb)==1){ $_current_tag=$ud7df5['Keyword']; } $c71860=$parameters['page']; $rc2b7b=$_config['db_table_prefix']; $rd7e5d=$settings['appearance']['notes_per_page']; foreach ($y59aeb as $s9e366) if ($s9e366){ $y56790[] = "`". $rc2b7b."NotesKeywords`.KeywordID=". $s9e366['ID']; } $y56790=implode(' OR ',$y56790); $hf79b1='AND `IsVisible`=1'; if (oe852())$hf79b1=''; $y76595=( "COUNT(*) as KeywordsCount ". "FROM `". $rc2b7b."Notes` ". "INNER JOIN `". $rc2b7b."NotesKeywords` ". "ON `". $rc2b7b."NotesKeywords`.NoteID=`". $rc2b7b."Notes`.ID ". "WHERE `IsPublished`=1 AND (". $y56790 .") ". $hf79b1 ." ". "GROUP BY `". $rc2b7b."Notes`.`ID` ". "HAVING KeywordsCount=". count($y59aeb) ); $yd3890=( "SELECT DISTINCT `". $rc2b7b."Notes`.*, ". $y76595 ." ". "ORDER BY `". $rc2b7b."Notes`.`Stamp` DESC ". "LIMIT ". ($c71860-1)*$rd7e5d .", ". $rd7e5d ); $o1b037=( "SELECT DISTINCT `". $rc2b7b."Notes`.ID, ". $y76595 ); $lb3b32=array(); if (r0738($o1b037)) { $result=a0d6b(); $ofbb44=count($result); $uae0fe=ceil($ofbb44/$rd7e5d); $lb3b32['timeline?']=true; $lb3b32['count']=$uae0fe; $lb3b32['this']=$c71860; $lb3b32['earlier-title']=$_strings['gs--earlier']; $lb3b32['later-title']=$_strings['gs--later']; $a920fa=$parameters; if ($c71860 < $uae0fe){ $a920fa['page']=$c71860+1; $lb3b32['earlier-href']=t83c8('e2m_tag',$a920fa); } if ($c71860 > 1){ $a920fa['page']=$c71860-1; $lb3b32['later-href']=t83c8('e2m_tag',$a920fa); } } if ($ofbb44==0 and !oe852()) { return e2_error404_mode(); } if (r0738($yd3890)) { $result=a0d6b(); foreach($result as $z8ce4b => $saad65){ $saad65['_']['_id']=$saad65['ID']; $saad65['_']['_ord']=k; $saad65['_']['_ord_max']=count($result)-1; $y4358b[] = z6791($saad65); } if(count($result)==0){ if ($c71860!=1) return e2_error404_mode(); } } if(count($y59aeb)==1){ if (oe852()) { $j97a59['edit-href']=t83c8( 'e2m_tag_edit', array ('tag-alias' => $l7186e) ); } if (''!=$ud7df5['Description']) { $k2bfe4=ob7f1($ud7df5['Description'],'full'); $s67daf=$k2bfe4['text-final']; $j97a59['description']=$s67daf; $j97a59['description-format-info']=$k2bfe4['meta']; } $h3ad42=t83c8('e2m_tag_rss', array ('tag-alias' => $l7186e)); d3010( $_strings['pt--posts-tagged'] .': '. htmlspecialchars($ud7df5['Keyword'],ENT_NOQUOTES,HSC_ENC), $h3ad42 ); } $p96963=( e2l_get_string('pt--n-posts', array ('number' => $ofbb44)). ' '. $_strings['gs--tagged'] ); $sf74f5=array(); foreach ($y59aeb as $s9e366){ $sf74f5[] = $s9e366['Keyword']; } $sf74f5=implode(', ',$sf74f5); $v2cb9d=array ( 'title' => $p96963 .': '. $sf74f5, 'superheading' => $p96963, 'heading' => $sf74f5, 'pages' => $lb3b32, 'notes' => $y4358b, ); if(count($y59aeb)==1){ $v2cb9d['tag']=$j97a59; $v2cb9d['related-rss-href']=$h3ad42; if (oe852()) { $v2cb9d['related-edit-href']=$j97a59['edit-href']; $v2cb9d['related-edit-title']=$_strings['tt--edit-tag']; } } if(__LOG)__log('} // Tag'); return $v2cb9d; } function e2m_tag_edit($parameters=array()) { global$_strings; if(array_key_exists('*tag',$parameters)) { $ud7df5=$parameters['*tag']; } if (!$ud7df5) return e2_error404_mode(); $r9c28d=array(); if ($r9c28d=i8447('neasden',$ud7df5['Description'],'full')) { foreach ($r9c28d as $te3cc9){ if(is_file(PICTURES_FOLDER.$te3cc9)) { if ($bf1210=v291d($te3cc9)) { $b59b51[] = array ('name' => $te3cc9,'thumb' => $bf1210); } } if(is_file(AUDIO_FOLDER.$te3cc9)) { $b59b51[] = array ('name' => $te3cc9,'thumb' => DEFAULTS_FOLDER.'audio.png'); } } } $ycd831=array ( '.tag-id' => $ud7df5['ID'], 'form-action' => t83c8('e2s_tag_edit'), 'submit-text' => $_strings['fb--save-changes'], 'tag' => htmlspecialchars($ud7df5['Keyword'],ENT_COMPAT,HSC_ENC), 'urlname' => htmlspecialchars($parameters['tag-alias'],ENT_COMPAT,HSC_ENC), 'description' => htmlspecialchars($ud7df5['Description'],ENT_COMPAT,HSC_ENC), 'images' => $b59b51, 'favourite?' => (bool)$ud7df5['IsFavourite'], 'delete-href' => t83c8('e2m_tag_delete', array ('*tag' => $ud7df5)), ); $v2cb9d=array ( 'title' => $_strings['pt--tag-edit'] .': '. $ud7df5['Keyword'], 'heading' => $_strings['pt--tag-edit'], 'form' => 'form-tag', 'form-tag' => $ycd831, ); return $v2cb9d; } function e2m_tag_flag_ajax($parameters){ if (i2e88($parameters)) { $e67142=$parameters; $e67142['value'] = !$parameters['value']; if($parameters['value']==1){ $g99859=t83c8('e2m_tag_flag_ajax',$e67142); $g1fa03='on-rehref|'. $g99859; } else { $g99859=t83c8('e2m_tag_flag_ajax',$e67142); $g1fa03='off-rehref|'. $g99859; } } else { $g1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($g1fa03); } else { e2_go_to(t83c8('e2m_tag',$parameters)); die; } } function i2e88($parameters){ if(array_key_exists('*tag',$parameters)) { $ud7df5=$parameters['*tag']; } if (!$ud7df5) return e2_error404_mode(); @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); $result=naa79('Keywords', array ( 'ID' => $ud7df5['ID'], $parameters['flag'] => (int) ($parameters['value']==1), )); return$result; } function e2m_tag_delete($parameters=array()) { global$_strings; if(array_key_exists('*tag',$parameters)) { $ud7df5=$parameters['*tag']; } if (!$ud7df5) return e2_error404_mode(); $zecc14=array ( '.tag-id' => $ud7df5['ID'], 'caution-text' => e2l_get_string('gs--tag-will-be-deleted-notes-remain', array ( 'tag' => htmlspecialchars($ud7df5['Keyword'],ENT_COMPAT,HSC_ENC) )), 'tag' => htmlspecialchars($ud7df5['Keyword'],ENT_COMPAT,HSC_ENC), 'form-action' => t83c8('e2s_tag_delete'), 'submit-text' => $_strings['fb--delete'], ); $v2cb9d=array ( 'title' => $_strings['pt--tag-delete'] .': '. $ud7df5['Keyword'], 'heading' => $_strings['pt--tag-delete'], 'form' => 'form-tag-delete', 'form-tag-delete' => $zecc14, ); return $v2cb9d; } function e2m_untagged(){ global$_strings,$_config; $hf79b1='AND `IsVisible`=1'; if (oe852())$hf79b1=''; return id864(array ( 'query' => "SELECT n.* FROM `". $_config['db_table_prefix']."Notes` n ". "LEFT OUTER JOIN `". $_config['db_table_prefix']."NotesKeywords` nk ". "ON nk.NoteID = n.ID ". "WHERE `IsPublished`=1 AND nk.KeywordID IS NULL ".$hf79b1." ". "ORDER BY n.Stamp DESC", 'title' => $_strings['pt--posts-without-tags'], 'heading' => $_strings['pt--posts-without-tags'], 'nothing' => $_strings['gs--no-posts-without-tags'], 'show-all-notes' => true, )); } function e2s_tag_edit(){ global$_strings,$_config; $f76f09=$oe4d23=$s67daf=''; if(array_key_exists('tag-id',$_POST)) $f76f09=$_POST['tag-id']; if(array_key_exists('tag',$_POST)) $oe4d23=$_POST['tag']; if(array_key_exists('description',$_POST)) $s67daf=trim($_POST['description'],"\r\n"); $oe4d23=cff7c($oe4d23); $s67daf=cff7c($s67daf); if (r0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE Keyword = '". i7928($oe4d23) ."' ". "AND (ID != ".((int)$f76f09).")" )) { $j53e61=a0d6b(); if(count($j53e61)==0){ e7996(); @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); $yb19ad=array ( 'ID' => ((int)$f76f09), 'Keyword' => $oe4d23, 'Description' => $s67daf, ); if (naa79('Keywords',$yb19ad)) { $va7ff0=$_POST['urlname']; $r17901=rd712( 'set',ENTITY_TYPE_TAG,$yb19ad['ID'],$va7ff0 ); e2_go_to(t83c8('e2m_tag', array ('tag-alias' => $r17901))); } else { l4930(); } } else { k8a40($_strings['er--cannot-rename-tag'],E2E_USER_ERROR); l4930(); } } else { l4930(); } die; } function e2s_tag_delete(){ global$_strings,$_config; $yb80bb=((int)$_POST['tag-id']); e7996(); @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); $m444bc=( r0738( "DELETE FROM `". $_config['db_table_prefix']."Keywords` WHERE `ID`=". $yb80bb ) and r0738( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` WHERE `KeywordID`=". $yb80bb ) ); if ($m444bc){ e2_go_to(t83c8('e2m_tags')); die; } else { l4930(); die; } } function zaf16($c07f25){ global $v097cc,$_current_tag,$_config; $l9df9d=null; if(CACHE_FAVTAGS and is_file(CACHE_FILENAME_FAVTAGS)) { $l9df9d=@unserialize(scdf0(CACHE_FILENAME_FAVTAGS)); } if (!is_array($l9df9d)) { r0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE IsFavourite = 1 ORDER BY `Keyword`" ); $p9cdff=a0d6b(); $l9df9d=array(); foreach ($p9cdff as $u04ff0){ $uc6827['tag']=htmlspecialchars($u04ff0['Keyword'],ENT_NOQUOTES,HSC_ENC); $uc6827['href']=t83c8( 'e2m_tag', array ('*tag' => $u04ff0) ); $l9df9d[] = $uc6827; } if(CACHE_FAVTAGS)t6e52(CACHE_FILENAME_FAVTAGS,serialize($l9df9d)); } $m8a4f1=false; foreach ($l9df9d as $z8ce4b => $s9e366){ $l9df9d[$z8ce4b]['current?'] = ( $l9df9d[$z8ce4b]['tag']==$_current_tag ); if ($l9df9d[$z8ce4b]['current?']) { $m8a4f1=true; $x08187=$c07f25; $x08187['flag']='IsFavourite'; $x08187['value']=0; if (oe852()) { $l9df9d[$z8ce4b]['pinnable?']=true; $l9df9d[$z8ce4b]['pinned?']=true; $l9df9d[$z8ce4b]['pinned-toggle-href'] = ( t83c8('e2m_tag_flag_ajax',$x08187) ); } } } if (oe852()) { if (!$m8a4f1 and array_key_exists('*tag',$c07f25)) { $ga55a9=$c07f25; $ga55a9['flag']='IsFavourite'; $ga55a9['value']=1; $id5a7a=array ( 'tag' => htmlspecialchars($c07f25['*tag']['Keyword'],ENT_NOQUOTES,HSC_ENC), 'href' => t83c8('e2m_tag',$c07f25), 'current?' => true, 'pinnable?' => true, 'pinned?' => false, 'pinned-toggle-href' => t83c8('e2m_tag_flag_ajax',$ga55a9), ); $l9df9d[] = $id5a7a; } } return $l9df9d; } function ice23($v21158,$parameters=''){ global$_config; $w0dff3=array(); if (r0738( "SELECT `". $_config['db_table_prefix']."Keywords`.* ". "FROM `". $_config['db_table_prefix']."Keywords`, ". "`". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `". $_config['db_table_prefix']."NotesKeywords`.NoteID=". ((int)$v21158) ." ". "AND `". $_config['db_table_prefix']."Keywords`.ID=`". $_config['db_table_prefix']."NotesKeywords`.KeywordID ". "ORDER BY `Keyword`" )) { $w0dff3=a0d6b(); } return $w0dff3; } function z53f1($zeaa60){ global$_config; $m316e8=array(); foreach (array ( 'ID', 'NoteID', 'KeywordID', ) as $m06e3d) if(array_key_exists($m06e3d,$zeaa60)) { $t6a7f2[] = '`'. $m06e3d .'`'."='". i7928($zeaa60[$m06e3d]) ."'"; if ($m06e3d=='ID')$g729d6='tagbinging-id'; if ($m06e3d=='NoteID')$g729d6='tagbinging-note-id'; if ($m06e3d=='KeywordID')$g729d6='tagbinging-tag-id'; $m316e8[$g729d6]=$zeaa60[$m06e3d]; } $q1b1cc=( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE ". implode(' AND ',$t6a7f2) ); if (r0738($q1b1cc)) { return true; } } function wcbd4($zeaa60){ global$_config; if (!array_key_exists('ID',$zeaa60) or !is_numeric($zeaa60['ID'])) { die ('API MISUSE: e2q_update_tagbinding must be called with an ID field in $tagbinding_record'); } $t6a7f2=array(); foreach (array ( 'NoteID', 'KeywordID', ) as $m06e3d) if(array_key_exists($m06e3d,$zeaa60)) { $t6a7f2[] = '`'. $m06e3d .'`'."='". i7928($zeaa60[$m06e3d]) ."'"; } if(count($t6a7f2) > 0){ $q1b1cc = "UPDATE `". $_config['db_table_prefix']."NotesKeywords` ". "SET ". implode(', ',$t6a7f2) ." ". "WHERE `ID`=". $zeaa60['ID']; if (r0738($q1b1cc)) { return true; } } } function m03de($oe4d23){ @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); $yb19ad=array ( 'Keyword' => i7928($oe4d23), 'OriginalAlias' => rd712('find',ENTITY_TYPE_UNSPECIFIED,'',$oe4d23), 'Description' => '', ); if (($yb19ad=j9943('Keywords',$yb19ad)) !== false){ $s419a1=rd712( 'set',ENTITY_TYPE_TAG,$yb19ad['ID'],$oe4d23 ); if ($s419a1!=$yb19ad['OriginalAlias']) { $yb19ad['OriginalAlias']=$s419a1; naa79('Keywords',$yb19ad); } return $yb19ad['ID']; } } function z5d57(){ global$_config; $n1c0b7=oe852(); $qd29bb=CACHE_FILENAME_TAGS; if ($n1c0b7)$qd29bb=CACHE_FILENAME_TAGS_AUTHOR; $k8da94=null; if(CACHE_TAGS and is_file($qd29bb)) { $k8da94=@unserialize(scdf0($qd29bb)); } if (!is_array($k8da94)) { r0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "ORDER BY `Keyword`" ); $q35016=array(); foreach (a0d6b() as $yb19ad){ $oe4d23['tag']=htmlspecialchars($yb19ad['Keyword'],ENT_NOQUOTES,HSC_ENC); $oe4d23['href']=t83c8('e2m_tag', array ('*tag' => $yb19ad)); $oe4d23['favourite?'] = (bool)$yb19ad['IsFavourite']; $oe4d23['notes-count']=0; $oe4d23['last-used']=0; $oe4d23['freshness']=0; $oe4d23['weight']=0; $q35016[$yb19ad['ID']] = $oe4d23; } r0738( "SELECT nk.KeywordID, COUNT(DISTINCT n.ID) as Count, max(n.Stamp) as LastUsed ". "FROM `". $_config['db_table_prefix']."NotesKeywords` nk, ". "`". $_config['db_table_prefix']."Notes` n ". "WHERE nk.NoteID = n.ID AND n.IsPublished ". ($n1c0b7? "":"AND n.IsVisible=1 "). "GROUP BY nk.KeywordID" ); $k9fdd5=0; $c8f57c=0; $b06894=0; foreach (a0d6b() as $w28a42){ $uc6827 =& $q35016[$w28a42['KeywordID']]; $uc6827['notes-count']=$w28a42['Count']; if (@$uc6827['last-used'] < $w28a42['LastUsed']) { $uc6827['last-used']=$w28a42['LastUsed']; $b452b4=(time()-$uc6827['last-used']) / SECONDS_IN_A_YEAR; $uc6827['freshness']=pow(1/2,$b452b4); } $k9fdd5=max($k9fdd5,$uc6827['notes-count']); $c8f57c=max($c8f57c,$uc6827['freshness']); $b06894=max($b06894,$uc6827['notes-count']*$uc6827['freshness']); } $k8da94=array(); foreach ($q35016 as $c865c0 => $s9e366){ if (!$n1c0b7 and $s9e366['notes-count']==0) continue; $m95e80=mb_strtolower($s9e366['tag']); $k8da94[$m95e80]=$s9e366; if ($c8f57c!=0){ $k8da94[$m95e80]['freshness']=$s9e366['freshness']/$c8f57c; } else { $k8da94[$m95e80]['freshness']=0; } if ($b06894!=0){ $k8da94[$m95e80]['weight'] = ( $s9e366['freshness']*$s9e366['notes-count']/$b06894 ); } else { $k8da94[$m95e80]['weight']=0; } if ($k8da94[$m95e80]['favourite?'])$k8da94[$m95e80]['weight']=1; } if(CACHE_TAGS)t6e52($qd29bb,serialize($k8da94)); } return $k8da94; } function sa463($v21158,$oda3ad='Keyword'){ global$_config; if (r0738( "SELECT `". $_config['db_table_prefix']."Keywords`.* ". "FROM `". $_config['db_table_prefix']."Keywords`, ". "`". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `". $_config['db_table_prefix']."NotesKeywords`.NoteID=".((int)$v21158)." AND ". "`". $_config['db_table_prefix']."Keywords`.ID=". "`". $_config['db_table_prefix']."NotesKeywords`.KeywordID ". "ORDER BY `".$oda3ad."`" ))$ffa816=a0d6b(); else $ffa816=array(); $y59aeb=array(); foreach ($ffa816 as $te358e)$y59aeb[] = $te358e; return $y59aeb; } function g0188($ud7df5){ global$_config; if (r0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `Keyword`='".i7928($ud7df5)."'" )) { $z8ce4b=a0d6b(); if (isset ($z8ce4b[0])) return $z8ce4b[0]; } return null; } function j8770($nd7ca3){ global$_config; if (r0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `OriginalAlias`='".i7928($nd7ca3)."'" )) $ffa816=a0d6b(); else $ffa816=array(); if (isset ($ffa816[0])) return $ffa816[0]; else return FALSE; } function f4e28($yb80bb){ global$_config; if (r0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `ID`='".((int)$yb80bb)."'" )) { $z8ce4b=a0d6b(); if (isset ($z8ce4b[0])) { $z8ce4b=$z8ce4b[0]; return $z8ce4b; } else { return NULL; } } return NULL; } function e2_tagrecs_with_parameters_($parameters){ $zbdcf3=array(); if (@$parameters['tag-alias']) { $zbdcf3=explode(',',$parameters['tag-alias']); } $w0dff3=array(); foreach ($zbdcf3 as $nd7ca3) if ($nd7ca3){ if ( $lc45dd=e2_aliasrec_of_alias_(@$nd7ca3) and ($lc45dd['EntityType']==ENTITY_TYPE_TAG) ) { $w0dff3[] = f4e28($lc45dd['EntityID']); } else { if ($l3ee3f=j8770($nd7ca3)) { $w0dff3[] = $l3ee3f; } } } return $w0dff3; } function e2m_comment($parameters=array ()) { e2_go_to(t83c8('e2m_note',$parameters)); die; } function e2m_comment_edit($parameters=array ()) { return u4fb7('edit',$parameters); } function e2m_note_comment($parameters=array ()) { return u4fb7('write',$parameters); } function u4fb7($y60cd8,$parameters=array ()) { global$_config,$_strings,$full_blog_url; $id5d3d=$sf74f5=$_strings['pt--new-comment']; $c69b97='new'; if ($y60cd8=='edit'){ $d4032b=e2_commentrec_with_parameters_($parameters); $ic50d0=$_strings['fb--save-changes']; $y39a37=$d4032b['noterec']; $id5d3d=$sf74f5=$_strings['pt--edit-comment']; $c69b97=$jaca8d['ID']; if (!$d4032b){ return e2_error404_mode(); } $l80f02=array ( '.note-id' => $d4032b['NoteID'], '.comment-id' => $d4032b['ID'], '.already-subscribed?' => false, '.from' => substr($_SERVER['HTTP_REFERER'],strlen($full_blog_url)+1), 'create:edit?' => false, 'form-action' => t83c8('e2s_comment_process'), 'submit-text' => $ic50d0, 'show-subscribe?' => true, 'subscribe?' => (bool)$d4032b['IsSubscriber'], 'name' => htmlspecialchars($d4032b['AuthorName'],ENT_COMPAT,HSC_ENC), 'email' => htmlspecialchars($d4032b['AuthorEmail'],ENT_COMPAT,HSC_ENC), 'text' => htmlspecialchars($d4032b['Text'],ENT_COMPAT,HSC_ENC), 'email-field-name' => 'elton-john', ); if (''!=trim($d4032b['IP'])) { $l80f02['ip']=$d4032b['IP']; $l80f02['ip-href']=$_config['whois_service'].$l80f02['ip']; } } else { $y39a37=$parameters['*note']; $l80f02=g66aa($y39a37); } return array ( 'title' => $id5d3d, 'heading' => $sf74f5, 'form' => 'form-comment', 'form-comment' => $l80f02, ); } function e2m_comment_reply($parameters=array ()) { global$_strings; $d4032b=e2_commentrec_with_parameters_($parameters); if (!$d4032b){ return e2_error404_mode(); } $y39a37=$d4032b['noterec']; $s1aec6=u86f8($y39a37,$d4032b,$parameters['comment-number']); $s1aec6['_']['_id']=$d4032b['ID']; $s1aec6['_']['_ord']=0; $s1aec6['_']['_ord_max']=0; $s1aec6['replying?'] = (bool)true; $r817c7=($d4032b['Reply']=='' or !$d4032b['IsReplyVisible']); $id5d3d=$r817c7? $_strings['pt--reply-to-comment']:$_strings['pt--edit-reply-to-comment']; $h4dc70=array ( '.note-id' => $y39a37['ID'], '.comment-id' => $d4032b['ID'], '.reply-action' => $r817c7? 'new':'edit', 'form-action' => t83c8('e2s_comment_edit_reply'), 'submit-text' => $r817c7? $_strings['fb--publish']:$_strings['fb--save-changes'], 'create:edit?' => (bool) ($r817c7), 'reply-text' => htmlspecialchars($d4032b['Reply'],ENT_COMPAT,HSC_ENC), 'mail-back?' => (bool) ($r817c7), ); return array ( 'title' => $id5d3d, 'heading' => $id5d3d, 'comments' => array ('only' => $s1aec6), 'form' => 'form-comment-reply', 'form-comment-reply' => $h4dc70, ); } function e2m_comment_delete($parameters=array ()) { global$_strings,$settings,$scbcce,$_config; if (!@$settings['comments']['on']) return e2_error404_mode(); $d4032b=e2_commentrec_with_parameters_($parameters); $v21158=$d4032b['NoteID']; if (!$d4032b){ return e2_error404_mode(); } e2_drop_caches_for_note_($v21158); @unlink(USER_FOLDER. '/last-comment.psa'); r0738( "DELETE FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `ID` = '".((int)$d4032b['ID'])."'" ); l4930(); die; } function e2m_comment_reply_delete($parameters=array ()) { global$_strings,$settings,$_config; if (!@$settings['comments']['on']) return e2_error404_mode(); $d4032b=e2_commentrec_with_parameters_($parameters); if (!$d4032b){ return e2_error404_mode(); } r0738( "UPDATE `". $_config['db_table_prefix']."Comments` SET ". "`Reply`='', ". "`IsReplyFavourite`='0' ". "WHERE `ID`=".((int)$d4032b['ID']) ); l4930(); die; } function e2m_unsubscribe($parameters){ global$_strings,$_config; $x70a17="ORDER BY `ID` DESC"; $y39a37=$parameters['*note']; $v21158=$y39a37['ID']; $m0c83f=$parameters['unsubscribe-email']; $r1bc29=$parameters['unsubscribe-key']; $m0c83f=str_replace(' ','+',$m0c83f); if ($v21158){ if (r0738( "SELECT `ID`, `Stamp` FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". $v21158 ." AND `IsSubscriber`=1 AND `AuthorEmail`='". $m0c83f ."' ". $x70a17 )) { $result=a0d6b(); if(count($result) < 1) { $v2cb9d['unsubscribe']['success?']=false; $v2cb9d['unsubscribe']['error-message']=$_strings['gs--you-are-not-subscribed']; } else { $c06d4c=@$result[0]; $u97f69=md5($c06d4c['ID'].$c06d4c['Stamp'] .'x'); $s260ca=false; if ($r1bc29==$u97f69){ if (r0738( "UPDATE `". $_config['db_table_prefix']."Comments` SET `IsSubscriber`=0 ". "WHERE `NoteID`=". $v21158 ." AND `AuthorEmail` = '".i7928($m0c83f)."'" )) { $s260ca=true; $v2cb9d['unsubscribe']['success?']=true; $v2cb9d['unsubscribe']['note-title']=g6f10( htmlspecialchars(jea9c($y39a37),ENT_COMPAT,HSC_ENC) ); $v2cb9d['unsubscribe']['note-href']=t83c8( 'e2m_note', array ('*note' => $y39a37) ); } } if (!$s260ca){ $v2cb9d['unsubscribe']['success?']=false; $v2cb9d['unsubscribe']['error-message']=$_strings['gs--unsubscription-didnt-work']; } } } else { $v2cb9d['unsubscribe']['success?']=false; $v2cb9d['unsubscribe']['error-message']=$_strings['gs--comment-not-found']; } } else { $v2cb9d['unsubscribe']['success?']=false; $v2cb9d['unsubscribe']['error-message']=$_strings['gs--post-not-found']; } return $v2cb9d; } function e2m_comment_flag($parameters){ n6e30($parameters); e2_go_to(t83c8('e2m_note',$parameters)); die; } function e2m_comment_flag_ajax($parameters){ if (n6e30($parameters)) { $e67142=$parameters; $e67142['value'] = !$parameters['value']; if($parameters['value']==1){ $g99859=t83c8('e2m_comment_flag_ajax',$e67142); $g1fa03='on-rehref|'. $g99859; } else { $g99859=t83c8('e2m_comment_flag_ajax',$e67142); $g1fa03='off-rehref|'. $g99859; } } else { $g1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($g1fa03); } else { e2_go_to(t83c8('e2m_note',$parameters)); die; } } function n6e30($parameters){ $d4032b=e2_commentrec_with_parameters_($parameters); $v21158=$d4032b['NoteID']; $result=false; if ($d4032b){ $result=naa79('Comments', array ( 'ID' => $d4032b['ID'], $parameters['flag'] => (int) ($parameters['value']==1), )); e2_drop_caches_for_note_($v21158); } return$result; } function e2s_comment_process(){ global$_strings,$_fp_error; list ($v21158,$c69b97,$j9d090)=m1a90(); if(__LOG)__log('Comments: processed, noteid <'. $v21158 .'>, commentid <'. $c69b97 .'>'); if (!$c69b97){ $g05c36=''; if($_fp_error==FP_NOT_COMMENTABLE){ k8a40($_strings['er--post-not-commentable'],E2E_USER_ERROR); } elseif($_fp_error==FP_EMPTY_FIELD){ k8a40($_strings['er--name-email-text-required'],E2E_USER_ERROR); } elseif($_fp_error==FP_COMMENT_TOO_LONG){ $paa731=$_strings['gs--comment-too-long']; $g05c36=$_strings['gs--comment-too-long-description']; } elseif($_fp_error==FP_COMMENT_DOUBLE_POST){ $paa731=$_strings['gs--comment-double-post']; $g05c36=$_strings['gs--comment-double-post-description']; } elseif($_fp_error==FP_COMMENT_SPAM_SUSPECT){ $paa731=$_strings['gs--comment-spam-suspect']; $g05c36=$_strings['gs--comment-spam-suspect-description']; } else { k8a40($_strings['er--error-occurred'].' ('. $_fp_error .')'); } if ($g05c36){ $v2cb9d['title']=$paa731; $v2cb9d['heading']=$paa731; $v2cb9d['form']='form-unaccepted-comment'; $v2cb9d['form-unaccepted-comment'] = array ( 'reason' => $g05c36, 'text' => @htmlspecialchars($j9d090['text'],ENT_COMPAT,HSC_ENC), ); return $v2cb9d; } } if ($v21158){ e2_go_to(t83c8('e2m_note', array ('*note' => v4627($v21158)))); } else { e2_go_to(); } die; } function e2s_comment_edit_reply(){ global$_strings,$d57de2,$_config; $ve84af=@$_POST['text']; if(trim($ve84af)=='')$ve84af=''; $v21158=@$_POST['note-id']; $saad65=v4627($v21158); $c69b97=@$_POST['comment-id']; $c06d4c=db559($c69b97); $e54eb6=isset ($_POST['mail-back']); $k54fa9=time(); if (@$_POST['reply-action']=='new'){ $we0e30=time(); } @unlink(e2_note_cache_filename_with_id_($v21158 .'-comments')); if ($c06d4c and r0738( "UPDATE `". $_config['db_table_prefix']."Comments` SET ". "`Reply`='". i7928($ve84af) ."', ". ( isset ($we0e30)? ( "`ReplyStamp`='". $we0e30 ."', " ) : ( "" ) ). "`ReplyLastModified`='". $k54fa9 ."', ". "`IsReplyVisible`='1' ". "WHERE `ID`=".((int)$c69b97) )) { $yd58c0=t83c8('e2m_note', array ('*note' => $saad65)); if ($e54eb6 and $ve84af!=''){ $uc6827['comment-time'] = array ($c06d4c['Stamp'],i5c05()); $uc6827['commenter']=$c06d4c['AuthorName']; $uc6827['commenter-email']=$c06d4c['AuthorEmail']; $uc6827['comment-text']=$c06d4c['Text']; $uc6827['note-title']=g6f10(jea9c($saad65)); $uc6827['reply-time'] = array (time(),i5c05()); $uc6827['blog-author']=x2640(); $uc6827['note-href']=$yd58c0; $uc6827['comment-href']=$yd58c0; $uc6827['reply-text']=$ve84af; if(1){ $sde7a3=z3e5c( 'comment-reply',$uc6827 ); $ab904c=e2l_get_string( 'em--comment-reply', $uc6827 ); $h77613=$c06d4c['AuthorEmail']; $v1a49b='From: '. vaed2(); ba41b($h77613,$ab904c,$sde7a3,$v1a49b); } if(1){ unset ($uc6827['commenter-email']); $v1a49b='From: '. vaed2(); foreach (t4975($saad65,$c06d4c['AuthorEmail']) as $c39c63){ $eba570=$c39c63['AuthorEmail']; $x6fd85=md5($c39c63['ID'].$c39c63['Stamp'].'x'); $uc6827['unsubscribe-href']=t83c8('e2m_unsubscribe', array ( '*note' => $saad65, 'unsubscribe-email' => $eba570, 'unsubscribe-key' => $x6fd85, ) ); $h77613=$eba570; $sde7a3=z3e5c('comment-reply-to-public',$uc6827); $ab904c=e2l_get_string( 'em--comment-reply-to-public-subject', $uc6827 ); ba41b($h77613,$ab904c,$sde7a3,$v1a49b); } } } e2_go_to($yd58c0); } else { l4930(); } die; } function u86f8($saad65,$c06d4c,$fb1bc2=false){ global$_config; if(__LOG)__log('Comments: package comment <'. $c06d4c['ID'] .'>...'); if ($saad65===null){ $saad65=v4627($c06d4c['NoteID']); } if ($fb1bc2!==false)$uc6827['number']=$fb1bc2; $uc6827['name']=htmlspecialchars($c06d4c['AuthorName'],ENT_NOQUOTES,HSC_ENC); if (oe852()) { $uc6827['email']=htmlspecialchars($c06d4c['AuthorEmail'],ENT_NOQUOTES,HSC_ENC); if (''!=trim($c06d4c['IP'])) { $uc6827['ip']=$c06d4c['IP']; $uc6827['ip-href']=$_config['whois_service'].$uc6827['ip']; } } $uc6827['author-name']=x2640(); $uc6827['visible?'] = (bool)$c06d4c['IsVisible']; $uc6827['important?'] = (bool)$c06d4c['IsFavourite']; $uc6827['reply-visible?'] = (bool) ($c06d4c['IsVisible'] && $c06d4c['IsReplyVisible']); $uc6827['reply-important?'] = (bool)$c06d4c['IsReplyFavourite']; $uc6827['spam-suspect?'] = (bool)$c06d4c['IsSpamSuspect']; $o10a7e=array ((int)$c06d4c['Stamp'],i0923($saad65)); $uc6827['time']=$o10a7e; $uc6827['last-modified']=$o10a7e; if ($c06d4c['LastModified']) $uc6827['last-modified'] = array ((int)$c06d4c['LastModified'],i0923($saad65)); if ($c06d4c['ReplyStamp']) $uc6827['reply-time'] = array ((int)$c06d4c['ReplyStamp'],i0923($saad65)); if ($c06d4c['ReplyLastModified']) $uc6827['reply-last-modified'] = array ((int)$c06d4c['ReplyLastModified'],i0923($saad65)); if (oe852()) { $uc6827['subscriber?'] = (bool)$c06d4c['IsSubscriber']; $uc6827['new?'] = (bool)$c06d4c['IsNew']; $uc6827['first-new?']=false; if ($c06d4c['IsFavourite']) { $uc6827['important-toggle-href']=t83c8( 'e2m_comment_flag_ajax', array ('*note' => $saad65,'comment-number' => $fb1bc2,'flag' => 'IsFavourite','value' => 0) ); } else { $uc6827['important-toggle-href']=t83c8( 'e2m_comment_flag_ajax', array ('*note' => $saad65,'comment-number' => $fb1bc2,'flag' => 'IsFavourite','value' => 1) ); } if ($c06d4c['IsReplyFavourite']) { $uc6827['reply-important-toggle-href']=t83c8( 'e2m_comment_flag_ajax', array ( '*note' => $saad65,'comment-number' => $fb1bc2,'flag' => 'IsReplyFavourite','value' => 0 ) ); } else { $uc6827['reply-important-toggle-href']=t83c8( 'e2m_comment_flag_ajax', array ( '*note' => $saad65,'comment-number' => $fb1bc2,'flag' => 'IsReplyFavourite','value' => 1 ) ); } $uc6827['edit-href']=t83c8( 'e2m_comment_edit', array ('*note' => $saad65,'comment-number' => $fb1bc2) ); $uc6827['removed-toggle-href']=t83c8( 'e2m_comment_flag_ajax', array ( '*note' => $saad65,'comment-number' => $fb1bc2, 'flag' => 'IsVisible','value' => !$c06d4c['IsVisible'] ) ); $uc6827['removed-reply-toggle-href']=t83c8( 'e2m_comment_flag_ajax', array ( '*note' => $saad65,'comment-number' => $fb1bc2, 'flag' => 'IsReplyVisible','value' => !$c06d4c['IsReplyVisible'] ) ); $re36ef=t83c8( 'e2m_comment_reply', array ('*note' => $saad65,'comment-number' => $fb1bc2) ); if ($c06d4c['Reply']=='' or !$c06d4c['IsReplyVisible']) { $uc6827['reply-href']=$re36ef; } else { $uc6827['edit-reply-href']=$re36ef; } } if(mb_strlen($c06d4c['Text']) > $_config['max_comment_length']) { $c06d4c['Text']=mb_substr($c06d4c['Text'],0,$_config['max_comment_length']); } $k2bfe4=i154e($saad65['FormatterID'],$c06d4c['Text'],'simple'); $uc6827['text']=$k2bfe4['text-final']; $uc6827['replying?'] = (bool)false; $uc6827['replied?'] = (bool) ( (trim($c06d4c['Reply']) != '') && ($c06d4c['IsReplyVisible']) ); $k2bfe4=i154e($saad65['FormatterID'],$c06d4c['Reply'],'full'); $uc6827['reply']=$k2bfe4['text-final']; if(array_key_exists('_',$c06d4c))$uc6827['_']=$c06d4c['_']; if(__LOG)__log('Comments: done'); return $uc6827; } function db559($yb80bb){ global$_config; if (r0738( "SELECT * FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `ID` = '".$yb80bb."'" )) { $ffa816=a0d6b(); if(count($ffa816) > 0) return $ffa816[0]; } return false; } function ae5b6($k0604c){ e2_comment_set_flag('IsVisible',$k0604c); } function a3183($w0dd2c){ e2_comment_set_flag('IsReplyVisible',$w0dd2c); } function g66aa($yea59a){ global$_strings; $ze3cb9=@$_COOKIE[c8c3b('commenter_name')]; $uf92ee=@$_COOKIE[c8c3b('commenter_email')]; $g3d682=@$_COOKIE[c8c3b('commenter_ph')]; $s92399=false; if ($uf92ee and cookie_unsubscribe_key){ foreach (t4975($yea59a) as $c39c63){ $u97f69=md5($c39c63['ID'].$c39c63['Stamp'] .'x'); if ( $c39c63['AuthorEmail']==$uf92ee and $g3d682==$u97f69 ){ $s92399=true; break; } } } $ic50d0=$_strings['fb--submit']; $l80f02=array ( '.note-id' => $yea59a['ID'], '.comment-id' => 'new', '.already-subscribed?' => (bool)$s92399, 'create:edit?' => true, 'form-action' => t83c8('e2s_comment_process'), 'submit-text' => $ic50d0, 'show-subscribe?' => (bool) !$s92399, 'subscribe?' => (bool)$s92399, 'subscription-status' => $s92399? $_strings['gs--you-are-already-subscribed']:'', 'visible?' => true, 'email-field-name' => 'elton-john', 'name' => htmlspecialchars($ze3cb9,ENT_COMPAT,HSC_ENC), 'email' => htmlspecialchars($uf92ee,ENT_COMPAT,HSC_ENC), 'text' => htmlspecialchars($c06d4c['Text'],ENT_COMPAT,HSC_ENC), ); return $l80f02; } function r254f($v21158,$mdaf19=0){ global$_config; if (!$mdaf19)$hf79b1=' AND `IsVisible`=1'; if ('all'===$mdaf19){ $hf79b1=''; } if ('new'===$mdaf19){ $hf79b1=' AND `IsNew`=1'; } $obc751=0; if (r0738( "SELECT count(*) FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". @$v21158 . @$hf79b1 )) { $result=a0d6b(); $result=(int)$result[0]['count(*)']; $obc751=$result; } return (int)$obc751; } function u2a6b(){ global$_config; $le2942=0; $k7ec7e=''; $ae8fab=''; if (r0738( "SELECT `NoteID`, `Text` FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `IsNew`=1 ORDER BY `Stamp`" )) { $result=a0d6b(); $le2942=count($result); if ($le2942){ $v21158=$result[0]['NoteID']; $ae8fab=t83c8( 'e2m_note', array ('*note' => v4627($v21158)) ); } else { $ae8fab=''; } } return array ((int)$le2942,$k7ec7e,$ae8fab); } function p1baf($v21158,$f641f6){ global$_config; if(__LOG)__log('Comments: getting comments for note '. $v21158); if (r0738( "SELECT * FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". @$v21158." ". @$hf79b1 ." ". $f641f6 )) { $result=a0d6b(); return$result; } return array (); } function t4975($saad65,$fd1cc6=''){ global$_config; $x70a17="ORDER BY `ID` DESC"; $v2cb9d=$taf67c=array(); if (r0738( "SELECT DISTINCT `ID`, `Text`, `IsSubscriber`, `AuthorName`, `AuthorEmail`, `Stamp` ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". @$saad65['ID'] ." ". "AND `IsSubscriber`=1 ". "AND `AuthorEmail`!='". i7928($fd1cc6) ."' ". $x70a17 )) { $result=a0d6b(); foreach($result as $c39c63){ if (!in_array($c39c63['AuthorEmail'],$taf67c)) { $v2cb9d[] = $c39c63; } $taf67c[] = $c39c63['AuthorEmail']; } } return $v2cb9d; } function cb387($saad65,$y3f917=NOTE_COMMENTABLE_NOW){ global$settings,$_config; $l61f40=$settings['comments']['on']; $h8f888=$saad65['IsPublished']; $ubdb20=true; if (@$settings['comments']['fresh_only']) if (isset ($_config['comment_freshness_days'])) if ($saad65['Stamp'] < time()-$_config['comment_freshness_days']*SECONDS_IN_A_DAY) $ubdb20=false; $pc770a=$saad65['IsCommentable']; if ($y3f917==NOTE_COMMENTABLE_NOW_CONDITIONALLY){ $pc770a=true; } $q825ff=$saad65['IsVisible']; return $l61f40 and $h8f888 and $ubdb20 and $pc770a and $q825ff; } function e2_commentrec_with_parameters_($parameters=array ()) { $y39a37=$parameters['*note']; $za5d49=p1baf($y39a37['ID'],"ORDER BY `Stamp`"); $d4032b=@$za5d49[$parameters['comment-number']-1]; if ($d4032b){ $d4032b['noterec']=$y39a37; return $d4032b; } } function m1a90($n98ea6=''){ global$settings,$scbcce,$_config,$_fp_error; $_fp_error=false; $qbe16c='elton-john'; $v21158=$c69b97=$ub0689=$m0c83f=$l1cb25=''; if(array_key_exists('note-id',$_POST)) $v21158=trim(@$_POST['note-id']); if(array_key_exists('comment-id',$_POST)) $c69b97=trim(@$_POST['comment-id']); if(array_key_exists('name',$_POST)) $ub0689=trim(@$_POST['name']); if(array_key_exists($qbe16c,$_POST)) $m0c83f=trim(@$_POST[$qbe16c]); if(array_key_exists('text',$_POST)) $l1cb25=trim(@$_POST['text']); $ub0689=cff7c($ub0689); $l1cb25=cff7c($l1cb25); $t07d3d=( (array_key_exists('already-subscribed',$_POST) and $_POST['already-subscribed']) or (array_key_exists('subscribe',$_POST) and $_POST['subscribe']) ); $u20612=time(); $j9d090['text']=$l1cb25; if ($c69b97=='new'){ ec64a('commenter_name',$ub0689); ec64a('commenter_email',$m0c83f); } $z848b5=( $c69b97=='new' and (array_key_exists('email',$_POST) and $_POST['email']!='') ); $dc2b1a=1; $result=false; if (!is_numeric($v21158)) { $_fp_error=FP_NO_ID_OR_NEW; } elseif (!is_numeric($c69b97) and !($c69b97=='new')) { $_fp_error=FP_NO_ID_OR_NEW; } else { if ($c69b97 and $ub0689=='' or $m0c83f=='' or $l1cb25==''){ $_fp_error=FP_EMPTY_FIELD; } if ($c69b97=='new'){ $r795f1=@unserialize(scdf0(USER_FOLDER. '/last-comment.psa')); if(md5($ub0689.$m0c83f.$l1cb25)==$r795f1['md5']) { $_fp_error=FP_COMMENT_DOUBLE_POST; } if ( isset ($_config['max_comment_length']) and strlen(@$_POST['text']) > ($_config['max_comment_length']) ){ $_fp_error=FP_COMMENT_TOO_LONG; } $y39a37=v4627($v21158); if ($c69b97=='new' and !cb387($y39a37)) { $_fp_error=FP_NOT_COMMENTABLE; } if ($z848b5){ $_fp_error=FP_COMMENT_SPAM_SUSPECT; } } } if (!$_fp_error){ e2_drop_caches_for_note_($v21158); if ($c69b97=='new'){ $d4032b=array ( 'NoteID' => (int)$v21158, 'AuthorName' => i7928($ub0689), 'AuthorEmail' => i7928($m0c83f), 'Text' => i7928($l1cb25), 'Reply' => '', 'IsVisible' => 1, 'IsAnswerAware' => 1, 'IsSubscriber' => (int)$t07d3d, 'IsSpamSuspect' => (int)$z848b5, 'IsNew' => (int)$dc2b1a, 'Stamp' => (int)time(), 'LastModified' => (int)time(), 'IP' => i7928($_SERVER['REMOTE_ADDR']), ); if (($d4032b=j9943('Comments',$d4032b)) !== false){ $c69b97=$d4032b['ID']; $r795f1=array ( 'id' => $c69b97, 'md5' => md5($ub0689.$m0c83f.$l1cb25), ); @t6e52(USER_FOLDER. 'last-comment.psa',serialize($r795f1)); $result=(int)$c69b97; $s303ee=md5($d4032b['ID'].$d4032b['Stamp'].'x'); ec64a('commenter_ph',$s303ee); $e60422=r254f($v21158,'all')-1+1; $saad65=v4627($v21158); $yd58c0=t83c8('e2m_note', array ('*note' => $saad65)); $uc6827['comment-time'] = array ($u20612,i5c05()); $uc6827['commenter']=$ub0689; $uc6827['commenter-email']=$m0c83f; $uc6827['comment-text']=$l1cb25; $uc6827['note-title']=jea9c($saad65); $uc6827['note-href']=$yd58c0; $uc6827['comment-href']=$yd58c0; $uc6827['comments-disable-href']=t83c8('e2m_note_flag', array ( '*note' => $saad65, 'flag' => 'IsCommentable', 'value' => 0 )); $uc6827['reply-href']=t83c8( 'e2m_comment_reply', array ('*note' => $saad65,'comment-number' => $e60422) ); if (isset ($settings['user']['email']) and @$settings['notifications']['new_comments']) { $sde7a3=z3e5c( 'comment-new-to-author',$uc6827 ); $ab904c=e2l_get_string( 'em--comment-new-to-author-subject', $uc6827 ); $h77613=$settings['user']['email']; $v1a49b = 'From: '. vaed2() ."\r\n". 'Reply-to: '. $ub0689 .' <'. $m0c83f .">"; ba41b($h77613,$ab904c,$sde7a3,$v1a49b); } if (!$z848b5){ unset ($uc6827['commenter-email']); $v1a49b='From: '. vaed2(); foreach (t4975($saad65,$m0c83f) as $c39c63){ $eba570=$c39c63['AuthorEmail']; $x6fd85=md5($c39c63['ID'].$c39c63['Stamp'].'x'); $uc6827['unsubscribe-href']=t83c8('e2m_unsubscribe', array ( '*note' => $saad65, 'unsubscribe-email' => $eba570, 'unsubscribe-key' => $x6fd85 ) ); $h77613=$eba570; $sde7a3=z3e5c('comment-new-to-public',$uc6827); $ab904c=e2l_get_string( 'em--comment-new-to-public-subject', $uc6827 ); ba41b($h77613,$ab904c,$sde7a3,$v1a49b); } } } else { $_fp_error=FP_INSERT_ERROR; } } else { $yfd6f3=array ( 'ID' => $c69b97, 'AuthorName' => $ub0689, 'AuthorEmail' => $m0c83f, 'Text' => $l1cb25, 'IsSubscriber' => ((int)$t07d3d), 'LastModified' => time(), ); if (naa79('Comments',$yfd6f3)) { $result=(int)$c69b97; } else { $_fp_error=FP_UPDATE_ERROR; }; } } if ($n98ea6=='ajaxresult') return $g1fa03; else return array ((int)$v21158,$result,$j9d090); } function e2m_most_commented(){ global$settings,$_strings,$_config; $ma0acf=@$_GET['period']; if ($ma0acf=='')$ma0acf=$_config['hot_period']; $t632a2=time()-f35c3($ma0acf); $hf79b1="AND `IsVisible`=1 "; if (oe852())$hf79b1=''; return id864(array ( 'query' => "SELECT `IsVisible`, `Stamp`, `NoteID` ID, count(*) c ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE (`Stamp` > ". $t632a2.") ". $hf79b1. "GROUP BY `NoteID` ". "ORDER BY c ". "DESC ". "LIMIT ".$settings['appearance']['notes_per_page'], 'query-returns-only-ids' => 1, 'limit' => $settings['appearance']['notes_per_page'], 'class' => 'most-commented', 'title' => e2l_get_string('pt--most-commented', array ('period' => $ma0acf)), 'heading' => e2l_get_string('pt--most-commented', array ('period' => $ma0acf)), 'nothing' => $_strings['gs--no-such-notes'], )); } function e2m_favourites($parameters=array ()) { global$_config,$_strings; $hf79b1="AND `IsVisible`=1 "; if (oe852())$hf79b1=''; return id864(array ( 'query' => "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND `IsFavourite`=1 ". $hf79b1 . "ORDER BY `Stamp` DESC", 'page' => $parameters['page'], 'candy' => 'e2m_favourites', 'parameters' => $parameters, 'class' => 'favourites', 'title' => $_strings['pt--favourites'], 'heading' => $_strings['pt--favourites'], 'nothing' => $_strings['gs--no-favourites'], )); } function f35c3($ma0acf){ if ('year'==$ma0acf) return SECONDS_IN_A_YEAR; elseif ('month'==$ma0acf) return SECONDS_IN_A_MONTH; elseif ('week'==$ma0acf) return SECONDS_IN_A_DAY*7; elseif ('day'==$ma0acf) return SECONDS_IN_A_DAY; else return PHP_INT_MAX; } function n8696($r8d777){ global $v097cc; if(__LOG)__log('Arbitrary list ('. $r8d777['_log'] .') {'); $ye919a=g7f78(); $nf4ac8=null; if ($r8d777['cache'] and is_file($r8d777['cache-filename'])) { $nf4ac8=@unserialize(scdf0($r8d777['cache-filename'])); } $hf957e=true; if ($r8d777['cache-filename-expires']) { if ($r8d777['cache'] and is_file($r8d777['cache-filename-expires'])) { $r07cc6=time(); $c09bcb=(int) @scdf0($r8d777['cache-filename-expires']); if(__LOG)__log('List expires '. date('r',$c09bcb) .', now '. date('r',$r07cc6)); $hf957e=($r07cc6 < $c09bcb); } } $ldbb0c=array(); if ($r8d777['cache'] and is_array($nf4ac8) and $hf957e){ if(__LOG)__log('Retrieve cached ctree'); $ldbb0c=$nf4ac8; } else { if(__LOG)__log('Assemle cacheable ctree...'); $y4358b=array(); if (r0738($r8d777['query'])) { $result=a0d6b(); foreach($result as $z8ce4b => $y39a37){ $y39a37=v4627($y39a37['ID']); if ($y39a37['IsVisible'] and $y39a37['IsPublished']) { $saad65['_']['_id']=$y39a37['ID']; $saad65['_']['_ord']=$z8ce4b; $saad65['_']['_ord_max']=count($result)-1; $saad65['href']=t83c8('e2m_note', array ('*note' => $y39a37)); $saad65['time'] = array ($y39a37['Stamp'],i0923($y39a37)); $saad65['title']=g6f10(htmlspecialchars(jea9c($y39a37),ENT_NOQUOTES,HSC_ENC)); $ldbb0c[] = $saad65; } } $nf4ac8=$ldbb0c; if ($r8d777['cache']) { @t6e52($r8d777['cache-filename'],serialize($nf4ac8)); if ($r8d777['cache-filename-expires']) { @t6e52($r8d777['cache-filename-expires'],time()+$r8d777['expires-after']); } } } } foreach ($ldbb0c as $z8ce4b => $s9e366){ $ldbb0c[$z8ce4b]['current?'] = ($ldbb0c[$z8ce4b]['href']==$v097cc); } if(__LOG)__log('} // Arbitrary list @ '. round(g7f78()-$ye919a,3)); return $ldbb0c; } function g09d1(){ global $v097cc,$_config; $t632a2=time()-f35c3($_config['hot_period']); return n8696(array ( '_log' => 'most_commented', 'cache' => CACHE_HOT, 'cache-filename' => CACHE_FILENAME_HOT, 'cache-filename-expires' => CACHE_FILENAME_HOT_EXPIRES, 'expires-after' => SECONDS_IN_A_DAY, 'query' => ( "SELECT `Stamp`, `NoteID` ID, count(*) c ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `Stamp` > ". $t632a2 ." AND IsVisible='1'". "GROUP BY `NoteID` ". "ORDER BY c DESC LIMIT 10" ), )); } function q0256(){ global $v097cc,$_config; $t632a2=time()-f35c3($_config['popular_period']); return n8696(array ( '_log' => 'most_read', 'cache' => CACHE_POPULAR, 'cache-filename' => CACHE_FILENAME_POPULAR, 'cache-filename-expires' => CACHE_FILENAME_POPULAR_EXPIRES, 'expires-after' => SECONDS_IN_A_DAY, 'query' => ( "SELECT n.`ID`, n.`Title`, n.`IsFavourite`, a.`EntityID`, SUM(a.`HitCount`) HitCount ". "FROM `". $_config['db_table_prefix']."Actions` a, ". "`". $_config['db_table_prefix']."Notes` n  ". "WHERE a.`Stamp` > ". $t632a2 ." ". "AND a.`EntityID` = n.`ID` ". "GROUP BY a.`EntityID` ". "ORDER BY `IsFavourite` DESC, HitCount DESC ". "LIMIT 10" ), )); } function e2m_password(){ global$settings,$_strings; $v2cb9d['title']=$_strings['pt--password']; $v2cb9d['heading']=$_strings['pt--password-for-blog']; $v2cb9d['form']='form-password'; $v2cb9d['form-password'] = array ( 'form-action' => t83c8('e2s_password_save'), 'submit-text' => $_strings['fb--change'], ); return $v2cb9d; } function e2m_sessions(){ global$settings,$_strings; $f2d6d8=z7785(); $v2cb9d['title']=$_strings['pt--sessions']; $v2cb9d['heading']=$_strings['pt--sessions']; $u161bc=array(); $s3c6e0=$_COOKIE[c8c3b('key')]; foreach ($f2d6d8['sessions'] as $z8ce4b => $s9e366){ $u161bc[] = array ( 'current?' => m4c49($s3c6e0)===$s9e366['key_hash'], 'opened' => array ((int)$s9e366['stamp'],m3211()), 'ip-address' => $s9e366['remote_ip'], 'source' => ($s9e366['remote_ip']=='127.0.0.1')? $_strings['gs--locally']:$s9e366['remote_ip'], 'title' => xcc31($s9e366['ua']), 'user-agent' => $s9e366['ua']? $s9e366['ua']:$_strings['gs--unknown'], ); } $u161bc=array_reverse($u161bc); $v2cb9d['sessions']['each']=$u161bc; if(count($u161bc) > 1){ $v2cb9d['form']='form-sessions'; $v2cb9d['form-sessions'] = array ( 'form-action' => t83c8('e2s_drop_other_sessions'), 'submit-text' => $_strings['fb--end-all-sessions-but-this'], ); } return $v2cb9d; } function e2m_sign_in(){ if (oe852()) { e2_go_to(t83c8('e2m_frontpage')); } else { return array (); } } function e2m_sign_out(){ global$_strings; $f2d6d8=z7785(); $h48bb9=-1; if(array_key_exists('sessions',$f2d6d8) and is_array($f2d6d8['sessions'])) { foreach ($f2d6d8['sessions'] as $z8ce4b => $s9e366){ $s3c6e0=$_COOKIE[c8c3b('key')]; if (m4c49($s3c6e0)===$s9e366['key_hash']) { $h48bb9=$z8ce4b; break; } } } if ($h48bb9 > -1) unset ($f2d6d8['sessions'][$h48bb9]); if (!o1d21($f2d6d8)) { k8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } ec64a('key',''); e2_go_to(); die; } function e2s_password_save(){ global$settings,$_strings; $v0512f=trim($_POST['old-password']); if (qa8cf($v0512f)) { $h88162=trim($_POST['new-password']); if ($h88162!=''){ if (@t6e52(USER_FOLDER. '/password-hash.psa',serialize(m4c49($h88162)))) { k8a40($_strings['gs--password-changed'],E2E_MESSAGE); e2_go_to(); } else { k8a40($_strings['er--could-not-change-password'],E2E_PERMISSIONS_ERROR); e2_go_to(t83c8('e2m_password')); } } else { k8a40($_strings['er--no-password-entered'],E2E_USER_ERROR); e2_go_to(t83c8('e2m_password')); } } else { k8a40($_strings['er--wrong-password'],E2E_USER_ERROR); e2_go_to(t83c8('e2m_password')); } die; } function e2s_sign_in_necessary(){ e2_go_to(t83c8('e2m_sign_in')); die; } function e2s_sign_in(){ global$_strings; $f2d6d8=z7785(); if($_SERVER['REQUEST_METHOD']=='POST'){ $m5f4dc=@$_POST['password']; $p6bc8e=@$_POST['is_public_pc']; } else { $m5f4dc=@$_GET['password']; $p6bc8e=false; } if (qa8cf($m5f4dc)) { $o21d6f=array ( 'stamp' => time(), 'remote_ip' => $_SERVER['REMOTE_ADDR'], 'key_hash' => me8ed($p6bc8e), 'ua' => $_SERVER['HTTP_USER_AGENT'], ); $f2d6d8['sessions'][] = $o21d6f; } elseif(strlen(trim($m5f4dc)) > 0){ qa711(); k8a40($_strings['er--wrong-password'],E2E_USER_ERROR); } if (!o1d21($f2d6d8)) { k8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); e2_go_to(); die; } l4930(); die; } function e2s_drop_other_sessions(){ global$_strings; $f2d6d8=z7785(); foreach ($f2d6d8['sessions'] as $z8ce4b => $s9e366){ $s3c6e0=$_COOKIE[c8c3b('key')]; if (m4c49($s3c6e0)===$s9e366['key_hash']) { $o21d6f=$s9e366; break; } } $f2d6d8['sessions'] = array ($o21d6f); if (!o1d21($f2d6d8)) { k8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } l4930(); die; } function qa8cf($m5f4dc){ $o8e9a8=@unserialize(scdf0(USER_FOLDER. '/password-hash.psa')); return (m4c49($m5f4dc)===$o8e9a8 and trim($m5f4dc)!=''); } function me8ed($c2a2a4=false){ global$settings; $s3c6e0=j2a24(); $c3f363=m4c49($s3c6e0); ec64a('key',$s3c6e0, !$c2a2a4); return $c3f363; } function oe852(){ global $n1c0b7,$settings,$_auth_sessions; if (isset ($n1c0b7)) return $n1c0b7; $n1c0b7=false; if (isset ($_COOKIE[c8c3b('key')])) { $s3c6e0=$_COOKIE[c8c3b('key')]; $f2d6d8=z7785(); $z0f83b=array(); if(array_key_exists('sessions',$f2d6d8) and is_array($f2d6d8['sessions'])) { foreach ($f2d6d8['sessions'] as $o21d6f){ $z0f83b[] = $o21d6f['key_hash']; } $_auth_sessions['count']=count($f2d6d8['sessions']); } if(1){ $n1c0b7=(bool)in_array(m4c49($s3c6e0),$z0f83b,true); } if (!$n1c0b7){ ec64a('key',''); } } return $n1c0b7; } function m4c49($m25d90){ if(function_exists('sha1')) { return sha1($m25d90); } else { return substr(md5($m25d90).md5(' '.$m25d90),0,40); } } function z7785(){ if(is_file(USER_FOLDER.'auth.psa')) { $f2d6d8=unserialize(@file_get_contents(USER_FOLDER.'auth.psa')); if ($f2d6d8) return $f2d6d8; } return array (); } function o1d21($f2d6d8){ return scd2d(USER_FOLDER.'auth.psa',serialize($f2d6d8)); } function eff2e(){ if ($s3c6e0=$_COOKIE[c8c3b('key')]) { return 'Cookie: '. c8c3b('key') .'='. $s3c6e0 ."\r\n"; } return ''; } function ge68c($uc48ba){ global$_strings; $i74546=array ( 'e2m_write' => 'write', 'e2m_note_edit' => 'note-edit', 'e2m_note_withdraw' => 'note-withdraw', 'e2m_comment_edit' => 'comment-edit', 'e2m_comment_reply' => 'comment-reply', 'e2m_drafts' => 'drafts', 'e2m_draft' => 'draft', 'e2m_tag_edit' => 'tag-edit', 'e2m_name_and_author' => 'name-and-author', 'e2m_settings' => 'settings', 'e2m_password' => 'password', 'e2m_database' => 'database', 'e2m_sessions' => 'sessions', ); if(array_key_exists($uc48ba,$i74546)) { return e2l_get_string( 'gs--need-password-for-action', array ('action' => $_strings['gs--np-action-'. $i74546[$uc48ba]]) ); } else { return$_strings['gs--need-password']; } } function xcc31($n5269f){ global$_strings; if(strstr($n5269f,'iPhone')) return$_strings['gs--ua-iphone']; if(strstr($n5269f,'iPad')) return$_strings['gs--ua-ipad']; if(strstr($n5269f,'Opera'))$v2cb9d=$_strings['gs--ua-opera']; if(strstr($n5269f,'Firefox'))$v2cb9d=$_strings['gs--ua-firefox']; if(strstr($n5269f,'Chrome'))$v2cb9d=$_strings['gs--ua-chrome']; if(strstr($n5269f,'Safari') and !strstr($n5269f,'Chrome'))$v2cb9d=$_strings['gs--ua-safari']; if (!$v2cb9d)$v2cb9d=$_strings['gs--ua-unknown']; if(strstr($n5269f,'Macintosh')) { if ($v2cb9d)$v2cb9d.=' '. $_strings['gs--ua-for-mac']; } return $v2cb9d; } function e2j_check_password(){ $o8e9a8=@unserialize(scdf0(USER_FOLDER. '/password-hash.psa')); $m5f4dc=''; if(array_key_exists('password',$_POST))$m5f4dc=$_POST['password']; qa711(); if (m4c49($m5f4dc)===$o8e9a8 and trim($m5f4dc)!=''){ die ('password-correct'); } die ('password-wrong'); } function j2a24(){ $fb04ec=''; $fb8d1b='0123456789abcdef'; for ($c865c0=0; $c865c0 < 40; $c865c0++)$fb04ec.=$fb8d1b[mt_rand(0,15)]; $fb04ec.=time(); $fb04ec=m4c49($fb04ec); return $fb04ec; } function qa711(){ if(is_file(USER_FOLDER. 'password-wait.psa')) { $uaf788=unserialize(scdf0(USER_FOLDER. '/password-wait.psa')); if ($uaf788['delay'] < 5){ $uaf788['delay'] ++; } if(time()-$uaf788['time'] > SECONDS_IN_A_MINUTE){ $uaf788['delay']=0; } $uaf788['time']=time(); } else { $uaf788=array ( 'time' => time(), 'delay' => 5, ); } scd2d(USER_FOLDER.'password-wait.psa',serialize($uaf788)); sleep($uaf788['delay']); } function s7874(){ return md5('seсret'); } function x1305($xb45cf){ $s3c6e0=s7874(); $a16ec1=strlen($s3c6e0); $v2db95=strlen($xb45cf); $v2cb9d=''; for ($c865c0=0; $c865c0 < $v2db95+rand(16,64); ++ $c865c0){ if ($c865c0 > $v2db95){ $k462e1=rand(0,127); } elseif ($c865c0==$v2db95){ $k462e1=0; } else { $k462e1=ord($xb45cf[$c865c0]); } $r18e1b=chr(($k462e1+ord($s3c6e0[$c865c0%$a16ec1])) % 256); $v2cb9d.=$r18e1b; } $v2cb9d=base64_encode($v2cb9d); return $v2cb9d; } function kee85($xb45cf){ $s3c6e0=s7874(); $a16ec1=strlen($s3c6e0); $xb45cf=base64_decode($xb45cf); $v2db95=strlen($xb45cf); $v2cb9d=''; for ($c865c0=0; $c865c0 < $v2db95; ++ $c865c0){ $pd9468=(ord($xb45cf[$c865c0]) + 256-ord($s3c6e0[$c865c0%$a16ec1])) % 256; if ($pd9468===0) break; $v2cb9d.=chr($pd9468); } return $v2cb9d; } $_candies_installer=array ( 'e2s_build', 'e2m_info', 'e2m_install', 'e2j_check_db_config', 'e2j_list_databases', 'e2s_instantiate', 'e2s_install', 'e2s_update_perform', ); $_candies_public=array ( 'e2m_info', 'e2m_frontpage', 'e2m_frontpage_rss', 'e2m_note', 'e2m_note_comment', 'e2m_note_comments_rss', 'e2m_tags', 'e2m_tag', 'e2m_tag_rss', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_found_rss', 'e2m_comments', 'e2m_everything', 'e2m_year', 'e2m_month', 'e2m_day', 'e2m_unsubscribe', 'e2m_sign_out', 'e2s_sign_in', 'e2s_comment_process', 'e2s_search', 'e2j_check_password', ); $_candies_with_notes=array ( 'e2m_frontpage', 'e2m_note', 'e2m_tag', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_comments', 'e2m_year', 'e2m_month', 'e2m_day', ); $_candies_spawning=array ( 'e2m_frontpage', 'e2m_note', 'e2m_year', 'e2m_month', 'e2m_day', 'e2m_write', 'e2m_drafts', 'e2m_draft', 'e2m_name_and_author', 'e2m_settings', 'e2m_password', 'e2m_database', 'e2m_timezone', 'e2m_sessions', ); $_candies_public=array_merge($_candies_public,$_candies_installer); $_candies_unabortable=array ( ); $_candies_parents=array ( 'e2m_note' => 'e2m_tag', 'e2m_tag' => 'e2m_tags', ); $_candies_indexable=array ( 'e2m_note', ); $_candies_indexable_conditionally=array ( 'e2m_frontpage', 'e2m_tag', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_tags', 'e2m_everything', ); $_candies_ajax=array ( 'e2j_check_db_config', 'e2j_list_databases', 'e2j_check_password', 'e2j_userpic_upload', 'e2j_file_upload', 'e2j_file_remove', 'e2j_note_livesave', 'e2m_note_flag_favourite', 'e2m_comment_flag_ajax', 'e2m_tag_flag_ajax', ); function e2_modes($parameters){ global $b11755,$content,$settings,$f1e2ad,$full_blog_url,$m589b3,$_config,$_strings,$s_addurl,$stopwatch,$_candy,$_db_error,$_candies_with_notes; if (!is_array($parameters))$parameters=array(); if(array_key_exists('~',$parameters)) { $c71860=$parameters['~']; } if(e2_is_installed()) { if(__LOG)__log('Popular and tags menu {'); $content['popular'] = array ( 'title' => $_strings['nm--most-read'], ); $content['popular']['each']=q0256(); if(count($content['popular']['each']) < 10) unset($content['popular']['each']); $content['tags']['each']=z5d57(); $content['tags']['many?']=count($content['tags']['each']) > KEYWORDS_MANY_THRESH; $content['tags']['menu-each']=zaf16($parameters); if(__LOG)__log('} // Popular and tags menu'); } } function w6f51(){ global$settings,$_strings; if ( array_key_exists('site_title',$settings) and trim($settings['site_title']) != '' ){ return trim($settings['site_title']); } else { return$_strings['e2--default-blog-title']; } } function x2640(){ global$settings,$_strings; if ( array_key_exists('author',$settings) and trim($settings['author']) != '' ){ return trim($settings['author']); } else { return$_strings['e2--default-blog-author']; } } function e2m_info(){ global$settings,$_config,$d57de2,$ca57c1,$_template; $vf1f71=array ( 'E2_VERSION' => E2_VERSION, 'E2_RELEASE' => E2_RELEASE, 'E2_UA_STRING' => E2_UA_STRING, '---', 'installed' => (bool)e2_is_installed(), 'server_name' => $d57de2, 'folder_on_server' => $ca57c1, '---', 'request_logging' => $_config['request_logging'], 'default formatter' => $_config['default_formatter'], '---', 'theme' => $settings['template'], '---', 'Olba name' => $_template['name'], 'Olba max_image_width' => $_template['max_image_width'], 'Olba stack' => $_template['stack'], '---', 'Neasden' => substr(md5(file_get_contents('system/neasden/neasden.php')), 0,4), '---', ); echo '<pre>'; foreach ($vf1f71 as $z8ce4b => $s9e366){ if ($s9e366=='---'){ echo "\n"; continue; } echo str_pad($z8ce4b,24); echo '\''; print_r($s9e366); echo '\''; echo "\n"; } echo '</pre>'; die; } function e2m_frontpage($parameters=array ()) { global$settings,$_config,$_strings; $c71860=$parameters['page']; $rd7e5d=$settings['appearance']['notes_per_page']; $q06d2e=i8ca0(true,true); if (oe852())$q06d2e+=i8ca0(true,false); $uae0fe=ceil($q06d2e/$rd7e5d); $qd29bb=CACHE_FILENAME_FRONTPAGE; if (oe852())$qd29bb=CACHE_FILENAME_FRONTPAGE_AUTHOR; if ($c71860 < 1) return e2_error404_mode(); if(CACHE_FRONTPAGE and $c71860==1 and is_file($qd29bb)) { $y4358b=@unserialize(scdf0($qd29bb)); } if(CACHE_FRONTPAGE and $c71860==1 and is_array($y4358b)) { } else { if (($result=n50d7('web',$c71860)) === false){ k8a40($_strings['er--cannot-show-latest-notes'],E2E_DATABASE_ERROR); return array ( 'title' => htmlspecialchars(w6f51(),ENT_NOQUOTES,HSC_ENC), ); } $y4358b=array(); if(count($result) > 0){ foreach($result as $z8ce4b => $saad65){ $saad65['_']['_id']=$saad65['ID']; $saad65['_']['_title']=jea9c($saad65); $saad65['_']['_ord']=$z8ce4b; $saad65['_']['_ord_max']=count($result)-1; $xe244c=z6791($saad65); $y4358b[] = $xe244c; } } else { if ($c71860!=1) return e2_error404_mode(); } if(CACHE_FRONTPAGE and $c71860==1)t6e52($qd29bb,serialize($y4358b)); } $lb3b32['timeline?']=true; $lb3b32['count']=$uae0fe; $lb3b32['this'] = (int)$c71860; if ($uae0fe > 1){ if ($c71860 < $uae0fe)$lb3b32['earlier-href']=t83c8('e2m_frontpage', array ('page' => $c71860+1)); if ($c71860 > 1)$lb3b32['later-href']=t83c8('e2m_frontpage', array ('page' => $c71860-1)); $lb3b32['earlier-title']=$_strings['gs--earlier']; $lb3b32['later-title']=$_strings['gs--later']; } $id5d3d=w6f51(); return array ( 'frontpage?' => (bool) ($c71860==1), 'title' => $id5d3d, 'notes' => $y4358b, 'pages' => $lb3b32, ); } function e2m_frontpage_rss($parameters=array ()) { global$settings; $qd29bb=CACHE_FILENAME_FRONTPAGE_RSS; if(CACHE_FRONTPAGE_RSS and is_file($qd29bb)) { if(__LOG)__log('RSS: cached'); $sed0d3=@unserialize(scdf0($qd29bb)); $wf0e70=filemtime($qd29bb); } else { if(__LOG)__log('RSS: not cached, will need to build'); $sed0d3=''; $wf0e70=0; if (($result=n50d7('rss')) !== false){ foreach($result as $saad65){ if ($saad65['IsVisible'] and $saad65['IsPublished']) { $sed0d3.=p307d($saad65); $wf0e70=max($wf0e70,$saad65['Stamp']); } } } if(CACHE_FRONTPAGE_RSS)t6e52($qd29bb,serialize($sed0d3)); } $sed0d3=str_replace("\x0",'',$sed0d3); s7be5( $sed0d3, $wf0e70, $settings['site_title'], t83c8('e2m_frontpage') ); die; } function e2m_note_comments_rss($parameters=array ()) { global$settings,$_config,$_strings; $saad65=e2_published_noterec_with_parameters_($parameters); $wf0e70=0; $i93759=''; if ( ($result=p1baf($saad65['ID'],"AND `Stamp` > ". (time()-SECONDS_IN_A_MONTH) ." ORDER BY `Stamp` DESC LIMIT ". $_config['rss_items'])) !== false ){ foreach($result as $c06d4c){ if ($c06d4c['IsVisible'] and !$c06d4c['IsSpamSuspect']) { $i93759.=fc6e2($saad65,$c06d4c); $wf0e70=max($wf0e70,$c06d4c['Stamp']); } } } s7be5( $i93759, $wf0e70, $settings['site_title'] .', '. $_strings['gs--comments-on-post'] .': '. $saad65['Title'], t83c8('e2m_note', array ('*note' => $saad65)) ); die; } function e2m_tag_rss($parameters=array ()) { global$settings,$_config,$_strings; if(array_key_exists('*tag',$parameters)) { $oe4d23=$parameters['*tag']; } else { return e2_error404_mode(); } $y56790[] = ( "`". $_config['db_table_prefix'] . "NotesKeywords`.KeywordID=". $oe4d23['ID'] ); $y56790=implode(' OR ',$y56790); $rc2b7b=$_config['db_table_prefix']; return lcbfb( "INNER JOIN `". $rc2b7b."NotesKeywords` ". "ON `". $rc2b7b."NotesKeywords`.NoteID=`". $rc2b7b."Notes`.ID ". "WHERE (". $y56790 .") ". "ORDER BY `". $rc2b7b ."Notes`.`Stamp` DESC LIMIT ". $_config['rss_items'], $settings['site_title'] .', '. $_strings['gs--posts-tagged'] .': '. $oe4d23['Keyword'], t83c8('e2m_tag',$parameters) ); } function e2m_found_rss($parameters=array ()) { global$_config,$settings,$_strings; $parameters['query']=trim($parameters['query']); $q1b1cc=$parameters['query']; return lcbfb( "WHERE MATCH (`Title`, `Text`) AGAINST ('". i7928(preg_quote($q1b1cc)). "') ORDER BY `Stamp` DESC LIMIT ". $_config['rss_items'], $settings['site_title'] .', '. $_strings['gs--search-results'] .': '. $q1b1cc, t83c8('e2m_found',$parameters) ); } function lcbfb($x15c46,$id5d3d,$g2a304){ global$settings,$_config; $v8bb85=''; $wf0e70=0; if ((r0738( "SELECT `". $_config['db_table_prefix']."Notes`.* ". "FROM `". $_config['db_table_prefix']."Notes` ". $x15c46 )) !== false){ $result=a0d6b(); foreach($result as $saad65){ if ($saad65['IsVisible'] and $saad65['IsPublished']) { $v8bb85.=p307d($saad65); $wf0e70=max($wf0e70,$saad65['Stamp']); } } } s7be5( $v8bb85, $wf0e70, $id5d3d, $g2a304 ); die; } function d3010($id5d3d,$ae8fab){ global$_newsfeeds; $w336a4=array ('title' => $id5d3d,'href' => $ae8fab); $_newsfeeds[] = $w336a4; } function p307d($saad65){ global$settings,$d57de2; $e90141=t83c8('e2m_note', array ('*note' => $saad65)); $v8bb85=''; $v8bb85.='<item>'; $v8bb85.='<title>'. (g6f10(htmlspecialchars(jea9c($saad65),ENT_NOQUOTES,HSC_ENC))) .'</title>'; $v8bb85.='<guid isPermaLink="true">'. $e90141 .'</guid>'; $v8bb85.='<link>'. $e90141 .'</link>'; if (@$settings['comments']['on']) { $v8bb85.='<comments>'. $e90141 .'</comments>'; } $s67daf=i154e($saad65['FormatterID'], @$saad65['Text'],'full-rss'); $s67daf=$s67daf['text-final']; for ($c865c0=0; $c865c0 < strlen($s67daf); ++$c865c0){ if(ord($s67daf[$c865c0]) < 32 and !in_array(ord($s67daf[$c865c0]), array (10,13))) { $s67daf[$c865c0]=''; } } $v8bb85.='<description>'; $v8bb85.=htmlspecialchars($s67daf,ENT_NOQUOTES,HSC_ENC); $v8bb85.='</description>'; $y588e0 = ia846('D, d M Y H:i:s ',$saad65['Stamp']) . vd536($saad65['Stamp']); $v8bb85.='<pubDate>'. $y588e0 .'</pubDate>'; $v8bb85.='</item>'; return $v8bb85; } function fc6e2($saad65,$c06d4c){ global$settings,$d57de2,$_strings; $e90141=t83c8('e2m_note', array ('*note' => $saad65)); $h0ad4f = '<b>'. htmlspecialchars($c06d4c['AuthorName'],ENT_NOQUOTES,HSC_ENC) .'</b>, '. $_strings['gs--comment-on-post'] .' <a href="'. $e90141 .'">"'. g6f10(htmlspecialchars(jea9c($saad65),ENT_NOQUOTES,HSC_ENC)) .'"</a>'; $v8bb85=''; $v8bb85.='<item>'; $v8bb85.='<title>'. strip_tags($h0ad4f) .'</title>'; $v8bb85.='<link>'. $e90141 .'</link>'; $s67daf=$h0ad4f.':'; $s67daf.='<br /><br />'; $a64be6=i154e($saad65['FormatterID'],$c06d4c['Text'],'simple-rss'); $a64be6=$a64be6['text-final']; $s67daf.=$a64be6; for ($c865c0=0; $c865c0 < strlen($s67daf); ++$c865c0){ if(ord($s67daf[$c865c0]) < 32 and !in_array(ord($s67daf[$c865c0]), array (10,13))) { $s67daf[$c865c0]=''; } } $v8bb85.='<description>'; $v8bb85.=htmlspecialchars($s67daf,ENT_NOQUOTES,HSC_ENC); $v8bb85.='</description>'; $y588e0 = ia846('D, d M Y H:i:s ',$c06d4c['Stamp']) . vd536($c06d4c['Stamp']); $v8bb85.='<pubDate>'. $y588e0 .'</pubDate>'; $v8bb85.='</item>'; return $v8bb85; } function s7be5($t691d5,$wf0e70,$id5d3d,$g2a304){ global$settings; $content=array ( 'title' => htmlspecialchars($id5d3d,ENT_NOQUOTES,HSC_ENC), 'link' => $g2a304, 'generator' => E2_UA_STRING, 'items' => $t691d5, ); if(array_key_exists('description',$settings)) { $content['description']=htmlspecialchars($settings['description'],ENT_NOQUOTES,HSC_ENC); } $p54870=gmdate('r',$wf0e70); $w1872a=md5($wf0e70); header('Content-type: application/xml; charset=utf-8'); header('Last-modified: '.$p54870); header('Etag: '.$w1872a); header('Cache-Control: public'); header('Expires: '. date('r',$wf0e70+SECONDS_IN_A_DAY)); $i0c3cd=isset($_SERVER['HTTP_IF_MODIFIED_SINCE'])? stripslashes($_SERVER['HTTP_IF_MODIFIED_SINCE']): false; $ec3522=isset($_SERVER['HTTP_IF_NONE_MATCH'])? stripslashes($_SERVER['HTTP_IF_NONE_MATCH']): false; if ( !$i0c3cd && !$ec3522 or $ec3522 && $ec3522!=$w1872a or $i0c3cd && $i0c3cd!=$p54870 ){ $l92eac=DEFAULTS_FOLDER.'rss/rss.tmpl.php'; if(is_file($l92eac)) { ob_start(); include $l92eac; $v8bb85=ob_get_contents(); ob_end_clean(); } echo $v8bb85; } else { header('HTTP/1.1 304 Not Modified'); } } function e2m_year($parameters=array ()) { global$_strings,$_config; $k84cdc=$parameters['year']; $g09d6c=e2l_get_string('pt--nth-year', array ('year' => $k84cdc)); if (!i1665($k84cdc)) { return e2_error404_mode(); } $ke6e7d=gmmktime(0,0,0,1,1,$k84cdc-1); $w029bd=gmmktime(0,0,0,1,1,$k84cdc+1); list ($p8aebd,$q5a7f3)=e2__fruitful_neighbours_with_ymd_($k84cdc); $ca6d40='e2m_year'; if ($p8aebd){ $lb3b32['prev-href']=t83c8( $ca6d40,e2__parameters_with_timestamp_($p8aebd) ); $lb3b32['prev-jump?'] = (bool) (gmdate('Y',$ke6e7d)!=gmdate('Y',$p8aebd)); $lb3b32['prev-title']=gmdate('Y',$p8aebd); } if ($q5a7f3){ $lb3b32['next-href']=t83c8( $ca6d40,e2__parameters_with_timestamp_($q5a7f3) ); $lb3b32['next-jump?'] = (bool) (gmdate('Y',$w029bd)!=gmdate('Y',$q5a7f3)); $lb3b32['next-title']=gmdate('Y',$q5a7f3); } $lb3b32['timeline?']=false; $lb3b32['this']=$k84cdc; $lb3b32['this-title']=$k84cdc; $jb2442=tcc02('start'); $q8dbc7=tcc02('end'); if ( $k84cdc==r5a2f('Y',$jb2442['stamp'],$jb2442['timezone']) ) { $yfa098=r5a2f('m',$jb2442['stamp'],$jb2442['timezone']); } else { $yfa098=1; } if ( $k84cdc==ia846('Y',time()) ) { $tfd384=ia846('m',time()); } else { $tfd384=12; } $h6eac3=lb92c($k84cdc); for ($n7436f=1; $n7436f <= 12; ++ $n7436f){ $y7f769=gmmktime(0,0,0,$n7436f,1,$k84cdc); $gd039b[$n7436f] = array ( 'number' => $n7436f, 'start-time' => array ($y7f769,m3211()), 'href' => gmdate('Y/m/',$y7f769), 'real?' => $n7436f >= $yfa098 and $n7436f <= $tfd384, 'fruitful?' => @in_array(gmdate('n',$y7f769),$h6eac3), ); } list ($z7b314,$ia1f20)=x5273($k84cdc); r0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND `IsVisible` = 1 ". "AND `Stamp` BETWEEN ". $z7b314 ." ". "AND ". $ia1f20 ." ". "ORDER BY `Stamp`" ); $result=a0d6b(); $y4358b=n28df($result,$k84cdc); $v2cb9d=array ( 'title' => $g09d6c, 'heading' => $g09d6c, 'pages' => $lb3b32, 'year' => (int)$k84cdc, 'year-months' => $gd039b, ); if(count($y4358b)) { $v2cb9d['notes-list']=$y4358b; } else { $v2cb9d['nothing']=$_strings['gs--no-such-notes']; } return $v2cb9d; } function e2m_month($parameters=array ()) { global$_strings,$_config; $k84cdc= $parameters['year']; $n7436f=$parameters['month']; $g09d6c=e2l_get_string( 'pt--nth-month-of-nth-year', array ('year' => $k84cdc,'month' => $n7436f) ); if (!i1665($k84cdc,$n7436f)) { return e2_error404_mode(); } $ke6e7d=gmmktime(0,0,0,$n7436f-1,1,$k84cdc); $w029bd=gmmktime(0,0,0,$n7436f+1,1,$k84cdc); list ($p8aebd,$q5a7f3)=e2__fruitful_neighbours_with_ymd_($k84cdc,$n7436f); $ca6d40='e2m_month'; if ($p8aebd){ $lb3b32['prev-href']=t83c8( $ca6d40,e2__parameters_with_timestamp_($p8aebd) ); $lb3b32['prev-jump?'] = (bool) (gmdate('Y/m',$ke6e7d)!=gmdate('Y/m',$p8aebd)); $lb3b32['prev-title']=e2l_get_string( 'gs--nth-month-of-nth-year', array ( 'year' => gmdate('Y',$p8aebd),'month' => gmdate('n',$p8aebd) ) ); } if ($q5a7f3){ $lb3b32['next-href']=t83c8( $ca6d40,e2__parameters_with_timestamp_($q5a7f3) ); $lb3b32['next-jump?'] = (bool) (gmdate('Y/m',$w029bd)!=gmdate('Y/m',$q5a7f3)); $lb3b32['next-title']=e2l_get_string( 'gs--nth-month-of-nth-year', array ( 'year' => gmdate('Y',$q5a7f3),'month' => gmdate('n',$q5a7f3) ) ); } $lb3b32['timeline?']=false; $lb3b32['this-title']=$g09d6c; list ($z7b314,$ia1f20)=x5273($k84cdc,$n7436f); r0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND `IsVisible` = 1 ". "AND `Stamp` BETWEEN ". $z7b314 ." ". "AND ". $ia1f20 ." ". "ORDER BY `Stamp`" ); $result=a0d6b(); $y4358b=n28df($result,$k84cdc,$n7436f); $me70c4['title']=$g09d6c; $me70c4['heading']=$g09d6c; $me70c4['pages']=$lb3b32; $me70c4['year'] = (int)$k84cdc; $me70c4['month'] = (int)$n7436f; $me70c4['month-days']=e2_pack_month_days_with_ymd_($k84cdc,$n7436f,false); if(count($y4358b)) { $me70c4['notes-list']=$y4358b; } else { $me70c4['nothing']=$_strings['gs--no-such-notes']; } return $me70c4; } function e2m_day($parameters=array ()) { global$_strings; $k84cdc= (int)$parameters['year']; $n7436f=(int)$parameters['month']; $g628b7= (int)$parameters['day']; if (!(i1665($k84cdc,$n7436f,$g628b7))) { return e2_error404_mode(); } $g09d6c=e2l_get_string( 'pt--nth-day-of-nth-month-of-nth-year', array ('year' => $k84cdc,'month' => $n7436f,'day' => $g628b7) ); $ke6e7d=gmmktime(0,0,0,$n7436f,$g628b7-1,$k84cdc); $w029bd=gmmktime(0,0,0,$n7436f,$g628b7+1,$k84cdc); list ($p8aebd,$q5a7f3)=e2__fruitful_neighbours_with_ymd_($k84cdc,$n7436f,$g628b7); $ca6d40='e2m_day'; if ($p8aebd){ $lb3b32['prev-href']=t83c8( $ca6d40,e2__parameters_with_timestamp_($p8aebd) ); $lb3b32['prev-jump?'] = (bool) (gmdate('Y/m/d',$ke6e7d)!=gmdate('Y/m/d',$p8aebd)); $lb3b32['prev-title']=e2l_get_string( 'gs--nth-day-of-nth-month-of-nth-year', array ( 'year' => gmdate('Y',$p8aebd),'month' => gmdate('n',$p8aebd),'day' => gmdate('j',$p8aebd), ) ); } if ($q5a7f3){ $lb3b32['next-href']=t83c8( $ca6d40,e2__parameters_with_timestamp_($q5a7f3) ); $lb3b32['next-jump?'] = (bool) (gmdate('Y/m/d',$w029bd)!=gmdate('Y/m/d',$q5a7f3)); $lb3b32['next-title']=e2l_get_string( 'gs--nth-day-of-nth-month-of-nth-year', array ( 'year' => gmdate('Y',$q5a7f3),'month' => gmdate('n',$q5a7f3),'day' => gmdate('j',$q5a7f3), ) ); } $lb3b32['timeline?']=false; $lb3b32['this-title']=$g09d6c; if (($result=kf9fb($k84cdc,$n7436f,$g628b7)) !== false){ $result=array_reverse($result); foreach($result as $z8ce4b => $saad65){ if ($saad65['IsVisible'] or oe852()) { $saad65['_']['_id']=$saad65['ID']; $saad65['_']['_ord']=k; $saad65['_']['_ord_max']=count($result)-1; $y4358b[] = z6791($saad65); } } } $me70c4['title']=$g09d6c; $me70c4['heading']=$g09d6c; $me70c4['pages']=$lb3b32; $me70c4['month-days']=e2_pack_month_days_with_ymd_($k84cdc,$n7436f,$g628b7); if(count($y4358b)) { $me70c4['notes']=$y4358b; } else { $me70c4['nothing']=$_strings['gs--no-such-notes']; } return $me70c4; } function e2m_everything($parameters=array ()) { global$_strings,$_config; $y4358b=null; if(CACHE_FULLLIST and is_file(CACHE_FILENAME_FULLLIST)) { $y4358b=@unserialize(scdf0(CACHE_FILENAME_FULLLIST)); if(__LOG)__log('Everything: retrieving from cache...'); } if (!is_array($y4358b)) { if(__LOG)__log('Everything: retrieving from database...'); r0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND `IsVisible` = 1 ". "ORDER BY `Stamp`" ); $result=a0d6b(); if(__LOG)__log('Everything: preparing notes list...'); $y4358b=n28df($result); if(__LOG)__log('Everything: saving cache...'); if(CACHE_FULLLIST)t6e52(CACHE_FILENAME_FULLLIST,serialize($y4358b)); } $e1f525=count($y4358b); $g09d6c=e2l_get_string('pt--n-posts', array ('number' => $e1f525)); if(array_key_exists('part',$_GET) and array_key_exists('of',$_GET)) { if(__LOG)__log('Everything: splitting into parts...'); $qf4c93=$_GET['part']; $d8bf88=$_GET['of']; $g09d6c.=' ('. e2l_get_string('gs--part-x-of-y', array ('part' => $qf4c93,'of' => $d8bf88)) .')'; $j895e3=$e1f525/$d8bf88; $dd98a0=($qf4c93-1)*$j895e3; $p01b6e=$qf4c93*$j895e3; $y4358b=array_slice($y4358b,round($dd98a0),round($p01b6e-round($dd98a0))); } if(__LOG)__log('Everything: done, returning'); $me70c4['class']='everything'; $me70c4['title']=$g09d6c; $me70c4['heading']=$g09d6c; if(count($y4358b)) { $me70c4['notes-list']=$y4358b; } else { $me70c4['nothing']=$_strings['gs--no-notes']; } return $me70c4; } function e2_pack_month_days_with_ymd_($k84cdc,$n7436f,$g628b7){ $la6933=r5a2f('t',gmmktime(0,0,0,$n7436f,1,$k84cdc),m3211()); $jb2442=tcc02('start'); $q8dbc7=tcc02('end'); if ( $k84cdc .'/'. $n7436f == r5a2f('Y/n',$jb2442['stamp'],$jb2442['timezone']) ) { $k42eb4=r5a2f('d',$jb2442['stamp'],$jb2442['timezone']); } else { $k42eb4=1; } if ( $k84cdc .'/'. $n7436f == ia846('Y/n',time()) ) { $id5f50=ia846('d',time()); } else { $id5f50=$la6933; } $ye4602=c82dc($k84cdc,$n7436f); for ($c865c0=1; $c865c0 <= $la6933; ++ $c865c0){ $y7f769=gmmktime(0,0,0,$n7436f,$c865c0,$k84cdc); $a271c1[$c865c0] = array ( 'number' => $c865c0, 'start-time' => array ($y7f769,m3211()), 'href' => gmdate('Y/m/d/',$y7f769), 'this?' => (bool) ($c865c0==$g628b7), 'real?' => $c865c0 >= $k42eb4 and $c865c0 <= $id5f50, 'fruitful?' => @in_array(gmdate('d',$y7f769),$ye4602), ); } return $a271c1; } function i1665($k84cdc,$n7436f=false,$g628b7=false){ $jb2442=tcc02('start'); if ($jb2442===false){ return false; } $gc1f1e=r5a2f('Y',$jb2442['stamp'],$jb2442['timezone']); $qebeb3=ia846('Y',time()); if ($n7436f===false){ return (bool) ( $k84cdc >= $gc1f1e and $k84cdc <= $qebeb3 ); } else { $f782fc=r5a2f('n',$jb2442['stamp'],$jb2442['timezone']); $s13dd1=ia846('n',time()); if ($g628b7===false){ return (bool) ( $n7436f >= 1 and $n7436f <= 12 and ( ($k84cdc > $gc1f1e and $k84cdc < $qebeb3) or ($k84cdc==$gc1f1e and $n7436f >= $f782fc) or ($k84cdc==$qebeb3 and $n7436f <= $s13dd1) ) ); } else { $b7a9c0=r5a2f('j',$jb2442['stamp'],$jb2442['timezone']); $l23209=ia846('j',time()); if(1){ return (bool) ( checkdate($n7436f,$g628b7,$k84cdc) and ( ($k84cdc > $gc1f1e and $k84cdc < $qebeb3) or ($k84cdc==$gc1f1e and $n7436f > $f782fc) or ($k84cdc==$gc1f1e and $n7436f==$f782fc and $g628b7 >= $b7a9c0) or ($k84cdc==$qebeb3 and $n7436f < $s13dd1) or ($k84cdc==$qebeb3 and $n7436f==$s13dd1 and $g628b7 <= $l23209) ) ); } } } } function e2__fruitful_neighbours_with_ymd_($i41529,$v6f8f5=false,$v8277e=false){ global$_db,$_config; list ($d3d2fa,$y9468c)=x5273($i41529,$v6f8f5,$v8277e); $aada4b=SECONDS_IN_A_DAY; if ($v8277e===false)$aada4b=SECONDS_IN_A_MONTH; if ($v6f8f5===false)$aada4b=SECONDS_IN_A_YEAR; if (!oe852())$hf79b1="`IsVisible`=1 AND "; if (u0f7c()) { $_db['result']=mysqli_query( $_db['link'], "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']. "Notes` ". "WHERE `IsPublished`=1 AND " .@$hf79b1. "Stamp < '". ($y9468c-$aada4b) ."' ". "ORDER BY Stamp DESC" ); while ($g6438c=@mysqli_fetch_array($_db['result'],MYSQLI_ASSOC)) { list ($k84cdc,$n7436f,$g628b7)=explode('/', r5a2f('Y/n/j',$g6438c['Stamp'],i0923($g6438c)) ); $t7474d=$i41529*10000 + ($v6f8f5? ($v6f8f5*100):0) + ($v8277e? $v8277e:0); $bbd8da=$k84cdc*10000 + ($v6f8f5? ($n7436f*100):0) + ($v8277e? $g628b7:0); if ($bbd8da < $t7474d){ $kbf025=gmmktime(0,0,0,$n7436f,$g628b7,$k84cdc); break; } } $_db['result']=mysqli_query( $_db['link'], "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']. "Notes` ". "WHERE `IsPublished`=1 AND " .@$hf79b1. "Stamp > '". ($d3d2fa+$aada4b) ."' ". "ORDER BY Stamp" ); while ($g6438c=@mysqli_fetch_array($_db['result'],MYSQLI_ASSOC)) { list ($k84cdc,$n7436f,$g628b7)=explode('/', r5a2f('Y/n/j',$g6438c['Stamp'],i0923($g6438c)) ); $t7474d=$i41529*10000 + ($v6f8f5? ($v6f8f5*100):0) + ($v8277e? $v8277e:0); $bbd8da=$k84cdc*10000 + ($v6f8f5? ($n7436f*100):0) + ($v8277e? $g628b7:0); if ($bbd8da > $t7474d){ $k8dc98=gmmktime(0,0,0,$n7436f,$g628b7,$k84cdc); break; } } return array ($kbf025,$k8dc98); } } function e2__parameters_with_timestamp_($h96b8c){ list ( $parameters['year'], $parameters['month'], $parameters['day'] ) = explode('/',gmdate('Y/m/d',$h96b8c)); return$parameters; } function n28df($cc2d18,$k84cdc=false,$n7436f=false){ $w229c3=0; $y4358b=array(); $zf09d8=''; $y4358b=array(); $dcc73f=array(); foreach ($cc2d18 as $z8ce4b => $y39a37){ $saad65['href'] = t83c8('e2m_note', array ('*note' => $y39a37)); $saad65['time'] = array ((int)$y39a37['Stamp'],i0923($y39a37)); $saad65['last-modified'] = array ((int)$y39a37['LastModified'],i0923($y39a37)); $saad65['favourite?'] = (bool) ($y39a37['IsFavourite'] && $y39a37['IsPublished']); if ( ($k84cdc and $n7436f and ( ((int)$k84cdc) .'/'. ((int)$n7436f) == r5a2f('Y/n',$y39a37['Stamp'],i0923($y39a37)) )) or ($k84cdc and !$n7436f and ( (int)$k84cdc == r5a2f('Y',$y39a37['Stamp'],i0923($y39a37)) )) or (!$k84cdc and !$n7436f) ) { array_unshift($y4358b,$saad65); array_unshift($dcc73f,str_replace("\n",' ',jea9c($y39a37))); } } $n789f1=implode("\n",$dcc73f); if(strlen($n789f1) < 20000){ $n789f1=g6f10(htmlspecialchars($n789f1,ENT_NOQUOTES,HSC_ENC)); $dcc73f=explode("\n",$n789f1); } foreach ($y4358b as $z8ce4b => $s9e366){ $y4358b[$z8ce4b]['title']=$dcc73f[$z8ce4b]; } return $y4358b; } function e2s_sync(){ e2_drop_all_kinds_of_cache(); die ('All caches clean.'); } function e2_note_cache_filename_with_id_($yb80bb){ return str_replace('*',$yb80bb,CACHE_FILENAMES_NOTES); } function e2_drop_caches_for_note_($v21158){ if(__LOG)__log('Caches: Drop caches for note id '. $v21158); pe2f1(); p22e7(); @unlink(e2_note_cache_filename_with_id_($v21158)); @unlink(e2_note_cache_filename_with_id_($v21158 .'-comments')); @unlink(CACHE_FILENAME_HOT); @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); @unlink(CACHE_FILENAME_FRONTPAGE_RSS); @unlink(CACHE_FILENAME_FULLLIST); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); } function e7996(){ if(__LOG)__log('Caches: Drop notes caches'); dc5a6(CACHE_FILENAMES_NOTES); dc5a6(CACHE_FILENAMES_NOTES_COMMENTS); @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); @unlink(CACHE_FILENAME_FRONTPAGE_RSS); } function pe2f1(){ if(__LOG)__log('Caches: Drop notes counts cache'); dc5a6(CACHE_FILENAMES_NOTES_COUNTS); } function p22e7(){ if(__LOG)__log('Caches: Drop egde time info cache'); dc5a6(CACHE_FILENAMES_EDGE_TIMEINFO); } function e2_drop_all_kinds_of_cache(){ if(__LOG)__log('Caches: Drop all kinds of caches'); dc5a6(CACHES_FOLDER.'*'); return true; } function u4e27($c139c8){ global$_template,$_config; if(__LOG)__log('Olba: Prepare template <'. $c139c8 .'>'); $qaf10b=array(); $t8598c=$c139c8; $y620f7=TEMPLATES_FOLDER.$t8598c .'/'; $x1b14d=false; if ( $c139c8!='' and !array_key_exists('themeless',$_GET) ){ if ( is_dir($y620f7) and is_file($y620f7 .'/theme-info.php') ) { while (1){ $y620f7=TEMPLATES_FOLDER.$t8598c .'/'; array_push($qaf10b,$y620f7); $x38226=include $y620f7 .'/theme-info.php'; $p4e502[$y620f7]=$x38226; if(array_key_exists('max_image_width',$x38226)) { if ($x1b14d===false){ $x1b14d=$x38226['max_image_width']; } } if(array_key_exists('based_on',$x38226)) { $t8598c=$x38226['based_on']; } else { break; } } } else { } } $y620f7=SYSTEM_TEMPLATE_FOLDER; array_push($qaf10b,$y620f7); $x38226=include $y620f7 .'/theme-info.php'; $p4e502[$y620f7]=$x38226; if(array_key_exists('max_image_width',$x38226)) { if ($x1b14d===false){ $x1b14d=$x38226['max_image_width']; } } if ($x1b14d===false){ $x1b14d=$_config['max_image_width']; } $_template['name']=$c139c8; $_template['max_image_width']=$x1b14d; $_template['stack']=$qaf10b; $_template['infos']=$p4e502; }; function c53ee($bd436e){ global$content; ++ $_olba_includes; include $bd436e; } function d6a97($h52678){ if(0){ echo '<div style="background: #ff0">'.$h52678.'</div>'; } if(is_dir(EXTRAS_FOLDER)) { $e71cae=EXTRAS_FOLDER.$h52678 .'.tmpl.php'; if(is_file($e71cae)) { c53ee($e71cae); } } return ''; } function g166b($h52678){ global$_template,$_olba_includes; $e71cae='templates/'. $h52678 .'.tmpl.php'; if ($bd436e=e2o__usable_file_with_basename_($e71cae)) { if(__LOG)__log('Olba: Apply template <'. $bd436e .'>'); c53ee($bd436e); } else { s1928($e71cae); } } function cbc21(){ global$_config; if ( @$_config['raw_template_data'] or @$_config['raw_template_data_with_param'] and array_key_exists('raw',$_GET) ) { $m3f7d9='raw'; } else { $m3f7d9='main'; } return g166b($m3f7d9); } function s1928($d8b7af){ uf1da($d8b7af,'_olba_missing_templates'); } function kd4c1($r45ac4){ uf1da($r45ac4 .'.css','_olba_used_stylesheets'); } function jd00a($m3205c){ uf1da($m3205c .'.js','_olba_used_scripts'); } function p16f0($ne8acc){ foreach (array (SYSTEM_LIBRARY_FOLDER,USER_LIBRARY_FOLDER) as $y71379){ foreach(glob($y71379.$ne8acc .'/*') as $e8c7dd){ $mabf77=pathinfo($e8c7dd,PATHINFO_EXTENSION); if ($mabf77=='js'){ uf1da($e8c7dd,'_olba_used_scripts'); } if ($mabf77=='css'){ uf1da($e8c7dd,'_olba_used_stylesheets'); } } } } function ue655(){ global$_olba_missing_templates; if (isset ($_olba_missing_templates)) { return array_unique($_olba_missing_templates); } } function z94dd(){ global$_template,$_config,$settings; if($_config['list_system_theme']) { $dccf6b['system']=SYSTEM_TEMPLATE_FOLDER; } if ($se1260=@opendir(TEMPLATES_FOLDER)) { while (false !== ($q1f769=readdir($se1260))) { if(is_dir(TEMPLATES_FOLDER. $q1f769) and $q1f769!='.' and $q1f769!='..'){ if(is_file(TEMPLATES_FOLDER.$q1f769 .'/theme-info.php')) { $dccf6b[$q1f769]=TEMPLATES_FOLDER.$q1f769 .'/'; } } } closedir($se1260); } $p10ae9=array(); foreach ($dccf6b as $ub0689 => $l85114){ $x38226=include $l85114 .'theme-info.php'; $jc2657=$x38226['display_name']; if(is_file($fbe5fb=$l85114.$e8c7dd .'preview@2x.png')) { } elseif(is_file($fbe5fb=$l85114.$e8c7dd .'preview.png')) { } else { $fbe5fb=DEFAULTS_FOLDER.'preview@2x.png'; } if(is_array($jc2657)) { if(array_key_exists($settings['language'],$jc2657)) { $jc2657=$jc2657[$settings['language']]; } else { $jc2657=array_shift($jc2657); } } $p10ae9[] = array ( 'name' => $ub0689, 'display-name' => $jc2657, 'current?' => (bool) ($ub0689==$_template['name']), 'preview' => $fbe5fb, ); } return $p10ae9; } function i1492($k435ed){ return e2o__usable_file_with_basename_('images/'. $k435ed); } function sf42c($eb1197){ return file_get_contents(e2o__usable_file_with_basename_('images/'. $eb1197 .'.svg')); } function j576f($r45ac4){ global$_template; $c954eb='styles/'. $r45ac4 .'.css'; $t95aa1=array(); foreach($_template['stack'] as $y620f7){ if(is_file($k435ed=$y620f7.$c954eb)) { $t95aa1[] = $k435ed; } if ( array_key_exists('reset_styles',$_template['infos'][$y620f7]) and in_array($r45ac4,$_template['infos'][$y620f7]['reset_styles']) ) { break; } } $t95aa1=array_reverse($t95aa1); } function e37ca(){ global$_olba_used_stylesheets,$_template; if (!isset ($_olba_used_stylesheets)) return; $_olba_used_stylesheets=array_unique($_olba_used_stylesheets); $dc7f50=array(); foreach($_olba_used_stylesheets as $r45ac4){ if(is_file($r45ac4)) { $dc7f50[] = $r45ac4; continue; } if(is_file($k435ed=USER_FOLDER .'js/'. $r45ac4)) { $dc7f50[] = $k435ed; } $c954eb='styles/'. $r45ac4; $t95aa1=array(); foreach($_template['stack'] as $y620f7){ if(is_file($k435ed=$y620f7.$c954eb)) { $t95aa1[] = $k435ed; } if ( array_key_exists('reset_styles',$_template['infos'][$y620f7]) and in_array($r45ac4,$_template['infos'][$y620f7]['reset_styles']) ) { break; } } $t95aa1=array_reverse($t95aa1); $dc7f50=array_merge($dc7f50,$t95aa1); } foreach($_template['stack'] as $y620f7){ if(E2_EDITION and array_key_exists('global_styles',$_template['infos'][$y620f7])) { $dc7f50[] = $_template['infos'][$y620f7]['global_styles']; } } return $dc7f50; } function p4753(){ global$_olba_used_scripts; if (!isset ($_olba_used_scripts)) return; $_olba_used_scripts=array_unique($_olba_used_scripts); $ed6c58=array(); foreach($_olba_used_scripts as $m3205c){ if(is_file($m3205c)) { $ed6c58[] = $m3205c; continue; } if(is_file($n9d679=USER_FOLDER .'js/'. $m3205c)) { $ed6c58[] = $n9d679; } $c954eb='js/'. $m3205c; if ($n9d679=e2o__usable_file_with_basename_($c954eb)) { $ed6c58[] = $n9d679; } } return $ed6c58; } function uf1da($q2063c,$vf1f71){ if (!isset ($GLOBALS[$vf1f71])) { $GLOBALS[$vf1f71] = array ($q2063c); } else { $GLOBALS[$vf1f71][] = $q2063c; } } function e2o__usable_file_with_basename_($c954eb){ global$_template; foreach($_template['stack'] as $y620f7){ if(is_file($k435ed=$y620f7.$c954eb)) { return $k435ed; } } return ''; } function e2s_search(){ $q1b1cc=@$_POST['query']; $q1b1cc=str_replace(' ','+',$q1b1cc); e2_go_to(t83c8('e2m_found', array ('query' => $q1b1cc))); die; } function e2m_found($parameters=array ()) { global$_strings,$_config; $parameters['query']=trim($parameters['query']); $q1b1cc=$parameters['query']; if (!$q1b1cc){ return array ( 'title' => $_strings['pt--search-query-empty'], 'heading' => $_strings['pt--search'], 'nothing' => $_strings['gs--search-query-empty'], ); } $hf79b1="AND `IsVisible`=1 "; if (oe852())$hf79b1=''; $e11128=false; if (r0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `Keyword`='".i7928($q1b1cc)."'" )) { $ffa816=a0d6b(); if (isset ($ffa816[0]['ID'])) { $e11128=array ( 'href' => t83c8('e2m_tag', array ('*tag' => $ffa816[0])), 'name' => htmlspecialchars($q1b1cc,ENT_NOQUOTES,HSC_ENC), ); } } $p75006=$_strings['gs--nothing-found']; if (i8ca0(true,true) < 4){ $p75006=$_strings['gs--search-too-few-notes']; } elseif(mb_strlen($q1b1cc) < 4){ $p75006=$_strings['gs--search-query-too-short']; } $h3ad42=t83c8('e2m_found_rss', array ('query' => htmlspecialchars($q1b1cc,ENT_NOQUOTES,HSC_ENC))); d3010( $_strings['pt--search-results'] .': '. htmlspecialchars($q1b1cc,ENT_NOQUOTES,HSC_ENC),$h3ad42 ); $x36a38=i7928(preg_quote($q1b1cc)); $eeb31b=( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND MATCH (`Title`, `Text`) AGAINST ('". $x36a38 ."')". $hf79b1 ." ". "LIMIT ". MAX_SEARCH_RESULTS ); $r8d777=array ( 'query' => $eeb31b, 'maximum-notes' => MAX_SEARCH_RESULTS, 'show-all-notes' => true, 'candy' => 'e2m_found', 'parameters' => $parameters, 'title' => '%total% '. $_strings['gs--found-for-query'] .': '. htmlspecialchars($q1b1cc,ENT_NOQUOTES,HSC_ENC), 'superheading' => '%total% '. $_strings['gs--found-for-query'], 'heading' => $q1b1cc, 'related-rss-href' => $h3ad42, 'highlight' => m163d(' ',$q1b1cc), 'nothing' => $p75006, ); if ($e11128){ $r8d777['search-related-tag']=$e11128; } return id864($r8d777); } function e2_check_timeout(){ static $s90272; if(is_null($s90272)) { $qf48ef=ini_get('max_execution_time'); if ($qf48ef){ $s90272=time()+$qf48ef-5; } else { $s90272=0; } } return ($s90272==0)?true:$s90272 >= time(); } function e2_write_dump_header($e8c7dd){ $r099fb=( 'SET SQL_MODE="NO_AUTO_VALUE_ON_ZERO";' .PHP_EOL. 'SET AUTOCOMMIT=0;' .PHP_EOL. 'START TRANSACTION;' .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;" .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;" .PHP_EOL. "/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;" .PHP_EOL. "/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;" .PHP_EOL. "/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;" .PHP_EOL. "/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=NO_AUTO_VALUE_ON_ZERO */;" .PHP_EOL. "/*!40101 SET NAMES utf8 */;" .PHP_EOL. '' ); fwrite($e8c7dd,$r099fb); return true; } function e2_write_dump_footer($e8c7dd){ $v251d1='COMMIT;' .PHP_EOL; $v251d1 .= "/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;" .PHP_EOL ."/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;" .PHP_EOL ."/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;" .PHP_EOL ."/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;".PHP_EOL ."/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;" .PHP_EOL ."/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;" .PHP_EOL; fwrite($e8c7dd,$v251d1); return true; } function e2_get_table_definition($g0c1d0,$vaab9e){ $l5c286=null; $result=mysqli_query($g0c1d0,"SHOW CREATE TABLE `{$vaab9e}`"); if($result){ $u47c80=mysqli_fetch_array($result); $l5c286=$u47c80['Create Table']; } return $l5c286; } function e2_write_table_definition($e8c7dd,$g0c1d0,$vaab9e){ $d30618=e2_get_table_definition($g0c1d0,$vaab9e); if(e2_check_timeout() && $d30618){ fwrite($e8c7dd,$d30618); fwrite($e8c7dd,';'); fwrite($e8c7dd,PHP_EOL.PHP_EOL); return true; } return false; } function e2_get_table_data($g0c1d0,$vaab9e,$a7a86c,$jaa9f7){ $q1b1cc="SELECT * FROM `{$vaab9e}` LIMIT {$a7a86c}, {$jaa9f7}"; $result=mysqli_query($g0c1d0,$q1b1cc); if (!$result){ return false; } $j66e9c=''; $j3c41a="INSERT INTO `{$vaab9e}` VALUES"; while ($gf1965=mysqli_fetch_assoc($result)) { $t691d5=array(); foreach($gf1965 as $q2063c){ $t691d5[] = is_null($q2063c)?"NULL":"'".mysqli_real_escape_string($g0c1d0,$q2063c)."'"; } $j66e9c.=$j3c41a.'('.join(', ',$t691d5).');'.PHP_EOL; } return $j66e9c; } function e2_table_disable_keys($vaab9e){ return "ALTER TABLE `{$vaab9e}` DISABLE KEYS;".PHP_EOL; } function e2_table_enable_keys($vaab9e){ return "ALTER TABLE `{$vaab9e}` ENABLE KEYS;".PHP_EOL; } function e2_get_total_records($g0c1d0,$vaab9e){ $z8ce4b=mysqli_fetch_row(mysqli_query($g0c1d0,"SELECT COUNT(*) FROM `{$vaab9e}`")); return $z8ce4b[0]; } function e2_write_table_data($e8c7dd,$g0c1d0,$vaab9e){ $ofbb44=e2_get_total_records($g0c1d0,$vaab9e); $a7a86c=0; $jaa9f7=1000; $result=true; $e47495=20000; $q80fc1=30; if ($ofbb44){ $nfbda5=e2_table_disable_keys($vaab9e); fwrite($e8c7dd,$nfbda5); } $j66e9c="INSERT INTO `{$vaab9e}` VALUES"; $rde57a=$ofbb44; while ($rde57a > 0){ $q1b1cc="SELECT * FROM `{$vaab9e}` LIMIT {$a7a86c}, {$jaa9f7}"; $result=mysqli_query($g0c1d0,$q1b1cc); $hb428d=mysqli_num_rows($result); if (!$result || !e2_check_timeout()) { $result=false; break; } $adf347=array(); $e4b3a6=0; $fb6539=0; while ($gf1965=mysqli_fetch_assoc($result)) { if (!e2_check_timeout()) { $result=false; break; } $hb428d--; $b54ca8=array(); foreach($gf1965 as $q2063c){ $b54ca8[] = is_null($q2063c)?"NULL":"'".mysqli_real_escape_string($g0c1d0,$q2063c)."'"; } $r8d777='('.join(', ',$b54ca8).')'; $e4b3a6+=strlen($r8d777); $adf347[] = $r8d777; $fb6539++; if ( ($e4b3a6 >= $e47495) || ($fb6539 >= $q80fc1) || ($hb428d==0)) { $q1b1cc=$j66e9c.join(', ',$adf347).';'; fwrite($e8c7dd,$q1b1cc); fwrite($e8c7dd,PHP_EOL); $e4b3a6=0; $fb6539=0; $adf347=array(); } } $a7a86c+=$jaa9f7; $rde57a -= $jaa9f7; } if ($ofbb44){ $e6bfc4=e2_table_enable_keys($vaab9e); fwrite($e8c7dd,$e6bfc4); } return$result; } function e2_backup($g0c1d0,$c9ab2e,$wa9745,$c93da6=array()) { mysqli_query($g0c1d0,"SET NAMES utf8"); $w2beda=tmpfile(); e2_write_dump_header($w2beda); if(__LOG)__log('DB Backup: wrote header'); $j75101=true; foreach($c9ab2e as $vaab9e){ if(__LOG)__log('DB Backup: table '. $vaab9e); $a91e7e=e2_write_table_definition($w2beda,$g0c1d0,$vaab9e); if(__LOG)__log('DB Backup: wrote table definition with result '. (int)$a91e7e); $q35285=e2_write_table_data($w2beda,$g0c1d0,$vaab9e); if(__LOG)__log('DB Backup: wrote table data with result '. (int)$q35285); $j75101=$a91e7e && $q35285; if ($j75101===false){ break; } } if(__LOG)__log('DB Backup: wrote data with running == '. (int)$j75101); if ($j75101){ e2_write_dump_footer($w2beda); fseek($w2beda,0); $e8c7dd=fopen($wa9745,'w+'); while ($j75101 && ($r8d777=fread($w2beda,1024))) { if(e2_check_timeout()) { fwrite($e8c7dd,$r8d777); } else { $j75101=false; } } fclose($e8c7dd); } fclose($w2beda); return $j75101; } function z3e5c($m0c426,$content){ $f52766=MTMPL_FOLDER.$m0c426 .'.mtmpl.php'; if(is_file($f52766)) { ob_start(); include $f52766; $sde7a3=ob_get_contents(); ob_end_clean(); return trim($sde7a3); } } function vaed2(){ global$_config; $d9e35a=$_config['mail_from']; if ($d9e35a[strlen($d9e35a)-1]=='@'){ $d9e35a.=$_SERVER['HTTP_HOST']; } return $d9e35a; } function ba41b($p01b6e,$subject,$r78e73,$u145a2=''){ global $d57de2; if ($d57de2==DEV_HOST){ $s8fa14=tempnam('mail-debug',''); $l1cb25=( 'To:       '.$p01b6e."\n". 'Subject:  '.$subject."\n". "--------------------------------------------------\n". $r78e73 ); t6e52($s8fa14,$l1cb25); chmod($s8fa14,NEW_FILES_RIGHTS); rename($s8fa14,$s8fa14.'.txt'); } else { $subject='=?UTF-8?B?'. base64_encode($subject) .'?='; $u145a2.="\r\nContent-Type: text/plain; charset=utf-8"; mail($p01b6e,$subject,$r78e73,trim($u145a2)); } } function _A($l1cb25){ global$_candy,$d57de2,$ca57c1,$v097cc; if ( preg_match('/\<a href\=\"(.*?)\"[^>]*\>(.*?)\<\/a\>/si',$l1cb25,$r9c28d) and ( $r9c28d[1]=='' or $r9c28d[1]==$v097cc or 'http://'. $d57de2.$r9c28d[1]==$v097cc or 'http://'. $d57de2.$ca57c1 .'/'. $r9c28d[1]==$v097cc or $_candy=='e2m_install' ) ) { return $r9c28d[2]; } else { return $l1cb25; } } function _AT($ae8fab){ global$_candy,$d57de2,$ca57c1,$v097cc; return ( $ae8fab=='' or $ae8fab==$v097cc or 'http://'. $d57de2.$ae8fab==$v097cc or 'http://'. $d57de2.$ca57c1 .'/'. $ae8fab==$v097cc ); } function _IMGSRC($k435ed){ return i1492($k435ed); } function _SVG($k435ed){ return sf42c($k435ed); } function _COLOR($bf97c5,$vb8a9f,$ncc321,$r4efa2=1){ if(strlen($bf97c5)!=3 and strlen($bf97c5)!=6) return 'f0f'; if(strlen($vb8a9f)!=3 and strlen($vb8a9f)!=6) return 'f0f'; if(strlen($bf97c5)==3)$bf97c5=$bf97c5{0}.$bf97c5{0}.$bf97c5{1}.$bf97c5{1}.$bf97c5{2}.$bf97c5{2}; if(strlen($vb8a9f)==3)$vb8a9f=$vb8a9f{0}.$vb8a9f{0}.$vb8a9f{1}.$vb8a9f{1}.$vb8a9f{2}.$vb8a9f{2}; $af09cc=array ( $bf97c5{0}.$bf97c5{1}, $bf97c5{2}.$bf97c5{3}, $bf97c5{4}.$bf97c5{5}, $vb8a9f{0}.$vb8a9f{1}, $vb8a9f{2}.$vb8a9f{3}, $vb8a9f{4}.$vb8a9f{5}, ); foreach ($af09cc as $z8ce4b => $s9e366){ $af09cc[$z8ce4b]=hexdec($s9e366); } $n22af6=array ( $af09cc[0]+pow($ncc321,$r4efa2) * ($af09cc[3]-$af09cc[0]), $af09cc[1]+pow($ncc321,$r4efa2) * ($af09cc[4]-$af09cc[1]), $af09cc[2]+pow($ncc321,$r4efa2) * ($af09cc[5]-$af09cc[2]), ); $j70dda=''; foreach ($n22af6 as $z8ce4b => $s9e366){ $j70dda.=str_pad(dechex($s9e366),2,'0',STR_PAD_LEFT); } return $j70dda; } function _DT($p1ddcb,$yb35c6){ if (!$yb35c6) return ''; list ($h96b8c,$pb2c6c)=$yb35c6; $v2cb9d=$p1ddcb; $n7436f=r5a2f('m',$h96b8c,$pb2c6c); $v2cb9d=str_replace('{zone}',e2__escape_all(i9515($pb2c6c['offset'])), $v2cb9d); $v2cb9d=str_replace('{month}',e2__escape_all(e2l_get_string('um--month', array ('month' => $n7436f))), $v2cb9d); $v2cb9d=str_replace('{month-short}',e2__escape_all(e2l_get_string('um--month-short', array ('month' => $n7436f))), $v2cb9d); $v2cb9d=str_replace('{month-g}',e2__escape_all(e2l_get_string('um--month-g', array ('month' => $n7436f))), $v2cb9d); $v2cb9d=r5a2f($v2cb9d,$h96b8c,$pb2c6c); return $v2cb9d; } function _AGO($yb35c6){ return n7a0b($yb35c6[0], array ('offset' => $yb35c6[1]['offset'],'is_dst' => $yb35c6[1]['is_dst']) ); } function _NUM($l1cb25){ return e2_decline_for_number($l1cb25); } function _SIZE($size,$y3e34b=_SIZE_AUTO){ return e2_format_size($size,$y3e34b); } function _FIRST($d437b9){ return ($d437b9['_']['_ord']==0); } function _LAST($d437b9){ return ($d437b9['_']['_ord']==$d437b9['_']['_ord_max']); } function _CSS($cc7a62){ return kd4c1($cc7a62); } function _CSS_HREF($cc7a62){ return j576f($cc7a62); } function _JS($h32981){ return jd00a($h32981); } function _LIB($ne8acc){ return p16f0($ne8acc); } function _T($h52678){ return g166b($h52678); } function _X($h52678){ return d6a97($h52678); } function _T_FOR($h52678,$zd5566=null){ global$content; if ($zd5566===null)$zd5566=$h52678; if(array_key_exists($zd5566,$content)) { g166b($h52678); } else { return ''; } } function _GUIDES($meca07=false){ global$_olba_guides; if(is_array($meca07))$_olba_guides=$meca07; if (!is_array($_olba_guides)) return; $h88408='<div style="position: fixed; width: 100%; height: 100%; z-index: -100">'; $x1d623=0; $a07d43=$_olba_guides; $a07d43[] = 100; foreach ($a07d43 as $c865c0 => $nd89e2){ if ($nd89e2==100) break; $x1d623+=$nd89e2; $h88408.='<div style="position: fixed; left: '. $nd89e2 .'%; width: 0; height: 100%; border-left: 1px #000 dotted; opacity: .2; -webkit-opacity: .2; -moz-opacity: .2"></div>'; $ya1b01='position: absolute; padding: 2px 3px; top: 0; font-size: 9px; background: #ccc; color: #000; font-family: "Verdana", sans-serif; opacity: .8; -webkit-opacity: .8; -moz-opacity: .8'; if ($a07d43[$c865c0+1]-$a07d43[$c865c0] < 4){ $h88408.='<div style="'. $ya1b01.'; right: '. (100-$nd89e2) .'%; border-bottom-left-radius: .5em; -webkit-border-bottom-left-radius: .5em; -moz-border-bottom-left-radius: .5em;">'. $nd89e2 .'%</div>'; } else { $h88408.='<div style="'. $ya1b01.'; left: '. $nd89e2 .'%; border-bottom-right-radius: .5em; -webkit-border-bottom-right-radius: .5em; -moz-border-bottom-right-radius: .5em;">'. $nd89e2 .'%</div>'; } } $h88408.='</div>'; $_olba_current_col=0; return $h88408; } function _S($xb45cf){ global$_strings; return$_strings[$xb45cf]; } function _SHORTCUT($ub0689){ return cbb8d($ub0689); } function e2__escape_all($xb45cf){ $v2cb9d=''; for ($c865c0=0; $c865c0 <= mb_strlen($xb45cf); ++ $c865c0){ $v2cb9d.='\\'. mb_substr($xb45cf,$c865c0,1); } return $v2cb9d; } function e2l_get_string($ffa206,$r8d777){ global$_strings; $ub0689=$_strings[$ffa206]; if(preg_match_all('/\$\[(.+?)\]/u',$ub0689,$r9c28d,PREG_SET_ORDER)) { foreach ($r9c28d as $te3cc9){ $qb2145=$te3cc9[1]; $sf2ffc=''; if(strstr($qb2145,'.')) list ($qb2145,$sf2ffc)=explode('.',$qb2145,2); if(array_key_exists($qb2145,$r8d777)) { if ($sf2ffc){ $ub0689=str_replace($te3cc9[0],e2l__format_value($sf2ffc,$r8d777[$qb2145],$ffa206),$ub0689); } else { $ub0689=str_replace($te3cc9[0],$r8d777[$qb2145],$ub0689); } } } } return $ub0689; } function e2l_transliterate($xb45cf){ $te358e=array(); if(is_file(DEFAULTS_FOLDER.'translit.txt')) { $te358e=file(DEFAULTS_FOLDER.'translit.txt'); } $dd98a0=$p01b6e=''; foreach ($te358e as $c865c0 => $g6438c){ if (!($c865c0%2))$dd98a0.=rtrim($g6438c) .' '; else $p01b6e.=rtrim($g6438c) .' '; if ($c865c0%2){ while (mb_strlen($p01b6e) < mb_strlen($dd98a0))$p01b6e.=' '; while (mb_strlen($p01b6e) > mb_strlen($dd98a0))$dd98a0.=' '; } } $a60ae1=''; $cde2e7=-1; for ($c865c0=0; $c865c0 < mb_strlen($dd98a0); ++ $c865c0){ $h4a8a0=mb_substr($dd98a0,$c865c0,1); if ($h4a8a0!=' '){ $a60ae1.=$h4a8a0; if ($cde2e7 == -1)$cde2e7=$c865c0; } elseif ($a60ae1){ $l52ac1=trim(mb_substr($p01b6e,$cde2e7,mb_strpos($p01b6e,' ',$cde2e7+1)-$cde2e7)); $f33c9b=array ($a60ae1,$l52ac1); $zce83f[mb_strlen($a60ae1)][] = $f33c9b; $a60ae1=''; $cde2e7=-1; } } $h1d78d=array(); for ($c865c0=count($zce83f); $c865c0 > 0; -- $c865c0){ foreach ($zce83f[$c865c0] as $f33c9b)$h1d78d[$f33c9b[0]] = $f33c9b[1]; } return strtr($xb45cf,$h1d78d); } function e2l__format_value($sf2ffc,$q2063c,$ffa206){ list ($sf2ffc,$o3ad73)=explode('.',$sf2ffc,2); $ze6875='e2lstr_'. $sf2ffc; if(function_exists($ze6875)) { return call_user_func($ze6875,$q2063c,$o3ad73,$ffa206); } else { return $q2063c; } return $q2063c; } if($_config['write_log_reset'])__log(null); if(__LOG)__log('System: loaded'); if(is_file($y2d354=LANGUAGES_FOLDER.$settings['language'] .'.php')) { $_lang=$settings['language']; include $y2d354; } elseif(is_file($y2d354=LANGUAGES_FOLDER.DEFAULT_LANGUAGE .'.php')) { $_lang=DEFAULT_LANGUAGE; include $y2d354; } else { die ('Language file missing: '. $y2d354); } $_strings=e2l_load_strings(); if(!$m589b3) @include 'builder.php'; function e2(){ global $d57de2,$settings,$errors,$content, $ca57c1,$full_blog_url,$stopwatch,$b11755,$v097cc, $_newsfeeds, $_instance, $_candy, $_config, $_route, $_strings, $_lang, $_candies_installer, $_candies_public, $_candies_spawning, $_candies_unabortable, $_candies_indexable, $_candies_indexable_conditionally, $_candies_ajax, $_user_folder_name, $_olba_includes, $_diagnose; c269a(); if(__LOG)__log('System: go'); $errors=array(); header('Content-type: text/html; charset='. OUTPUT_CHARSET); $_instance=false; if (@is_file(USER_FOLDER.'instance.psa')) { $b0d149=@scdf0(USER_FOLDER.'instance.psa') or $b0d149=false; if ($b0d149){ $b0d149=@unserialize($b0d149) or $b0d149=false; if ($b0d149){ $_instance=$b0d149; } } } $k66f61=@$settings['template'] or $k66f61=DEFAULT_TEMPLATE; u4e27($k66f61); df5a9(); if(__LOG)__log('System: Resolve <'. $_GET['go'] .'> {'); q7059(); list ($uc48ba,$parameters)=cb7e9($_GET['go']); if(__LOG)__log('} // Resolve'); if(__LOG)__log( 'System: Candy <'. $uc48ba .'> {' ); $_candy=$uc48ba; if ( @$_config['debug_slow_ajax'] and ( in_array($uc48ba,$_candies_ajax) ) ) { sleep(1+2 * (rand()/getrandmax())); } if (!in_array($uc48ba,$_candies_installer)) { e2_make_sure_that_installed(); } if(in_array($uc48ba,$_candies_unabortable)) { ignore_user_abort(1); } $f58387=(bool)oe852(); $c0b448=!in_array($uc48ba,$_candies_public); $t49ecc=$c0b448 && !$f58387; if(__LOG)__log('System: signed in? '. (int)$f58387); $zc1f6f=array ( 'done?' => $f58387, 'required?' => $c0b448, 'necessary?' => $t49ecc, ); $_newsfeeds=false; d3010( htmlspecialchars(w6f51(),ENT_NOQUOTES,HSC_ENC), t83c8('e2m_frontpage_rss') ); $content['notes'] = array (); $content['drafts'] = array (); $content['comments'] = array (); $content['notes-list'] = array (); $content['tags'] = array (); if(is_callable($uc48ba)) { if ($t49ecc){ if(substr($uc48ba,0,4)=='e2s_'){ $content=call_user_func('e2s_sign_in_necessary'); } else { $content['title']=$_strings['pt--sign-in']; } } else { if(__LOG)__log('System: candy call'); $content=call_user_func($uc48ba,$parameters); if(__LOG)__log('System: candy return'); } } else { $zc1f6f['required?']=false; $zc1f6f['necessary?']=false; $content=e2_error404_mode(); } if(__LOG)__log('} // Candy'); $content['class']=str_replace('_','-',str_replace('e2m_','',$uc48ba)); $content['sign-in']=$zc1f6f; $content['sign-in-prompt']=ge68c($uc48ba); if(e2_is_installed()) { if(__LOG)__log('System: nav and pages'); $content['navigation-links'] = array (array ( 'rel' => 'index', 'href' => t83c8('e2m_frontpage'), 'id' => 'link-index', )); if(array_key_exists('pages',$content)) { foreach (array ('prev','next','earlier','later') as $dc47d1){ if(array_key_exists($dc47d1 .'-href',$content['pages'])) { $u7ffc4=$dc47d1; if ($dc47d1=='earlier')$u7ffc4='prev'; if ($dc47d1=='later')$u7ffc4='next'; $content['navigation-links'][] = array ( 'rel' => $u7ffc4, 'href' => $content['pages'][$dc47d1 .'-href'], 'id' => 'link-'. $dc47d1, ); } } } if(__LOG)__log('System: search form'); if(array_key_exists('query',$parameters)) { $q1b1cc=trim($parameters['query']); } else { $q1b1cc=''; } $content['search'] = array ( 'form-action' => t83c8('e2s_search'), 'query' => htmlspecialchars(@$q1b1cc,ENT_COMPAT,HSC_ENC), ); if(__LOG)__log('System: blog information'); $content['blog']['author']=htmlspecialchars(x2640(),ENT_NOQUOTES,HSC_ENC); if(array_key_exists('description',$settings)) { $k2bfe4=ob7f1($settings['description'],'full'); $s67daf=$k2bfe4['text-final']; $content['blog']['description']=$s67daf; $content['blog']['description-format-info']=$k2bfe4['meta']; } $content['blog']['title']=htmlspecialchars(w6f51(),ENT_NOQUOTES,HSC_ENC); $content['blog']['userpic-href']=DEFAULT_USERPIC_FILENAME; $content['blog']['userpic-set']=false; if (oe852()) { $content['blog']['userpic-href']=DEFAULT_USERPIC_PLACEHOLDER_FILENAME; $content['blog']['userpic-upload-action']=t83c8('e2j_userpic_upload'); } if(is_file(USER_FOLDER .'userpic@2x.png')) { $content['blog']['userpic-href']=USER_FOLDER .'userpic@2x.png'; $content['blog']['userpic-set']=true; } elseif(is_file(USER_FOLDER .'userpic@2x.jpg')) { $content['blog']['userpic-href']=USER_FOLDER .'userpic@2x.jpg'; $content['blog']['userpic-set']=true; } $content['blog']['href']=t83c8('e2m_frontpage'); $content['blog']['rss-href']=t83c8('e2m_frontpage_rss'); $content['blog']['language']=$_lang; if(__LOG)__log('System: edge timeinfo'); $k97bc5=array (time(),i5c05()); $o5f36b=ia846('Y',$k97bc5[0]); $content['blog']['now']=$k97bc5; $maa103=$o5f36b; $v33b09=tcc02('start'); if(array_key_exists('stamp',$v33b09)) { $maa103=ia846('Y',$v33b09['stamp']); $content['blog']['start-time'] = array ((int)$v33b09['stamp'],$v33b09['timezone']); } $c40d73=(int)i8ca0(true,true); if (oe852()) { if(__LOG)__log('System: stuff for logged in user'); $content['blog']['drafts-count'] = (int)i8ca0(false,true); $content['admin-hrefs'] = array ( 'new-note' => t83c8('e2m_write'), 'drafts' => t83c8('e2m_drafts'), 'settings' => t83c8('e2m_settings'), 'password' => t83c8('e2m_password'), 'database' => t83c8('e2m_database'), 'timezone' => t83c8('e2m_timezone'), 'logout' => t83c8('e2m_sign_out'), ); if($settings['comments']['on']) { list ($dfe9e2,$w85ee4,$t20699)=u2a6b(); if ($dfe9e2)$content['new-comments'] = array ( 'count' => $dfe9e2, 'href' => $t20699, ); } } else { if(__LOG)__log('System: login form'); $content['form-login']['form-action']=t83c8('e2s_sign_in'); $content['form-login']['form-check-password-action']=t83c8('e2j_check_password'); $content['form-login']['login-name'] = @$settings['author']; $content['form-login']['public-pc?']=false; if(array_key_exists('_login_request_message',$content)) { $content['form-login']['request']=$content['_login_request_message']; } } if (oe852()) { $ad0a87=(($c40d73 + (int)i8ca0(true,false)) == 0); } else { $ad0a87=($c40d73==0); } if($_db_error){ $ad0a87=false; } $z9fbfe=$_config['years_range_separator']? $_config['years_range_separator']:'&mdash;'; $content['blog']['years-range']=$maa103 . (($maa103==$o5f36b)? '':($z9fbfe.$o5f36b)); $content['blog']['notes-count']=$c40d73; $content['blog']['virgin?']=$ad0a87; if ($ca57c1){ $content['blog']['parent-site-href']=substr($ca57c1, (int)strpos('/',$ca57c1)); } $content['hrefs'] = array ( 'sign-in' => t83c8('e2m_sign_in'), 'tags' => t83c8('e2m_tags'), 'everything' => t83c8('e2m_everything'), ); } $f1e2ad='noindex, follow'; if (@$_config['index_follow_everything']) { $f1e2ad='index, follow'; } if(in_array($uc48ba,$_candies_indexable)) { $content['robots']='index, follow'; } if(in_array($uc48ba,$_candies_indexable_conditionally)) { $content['robots']=$f1e2ad; } $content['output-charset']=OUTPUT_CHARSET; $content['base-href']=$full_blog_url. '/'; $content['current-href']=$v097cc; if (!array_key_exists('summary',$content)) { $content['summary']=strip_tags($content['blog']['description']); } $content['title']=strip_tags(g6f10(htmlspecialchars($content['title'],ENT_NOQUOTES,HSC_ENC))); if (@$content['heading']) { $content['heading']=strip_tags(g6f10(htmlspecialchars($content['heading'],ENT_NOQUOTES,HSC_ENC))); } if(__LOG)__log('System: e2_modes {'); e2_modes($parameters); if(__LOG)__log('} // e2_modes'); if (@$_config['request_logging']) { $s8fa14=fopen(USER_FOLDER. 'log-'. date('Y-m-d') .'.txt','a'); fwrite($s8fa14,date('d.m.Y H:i:s') ."\tT = ". $content['pgt'] ."\tQ = ". $content['total_queries'] ."\tIP = ". $_SERVER['REMOTE_ADDR'] ."\tRequest = ". $_SERVER['REQUEST_URI'] ."\r\n"); fclose($s8fa14); } $content['misc']['sape-link']='http://www.sape.ru/r.206a4276c2.php'; $vc8542=round(g7f78()-$stopwatch,3); $content['engine']['pgt']=str_replace('.',',',$vc8542); if(function_exists('memory_get_peak_usage')) { $content['engine']['mp']=str_replace('.',',',round((memory_get_peak_usage()/1024/1024)*100)/100); } $content['engine']['qc'] = (int) @$b11755; $content['engine']['built?']=$m589b3; $content['engine']['installed?']=e2_is_installed(); $content['engine']['version']='v'. E2_VERSION; $i68966='('. $_strings['e2--release'] .' '. E2_RELEASE .', v'. E2_VERSION .')'; $content['engine']['version-description']=$_strings['e2--vname-aegea'] .' '. $i68966; $content['engine']['user-folder-name']=$_user_folder_name; $content['engine']['href']=E2_WEBSITE; $content['engine']['about']='<span title="E2 '.$i68966 .'">'. $_strings['e2--powered-by'] .' <a href="'. E2_WEBSITE .'">'. $_strings['e2--vname-aegea'] .'</a></span>'; $content['stylesheets']=e37ca(); $content['scripts']=p4753(); if (!@isset ($_diagnose['ok?'])) { if($_COOKIE['diagnose'] or @$_diagnose['need?']) { e8739(); } } if ($le1671=dec07()) { $content['message']=$le1671; } $content['og-images'] = array (); if(is_array($content['notes']['only']['format-info']['resources-detected'])) { foreach($content['notes']['only']['format-info']['resources-detected'] as $g2a304){ if (i30f2($g2a304)) { $content['og-images'][] = $full_blog_url .'/'. PICTURES_FOLDER.$g2a304; } } } $content['og-images'][] = $full_blog_url .'/'. $content['blog']['userpic-href']; if(E2_EDITION){ $content['pre-body-end']=$settings['embed']['yandex-metrika']; } ob_start(); cbc21(); $m78e62=ob_get_contents(); ob_end_clean(); if(is_array($content['notes'])) { foreach($content['notes'] as $saad65){ if(is_array($saad65['format-info']['links-required'])) { foreach ($saad65['format-info']['links-required'] as $g2a304){ if(substr($g2a304, -3)=='.js'){ jd00a(substr($g2a304,0, -3)); } if(substr($g2a304, -4)=='.css'){ kd4c1(substr($g2a304,0, -4)); } } } } } $content['stylesheets']=e37ca(); $content['scripts']=p4753(); if($_newsfeeds)$content['newsfeeds']=$_newsfeeds; ob_start(); g166b('head'); $c61ef8=ob_get_contents(); ob_end_clean(); ob_start(); g166b('scripts'); $gee59b=ob_get_contents(); ob_end_clean(); $m78e62=str_replace('<e2:head-data />',$c61ef8,$m78e62); $m78e62=str_replace('<e2:scripts-data />',$gee59b,$m78e62); if ( $ma0856=ue655() and !$_config['ignore_missing_template_files'] ) { echo '<h1>Templates missing</h1>'; echo '<ul>'; foreach ($ma0856 as $b380ec){ echo '<li>'. $b380ec.' </li>'; } echo '</ul>'; echo '<pre>'; print_r($content); echo '</pre>'; } else { echo $m78e62; } if(__LOG)__log('System: end'); if(DEV_TRACK_TIME and $d57de2==DEV_HOST){ $m06bc4=str_replace('.',',',round(g7f78()-$stopwatch,3)-$vc8542); echo '<div style="font-size: 300%; text-align: center; position: fixed; bottom: 0; width: 100%; background: #ffc; opacity: .88">'. '<span style="color: #f80">'. $content['engine']['pgt'] .' '. '<small>'. $content['engine']['qc'] .'q</small></span>'. '<span style="color: #08f"> + '. $m06bc4.' '. '<small>'. $_olba_includes .'i</small></span>'. '</div>'; } } if(__LOG)__log(''); ?>